var xe=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports);var Ke=xe((Z,we)=>{(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(n){if(n.ep)return;n.ep=!0;const o=i(n);fetch(n.href,o)}})();/**

 * @version 2.2.6-SNAPSHOT

 * @overview QZ Tray Connector

 * @license LGPL-2.1-only

 * <p/>

 * Connects a web client to the QZ Tray software.

 * Enables printing and device communication from javascript.

 */var M=function(){Array.isArray||(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"}),Number.isInteger||(Number.isInteger=function(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e});var t={VERSION:"2.2.6-SNAPSHOT",DEBUG:!1,log:{trace:function(){t.DEBUG&&console.log.apply(console,arguments)},info:function(){console.info.apply(console,arguments)},warn:function(){console.warn.apply(console,arguments)},allay:function(){t.DEBUG&&console.warn.apply(console,arguments)},error:function(){console.error.apply(console,arguments)}},streams:{serial:"SERIAL",usb:"USB",hid:"HID",printer:"PRINTER",file:"FILE",socket:"SOCKET"},websocket:{connection:null,shutdown:!1,connectConfig:{host:["localhost","localhost.qz.io"],hostIndex:0,usingSecure:!0,protocol:{secure:"wss://",insecure:"ws://"},port:{secure:[8181,8282,8383,8484],insecure:[8182,8283,8384,8485],portIndex:0},keepAlive:60,retries:0,delay:0},setup:{findConnection:function(e,n,o){if(t.websocket.shutdown){o(new Error("Connection attempt cancelled by user"));return}if(e.port.secure.length)!e.port.insecure.length&&!e.usingSecure&&(t.log.trace("No insecure ports specified - forcing secure connection"),e.usingSecure=!0);else if(e.port.insecure.length)e.usingSecure&&(t.log.error("No secure ports specified - forcing insecure connection"),e.usingSecure=!1);else{o(new Error("No ports have been specified to connect over"));return}var r=function(){if(t.websocket.shutdown){o(new Error("Connection attempt cancelled by user"));return}if(e.port.portIndex++,e.usingSecure&&e.port.portIndex>=e.port.secure.length||!e.usingSecure&&e.port.portIndex>=e.port.insecure.length)if(e.hostIndex>=e.host.length-1){o(new Error("Unable to establish connection with QZ"));return}else e.hostIndex++,e.port.portIndex=0;t.websocket.setup.findConnection(e,n,o)},s;e.usingSecure?s=e.protocol.secure+e.host[e.hostIndex]+":"+e.port.secure[e.port.portIndex]:s=e.protocol.insecure+e.host[e.hostIndex]+":"+e.port.insecure[e.port.portIndex];try{t.log.trace("Attempting connection",s),t.websocket.connection=new t.tools.ws(s)}catch(c){t.log.error(c),r();return}t.websocket.connection!=null?(t.websocket.connection.established=!1,t.websocket.connection.onopen=function(c){if(!t.websocket.connection.established&&(t.log.trace(c),t.log.info("Established connection with QZ Tray on "+s),t.websocket.setup.openConnection({resolve:n,reject:o}),e.keepAlive>0)){var l=setInterval(function(){if(!t.tools.isActive()||t.websocket.connection.interval!==l){clearInterval(l);return}t.websocket.connection.send("ping")},e.keepAlive*1e3);t.websocket.connection.interval=l}},t.websocket.connection.onclose=function(){t.websocket.connection&&typeof navigator<"u"&&navigator.userAgent.indexOf("Safari")!=-1&&navigator.userAgent.indexOf("Chrome")==-1&&t.websocket.connection.onerror()},t.websocket.connection.onerror=function(c){t.log.trace(c),t.websocket.connection=null,r()}):o(new Error("Unable to create a websocket connection"))},openConnection:function(e){t.websocket.connection.established=!0,t.websocket.connection.onclose=function(o){t.log.trace(o),t.websocket.connection=null,t.websocket.callClose(o),t.log.info("Closed connection with QZ Tray");for(var r in t.websocket.pendingCalls)t.websocket.pendingCalls.hasOwnProperty(r)&&t.websocket.pendingCalls[r].reject(new Error("Connection closed before response received"));this.promise!=null&&this.promise.resolve()},t.websocket.connection.onerror=function(o){t.websocket.callError(o)},t.websocket.connection.sendData=function(o){t.log.trace("Preparing object for websocket",o),o.timestamp==null&&(o.timestamp=Date.now(),typeof o.timestamp!="number"&&(o.timestamp=new Date().getTime())),o.promise!=null&&(o.uid=t.websocket.setup.newUID(),t.websocket.pendingCalls[o.uid]=o.promise),o.position={x:typeof screen<"u"?(screen.availWidth||screen.width)/2+(screen.left||screen.availLeft||0):0,y:typeof screen<"u"?(screen.availHeight||screen.height)/2+(screen.top||screen.availTop||0):0};try{if(o.call!=null&&o.signature==null&&t.security.needsSigned(o.call)){var r={call:o.call,params:o.params,timestamp:o.timestamp},s=t.tools.hash(t.tools.stringify(r));s.then||(s=t.tools.promise(function(c){c(s)})),s.then(function(c){return t.security.callSign(c)}).then(function(c){t.log.trace("Signature for call",c),o.signature=c||"",o.signAlgorithm=t.security.signAlgorithm,t.signContent=void 0,t.websocket.connection.send(t.tools.stringify(o))}).catch(function(c){t.log.error("Signing failed",c),o.promise!=null&&(o.promise.reject(new Error("Failed to sign request")),delete t.websocket.pendingCalls[o.uid])})}else t.log.trace("Signature for call",o.signature),t.websocket.connection.send(t.tools.stringify(o))}catch(c){t.log.error(c),o.promise!=null&&(o.promise.reject(c),delete t.websocket.pendingCalls[o.uid])}},t.websocket.connection.onmessage=function(o){var r=JSON.parse(o.data);if(r.uid==null){if(r.type==null)t.websocket.connection.close(4003,"Connected to incompatible QZ Tray version");else switch(r.type){case t.streams.serial:r.event||(r.event=JSON.stringify({portName:r.key,output:r.data})),t.serial.callSerial(JSON.parse(r.event));break;case t.streams.socket:t.socket.callSocket(JSON.parse(r.event));break;case t.streams.usb:r.event||(r.event=JSON.stringify({vendorId:r.key[0],productId:r.key[1],output:r.data})),t.usb.callUsb(JSON.parse(r.event));break;case t.streams.hid:t.hid.callHid(JSON.parse(r.event));break;case t.streams.printer:t.printers.callPrinter(JSON.parse(r.event));break;case t.streams.file:t.file.callFile(JSON.parse(r.event));break;default:t.log.allay("Cannot determine stream type for callback",r);break}return}t.log.trace("Received response from websocket",r);var s=t.websocket.pendingCalls[r.uid];s==null?t.log.allay("No promise found for returned response"):r.error!=null?s.reject(new Error(r.error)):s.resolve(r.result),delete t.websocket.pendingCalls[r.uid]};function n(o){o===void 0&&(o=null),i.api.getVersion().then(function(r){t.websocket.connection.version=r,t.websocket.connection.semver=r.toLowerCase().replace(/-rc\./g,"-rc").split(/[\\+\\.-]/g);for(var s=0;s<t.websocket.connection.semver.length;s++){try{if(s==3&&t.websocket.connection.semver[s].toLowerCase().indexOf("rc")==0){t.websocket.connection.semver[s]=-t.websocket.connection.semver[s].replace(/\D/g,"");continue}t.websocket.connection.semver[s]=parseInt(t.websocket.connection.semver[s])}catch{}t.websocket.connection.semver.length<4&&(t.websocket.connection.semver[3]=0)}t.compatible.algorithm(!0)}).then(function(){t.websocket.connection.sendData({certificate:o,promise:e})})}t.security.callCert().then(n).catch(function(o){t.log.warn("Failed to get certificate:",o),t.security.rejectOnCertFailure?e.reject(o):n(null)})},newUID:function(){var e=6;return(new Array(e+1).join("0")+(Math.random()*Math.pow(36,e)<<0).toString(36)).slice(-e)}},dataPromise:function(e,n,o,r){return t.tools.promise(function(s,c){var l={call:e,promise:{resolve:s,reject:c},params:n,signature:o,timestamp:r};t.websocket.connection.sendData(l)})},pendingCalls:{},errorCallbacks:[],callError:function(e){if(Array.isArray(t.websocket.errorCallbacks))for(var n=0;n<t.websocket.errorCallbacks.length;n++)t.websocket.errorCallbacks[n](e);else t.websocket.errorCallbacks(e)},closedCallbacks:[],callClose:function(e){if(Array.isArray(t.websocket.closedCallbacks))for(var n=0;n<t.websocket.closedCallbacks.length;n++)t.websocket.closedCallbacks[n](e);else t.websocket.closedCallbacks(e)}},printing:{defaultConfig:{bounds:null,colorType:"color",copies:1,density:0,duplex:!1,fallbackDensity:null,interpolation:"bicubic",jobName:null,legacy:!1,margins:0,orientation:null,paperThickness:null,printerTray:null,rasterize:!1,rotation:0,scaleContent:!0,size:null,units:"in",forceRaw:!1,encoding:null,spool:null}},serial:{serialCallbacks:[],callSerial:function(e){if(Array.isArray(t.serial.serialCallbacks))for(var n=0;n<t.serial.serialCallbacks.length;n++)t.serial.serialCallbacks[n](e);else t.serial.serialCallbacks(e)}},socket:{socketCallbacks:[],callSocket:function(e){if(Array.isArray(t.socket.socketCallbacks))for(var n=0;n<t.socket.socketCallbacks.length;n++)t.socket.socketCallbacks[n](e);else t.socket.socketCallbacks(e)}},usb:{usbCallbacks:[],callUsb:function(e){if(Array.isArray(t.usb.usbCallbacks))for(var n=0;n<t.usb.usbCallbacks.length;n++)t.usb.usbCallbacks[n](e);else t.usb.usbCallbacks(e)}},hid:{hidCallbacks:[],callHid:function(e){if(Array.isArray(t.hid.hidCallbacks))for(var n=0;n<t.hid.hidCallbacks.length;n++)t.hid.hidCallbacks[n](e);else t.hid.hidCallbacks(e)}},printers:{printerCallbacks:[],callPrinter:function(e){if(Array.isArray(t.printers.printerCallbacks))for(var n=0;n<t.printers.printerCallbacks.length;n++)t.printers.printerCallbacks[n](e);else t.printers.printerCallbacks(e)}},file:{fileCallbacks:[],callFile:function(e){if(Array.isArray(t.file.fileCallbacks))for(var n=0;n<t.file.fileCallbacks.length;n++)t.file.fileCallbacks[n](e);else t.file.fileCallbacks(e)}},security:{certHandler:function(e,n){n()},callCert:function(){return typeof t.security.certHandler.then=="function"?t.security.certHandler:t.security.certHandler.constructor.name==="AsyncFunction"?t.security.certHandler():t.tools.promise(t.security.certHandler)},signatureFactory:function(){return function(e){e()}},callSign:function(e){return t.security.signatureFactory.constructor.name==="AsyncFunction"?t.security.signatureFactory(e):t.tools.promise(t.security.signatureFactory(e))},signAlgorithm:"SHA1",rejectOnCertFailure:!1,needsSigned:function(e){const n=["printers.getStatus","printers.stopListening","usb.isClaimed","usb.closeStream","usb.releaseDevice","hid.stopListening","hid.isClaimed","hid.closeStream","hid.releaseDevice","file.stopListening","getVersion"];return e!=null&&n.indexOf(e)===-1}},tools:{promise:function(e){if(typeof RSVP<"u")return new RSVP.Promise(e);if(typeof Promise<"u")return new Promise(e);t.log.error("Promise/A+ support is required.  See qz.api.setPromiseType(...)")},reject:function(e){return t.tools.promise(function(n,o){o(e)})},stringify:function(e){var n=Array.prototype.toJSON;delete Array.prototype.toJSON;function o(s,c){if(s!=="promise")return c}var r=JSON.stringify(e,o);return n&&(Array.prototype.toJSON=n),r},hash:function(e){return typeof Sha256<"u"?Sha256.hash(e):t.SHA.hash(e)},ws:typeof WebSocket<"u"?WebSocket:null,absolute:function(e){if(typeof window<"u"&&typeof document.createElement=="function"){var n=document.createElement("a");return n.href=e,n.href}else typeof Z=="object"&&require("path").resolve(e);return e},relative:function(e){for(var n=0;n<e.length;n++)if(e[n].constructor===Object){var o=!1;e[n].data&&e[n].data.search&&e[n].data.search(/data:image\/\w+;base64,/)===0?(e[n].flavor="base64",e[n].data=e[n].data.replace(/^data:image\/\w+;base64,/,"")):e[n].flavor?["FILE","XML"].indexOf(e[n].flavor.toUpperCase())>-1&&(o=!0):(e[n].format&&["HTML","IMAGE","PDF","FILE","XML"].indexOf(e[n].format.toUpperCase())>-1||e[n].type&&(["PIXEL","IMAGE","PDF"].indexOf(e[n].type.toUpperCase())>-1&&!e[n].format||["HTML","PDF"].indexOf(e[n].type.toUpperCase())>-1&&(!e[n].format||e[n].format.toUpperCase()==="FILE")))&&(o=!0),o&&(e[n].data=t.tools.absolute(e[n].data)),e[n].options&&typeof e[n].options.overlay=="string"&&(e[n].options.overlay=t.tools.absolute(e[n].options.overlay))}},extend:function(e){typeof e!="object"&&(e={});for(var n=1;n<arguments.length;n++){var o=arguments[n];if(o){for(var r in o)if(o.hasOwnProperty(r)){if(e===o[r])continue;if(o[r]&&o[r].constructor&&o[r].constructor===Object){var s;Array.isArray(o[r])?s=e[r]||[]:s=e[r]||{},e[r]=t.tools.extend(s,o[r])}else o[r]!==void 0&&(e[r]=o[r])}}}return e},versionCompare:function(e,n,o,r){if(t.tools.assertActive()){var s=t.websocket.connection.semver;if(Array.isArray(s)){if(e!=null&&s.length>0&&s[0]!=e)return s[0]-e;if(n!=null&&s.length>1&&s[1]!=n)return s[1]-n;if(o!=null&&s.length>2&&s[2]!=o)return s[2]-o;if(r!=null&&s.length>3&&s[3]!=r)return Number.isInteger(s[3])&&Number.isInteger(r)?s[3]-r:s[3].toString().localeCompare(r.toString())}return 0}},isVersion:function(e,n,o,r){return t.tools.versionCompare(e,n,o,r)==0},isActive:function(){return!t.websocket.shutdown&&t.websocket.connection!=null&&(t.websocket.connection.readyState===t.tools.ws.OPEN||t.websocket.connection.readyState===t.tools.ws.CONNECTING)},assertActive:function(){if(t.tools.isActive())return!0;throw new Error("A connection to QZ has not been established yet")},uint8ArrayToHex:function(e){return Array.from(e).map(function(n){return n.toString(16).padStart(2,"0")}).join("")},uint8ArrayToBase64:function(e){var n=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],o="",r,s=e.length;for(r=2;r<s;r+=3)o+=n[e[r-2]>>2],o+=n[(e[r-2]&3)<<4|e[r-1]>>4],o+=n[(e[r-1]&15)<<2|e[r]>>6],o+=n[e[r]&63];return r===s+1&&(o+=n[e[r-2]>>2],o+=n[(e[r-2]&3)<<4],o+="=="),r===s&&(o+=n[e[r-2]>>2],o+=n[(e[r-2]&3)<<4|e[r-1]>>4],o+=n[(e[r-1]&15)<<2],o+="="),o}},compatible:{data:function(e){for(var n=0;n<e.length;n++)if(e[n].constructor===Object&&e[n].data instanceof Uint8Array&&e[n].flavor){var o=e[n].flavor.toString().toUpperCase();switch(o){case"BASE64":e[n].data=t.tools.uint8ArrayToBase64(e[n].data);break;case"HEX":e[n].data=t.tools.uint8ArrayToHex(e[n].data);break;default:throw new Error("Uint8Array conversion to '"+o+"' is not supported.")}}if(t.tools.versionCompare(2,2,4)<0)for(var n=0;n<e.length;n++)e[n].constructor===Object&&e[n].options&&typeof e[n].options.dotDensity=="string"&&(e[n].options.dotDensity=e[n].options.dotDensity.toLowerCase().replace("-legacy",""));if(t.tools.isVersion(2,0)){t.log.trace("Converting print data to v2.0 for "+t.websocket.connection.version);for(var n=0;n<e.length;n++)e[n].constructor===Object&&(e[n].type&&e[n].type.toUpperCase()==="RAW"&&e[n].format&&e[n].format.toUpperCase()==="IMAGE"&&(e[n].flavor&&e[n].flavor.toUpperCase()==="BASE64"&&(e[n].data="data:image/compat;base64,"+e[n].data),e[n].flavor="IMAGE"),(e[n].type&&e[n].type.toUpperCase()==="RAW"||e[n].format&&e[n].format.toUpperCase()==="COMMAND")&&(e[n].format="RAW"),e[n].type=e[n].format,e[n].format=e[n].flavor,delete e[n].flavor)}},config:function(e,n){return t.tools.isVersion(2,0)&&(n.rasterize||(e.rasterize=!0)),t.tools.versionCompare(2,2)<0&&e.forceRaw!=="undefined"&&(e.altPrinting=e.forceRaw,delete e.forceRaw),t.tools.versionCompare(2,1,2,11)<0&&e.spool&&(e.spool.size&&(e.perSpool=e.spool.size,delete e.spool.size),e.spool.end&&(e.endOfDoc=e.spool.end,delete e.spool.end),delete e.spool),e},networking:function(e,n,o,r,s){return t.tools.isVersion(2,0)?t.tools.promise(function(c,l){t.websocket.dataPromise("websocket.getNetworkInfo",{hostname:e,port:n},o,r).then(function(d){c(typeof s<"u"?s(d):d)},l)}):t.tools.promise(function(c,l){t.websocket.dataPromise("networking.device",{hostname:e,port:n},o,r).then(function(d){c({ipAddress:d.ip,macAddress:d.mac})},l)})},algorithm:function(e){return t.tools.isActive()&&t.websocket.connection.semver&&t.tools.isVersion(2,0)?(e||t.log.warn("Connected to an older version of QZ, alternate signature algorithms are not supported"),!1):!0}},SHA:{hash:function(e){e=t.SHA._utf8Encode(e)+"";for(var n=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],o=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],r=e.length/4+2,s=Math.ceil(r/16),c=new Array(s),l=0;l<s;l++){c[l]=new Array(16);for(var d=0;d<16;d++)c[l][d]=e.charCodeAt(l*64+d*4)<<24|e.charCodeAt(l*64+d*4+1)<<16|e.charCodeAt(l*64+d*4+2)<<8|e.charCodeAt(l*64+d*4+3)}c[s-1][14]=(e.length-1)*8/Math.pow(2,32),c[s-1][14]=Math.floor(c[s-1][14]),c[s-1][15]=(e.length-1)*8&4294967295;for(var p=new Array(64),u,m,b,g,h,_,S,x,l=0;l<s;l++){for(var E=0;E<16;E++)p[E]=c[l][E];for(var E=16;E<64;E++)p[E]=t.SHA._dev1(p[E-2])+p[E-7]+t.SHA._dev0(p[E-15])+p[E-16]&4294967295;u=o[0],m=o[1],b=o[2],g=o[3],h=o[4],_=o[5],S=o[6],x=o[7];for(var E=0;E<64;E++){var P=x+t.SHA._sig1(h)+t.SHA._ch(h,_,S)+n[E]+p[E],D=t.SHA._sig0(u)+t.SHA._maj(u,m,b);x=S,S=_,_=h,h=g+P&4294967295,g=b,b=m,m=u,u=P+D&4294967295}o[0]=o[0]+u&4294967295,o[1]=o[1]+m&4294967295,o[2]=o[2]+b&4294967295,o[3]=o[3]+g&4294967295,o[4]=o[4]+h&4294967295,o[5]=o[5]+_&4294967295,o[6]=o[6]+S&4294967295,o[7]=o[7]+x&4294967295}return t.SHA._hexStr(o[0])+t.SHA._hexStr(o[1])+t.SHA._hexStr(o[2])+t.SHA._hexStr(o[3])+t.SHA._hexStr(o[4])+t.SHA._hexStr(o[5])+t.SHA._hexStr(o[6])+t.SHA._hexStr(o[7])},_rotr:function(e,n){return n>>>e|n<<32-e},_sig0:function(e){return t.SHA._rotr(2,e)^t.SHA._rotr(13,e)^t.SHA._rotr(22,e)},_sig1:function(e){return t.SHA._rotr(6,e)^t.SHA._rotr(11,e)^t.SHA._rotr(25,e)},_dev0:function(e){return t.SHA._rotr(7,e)^t.SHA._rotr(18,e)^e>>>3},_dev1:function(e){return t.SHA._rotr(17,e)^t.SHA._rotr(19,e)^e>>>10},_ch:function(e,n,o){return e&n^~e&o},_maj:function(e,n,o){return e&n^e&o^n&o},_hexStr:function(e){for(var n="",o,r=7;r>=0;r--)o=e>>>r*4&15,n+=o.toString(16);return n},_unescape:function(e){return e.replace(/%(u[\da-f]{4}|[\da-f]{2})/gi,function(n){if(n.length-1)return String.fromCharCode(parseInt(n.substring(n.length-3?2:1),16));var o=n.charCodeAt(0);return o<256?"%"+(0+o.toString(16)).slice(-2).toUpperCase():"%u"+("000"+o.toString(16)).slice(-4).toUpperCase()})},_utf8Encode:function(e){return t.SHA._unescape(encodeURIComponent(e))}}};function a(e,n){this.config=t.tools.extend({},t.printing.defaultConfig),this._dirtyOpts={},this.setPrinter=function(o){typeof o=="string"&&(o={name:o}),this.printer=o},this.getPrinter=function(){return this.printer},this.reconfigure=function(o){for(var r in o)o[r]!==void 0&&(this._dirtyOpts[r]=!0);t.tools.extend(this.config,o)},this.getOptions=function(){return t.compatible.config(this.config,this._dirtyOpts)},this.setPrinter(e),this.reconfigure(n)}a.prototype.print=function(e,n,o){i.print(this,e,n,o)};var i={websocket:{isActive:function(){return t.tools.isActive()},connect:function(e){return t.tools.promise(function(n,o){if(t.websocket.connection){const s=t.websocket.connection.readyState;if(s===t.tools.ws.OPEN){o(new Error("An open connection with QZ Tray already exists"));return}else if(s===t.tools.ws.CONNECTING){o(new Error("The current connection attempt has not returned yet"));return}else if(s===t.tools.ws.CLOSING){o(new Error("Waiting for previous disconnect request to complete"));return}}if(t.tools.ws){if(!t.tools.ws.CLOSED||t.tools.ws.CLOSED==2){o(new Error("Unsupported WebSocket version detected: HyBi-00/Hixie-76"));return}}else{o(new Error("WebSocket not supported by this browser"));return}e==null&&(e={}),(typeof location>"u"||location.protocol!=="https:")&&typeof e.usingSecure>"u"&&(t.log.trace("Disabling secure ports due to insecure page"),e.usingSecure=!1),typeof e.host<"u"&&!Array.isArray(e.host)&&(e.host=[e.host]),t.websocket.shutdown=!1;var r=function(s){var c=!1,l=function(){c||(c=!0,e&&s<e.retries?r(s+1):(t.websocket.connection=null,o.apply(null,arguments)))},d=function(){var p=t.tools.extend({},t.websocket.connectConfig,e);t.websocket.setup.findConnection(p,n,l)};s==0?d():setTimeout(d,e.delay*1e3)};r(0)})},disconnect:function(){return t.tools.promise(function(e,n){t.websocket.connection!=null?t.tools.isActive()?(t.websocket.shutdown=!0,t.websocket.connection.promise={resolve:e,reject:n},t.websocket.connection.close()):n(new Error("Current connection is still closing")):n(new Error("No open connection with QZ Tray"))})},setErrorCallbacks:function(e){t.websocket.errorCallbacks=e},setClosedCallbacks:function(e){t.websocket.closedCallbacks=e},getNetworkInfo:t.compatible.networking,getConnectionInfo:function(){if(t.tools.assertActive()){var e=t.websocket.connection.url.split(/[:\/]+/g);return{socket:e[0],host:e[1],port:+e[2]}}}},printers:{getDefault:function(e,n){return t.websocket.dataPromise("printers.getDefault",null,e,n)},find:function(e,n,o){return t.websocket.dataPromise("printers.find",{query:e},n,o)},details:function(){return t.websocket.dataPromise("printers.detail")},startListening:function(e,n){Array.isArray(e)||(e=[e]);var o={printerNames:e};return n&&n.jobData==!0&&(o.jobData=!0),n&&n.maxJobData&&(o.maxJobData=n.maxJobData),n&&n.flavor&&(o.flavor=n.flavor),t.websocket.dataPromise("printers.startListening",o)},clearQueue:function(e){return typeof e!="object"&&(e={printerName:e}),t.websocket.dataPromise("printers.clearQueue",e)},stopListening:function(){return t.websocket.dataPromise("printers.stopListening")},getStatus:function(){return t.websocket.dataPromise("printers.getStatus")},setPrinterCallbacks:function(e){t.printers.printerCallbacks=e}},configs:{setDefaults:function(e){t.tools.extend(t.printing.defaultConfig,e)},create:function(e,n){return new a(e,n)}},print:function(e,n){var o=!1,r=[],s=[];arguments.length>=3&&(typeof arguments[2]=="boolean"?(o=arguments[2],arguments.length>=5&&(r=arguments[3],s=arguments[4])):arguments.length>=4&&(r=arguments[2],s=arguments[3]),r&&!Array.isArray(r)&&(r=[r]),s&&!Array.isArray(s)&&(s=[s])),Array.isArray(e)||(e=[e]),Array.isArray(n[0])||(n=[n]);for(var c=0;c<n.length;c++)t.tools.relative(n[c]),t.compatible.data(n[c]);for(var l=function(g){var h={printer:g.config.getPrinter(),options:g.config.getOptions(),data:g.data};return t.websocket.dataPromise("print",h,g.signature,g.timestamp)},d=[],p=0;p<e.length||p<n.length;p++)(function(g){var h={config:e[Math.min(g,e.length-1)],data:n[Math.min(g,n.length-1)],signature:r[g],timestamp:s[g]};d.push(function(){return l(h)})})(p);var u=null;if(o){var m=[];u=function(g){m.push(g)},d.push(function(){return t.tools.promise(function(g,h){m.length?h(m):g()})})}var b=null;return d.reduce(function(g,h){return b=g.catch(u).then(h),b},t.tools.promise(function(g){g()})),b},serial:{findPorts:function(){return t.websocket.dataPromise("serial.findPorts")},setSerialCallbacks:function(e){t.serial.serialCallbacks=e},openPort:function(e,n){var o={port:e,options:n};return t.websocket.dataPromise("serial.openPort",o)},sendData:function(e,n,o){t.tools.versionCompare(2,1,0,12)>=0&&(typeof n!="object"&&(n={data:n,type:"PLAIN"}),n.type&&n.type.toUpperCase()=="FILE"&&(n.data=t.tools.absolute(n.data)));var r={port:e,data:n,options:o};return t.websocket.dataPromise("serial.sendData",r)},closePort:function(e){return t.websocket.dataPromise("serial.closePort",{port:e})}},socket:{open:function(e,n,o){var r={host:e,port:n,options:o};return t.websocket.dataPromise("socket.open",r)},close:function(e,n){var o={host:e,port:n};return t.websocket.dataPromise("socket.close",o)},sendData:function(e,n,o){typeof o!="object"&&(o={data:o,type:"PLAIN"});var r={host:e,port:n,data:o};return t.websocket.dataPromise("socket.sendData",r)},setSocketCallbacks:function(e){t.socket.socketCallbacks=e}},usb:{listDevices:function(e){return t.websocket.dataPromise("usb.listDevices",{includeHubs:e})},listInterfaces:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1]}),t.websocket.dataPromise("usb.listInterfaces",e)},listEndpoints:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],interface:arguments[2]}),t.websocket.dataPromise("usb.listEndpoints",e)},setUsbCallbacks:function(e){t.usb.usbCallbacks=e},claimDevice:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],interface:arguments[2]}),t.websocket.dataPromise("usb.claimDevice",e)},isClaimed:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1]}),t.websocket.dataPromise("usb.isClaimed",e)},sendData:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],endpoint:arguments[2],data:arguments[3]}),t.tools.versionCompare(2,1,0,12)>=0&&(typeof e.data!="object"&&(e.data={data:e.data,type:"PLAIN"}),e.data.type&&e.data.type.toUpperCase()=="FILE"&&(e.data.data=t.tools.absolute(e.data.data))),t.websocket.dataPromise("usb.sendData",e)},readData:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],endpoint:arguments[2],responseSize:arguments[3]}),t.websocket.dataPromise("usb.readData",e)},openStream:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],endpoint:arguments[2],responseSize:arguments[3],interval:arguments[4]}),t.websocket.dataPromise("usb.openStream",e)},closeStream:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],endpoint:arguments[2]}),t.websocket.dataPromise("usb.closeStream",e)},releaseDevice:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1]}),t.websocket.dataPromise("usb.releaseDevice",e)}},hid:{listDevices:function(){return t.websocket.dataPromise("hid.listDevices")},startListening:function(){return t.websocket.dataPromise("hid.startListening")},stopListening:function(){return t.websocket.dataPromise("hid.stopListening")},setHidCallbacks:function(e){t.hid.hidCallbacks=e},claimDevice:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1]}),t.websocket.dataPromise("hid.claimDevice",e)},isClaimed:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1]}),t.websocket.dataPromise("hid.isClaimed",e)},sendData:function(e){if(typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],data:arguments[2],endpoint:arguments[3]}),t.tools.versionCompare(2,1,0,12)>=0)typeof e.data!="object"&&(e.data={data:e.data,type:"PLAIN"}),e.data.type&&e.data.type.toUpperCase()=="FILE"&&(e.data.data=t.tools.absolute(e.data.data));else if(typeof e.data=="object"){if(e.data.type.toUpperCase()!=="PLAIN"||typeof e.data.data!="string")return t.tools.reject(new Error("Data format is not supported with connected QZ Tray version "+t.websocket.connection.version));e.data=e.data.data}return t.websocket.dataPromise("hid.sendData",e)},readData:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],responseSize:arguments[2]}),t.websocket.dataPromise("hid.readData",e)},sendFeatureReport:function(e){return t.websocket.dataPromise("hid.sendFeatureReport",e)},getFeatureReport:function(e){return t.websocket.dataPromise("hid.getFeatureReport",e)},openStream:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1],responseSize:arguments[2],interval:arguments[3]}),t.websocket.dataPromise("hid.openStream",e)},closeStream:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1]}),t.websocket.dataPromise("hid.closeStream",e)},releaseDevice:function(e){return typeof e!="object"&&(e={vendorId:arguments[0],productId:arguments[1]}),t.websocket.dataPromise("hid.releaseDevice",e)}},file:{list:function(e,n){var o=t.tools.extend({path:e},n);return t.websocket.dataPromise("file.list",o)},read:function(e,n){var o=t.tools.extend({path:e},n);return t.websocket.dataPromise("file.read",o)},write:function(e,n){var o=t.tools.extend({path:e},n);return t.websocket.dataPromise("file.write",o)},remove:function(e,n){var o=t.tools.extend({path:e},n);return t.websocket.dataPromise("file.remove",o)},startListening:function(e,n){n&&typeof n.include<"u"&&!Array.isArray(n.include)&&(n.include=[n.include]),n&&typeof n.exclude<"u"&&!Array.isArray(n.exclude)&&(n.exclude=[n.exclude]);var o=t.tools.extend({path:e},n);return t.websocket.dataPromise("file.startListening",o)},stopListening:function(e,n){var o=t.tools.extend({path:e},n);return t.websocket.dataPromise("file.stopListening",o)},setFileCallbacks:function(e){t.file.fileCallbacks=e}},networking:{device:function(e,n){return t.tools.isVersion(2,0)?t.compatible.networking(e,n,null,null,function(o){return{ip:o.ipAddress,mac:o.macAddress}}):t.websocket.dataPromise("networking.device",{hostname:e,port:n})},hostname:function(e,n){return t.tools.versionCompare(2,2,2)<0?t.tools.promise(function(o,r){t.websocket.dataPromise("networking.device",{hostname:e,port:n}).then(function(s){console.log(s),o(s.hostname)})}):t.websocket.dataPromise("networking.hostname")},devices:function(e,n){return t.tools.isVersion(2,0)?t.compatible.networking(e,n,null,null,function(o){return[{ip:o.ipAddress,mac:o.macAddress}]}):t.websocket.dataPromise("networking.devices",{hostname:e,port:n})}},security:{setCertificatePromise:function(e,n){t.security.certHandler=e,t.security.rejectOnCertFailure=!!(n&&n.rejectOnFailure)},setSignaturePromise:function(e){t.security.signatureFactory=e},setSignatureAlgorithm:function(e){t.compatible.algorithm()&&(["SHA1","SHA256","SHA512"].indexOf(e.toUpperCase())<0?t.log.error("Signing algorithm '"+e+"' is not supported."):t.security.signAlgorithm=e)},getSignatureAlgorithm:function(){return t.security.signAlgorithm}},api:{showDebug:function(e){return t.DEBUG=e},getVersion:function(){return t.websocket.dataPromise("getVersion")},isVersion:t.tools.isVersion,isVersionGreater:function(e,n,o,r){return t.tools.versionCompare(e,n,o,r)>0},isVersionLess:function(e,n,o,r){return t.tools.versionCompare(e,n,o,r)<0},setPromiseType:function(e){t.tools.promise=e},setSha256Type:function(e){t.tools.hash=e},setWebSocketType:function(e){t.tools.ws=e}},version:t.VERSION};return i}();(function(){typeof define=="function"&&define.amd?define(M):typeof Z=="object"?we.exports=M:typeof window=="object"?window.qz=M:self.qz=M})();const ce="https://wnwftbamyaotqdsivmas.supabase.co",le="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo";let y,I=[],C=[],T=null,H=[],de={};window.supabase?y=window.supabase.createClient(ce,le):(console.error("Error Fatal: Librería Supabase no encontrada. La aplicación no funcionará."),y=null);function w(t){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(t)}function $(t){const a={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(t).toLocaleDateString("es-MX",a)}function ke(t){if(!t)return{start:null,end:null};const[a,i]=t.split("-").map(Number),e=new Date(a,i-1,1),n=new Date(a,i,1),o=e.toISOString().substring(0,10),r=n.toISOString().substring(0,10);return{start:o,end:r}}window.openModal=function(t){const a=document.getElementById(t);a&&(a.classList.add("flex"),a.classList.remove("hidden"))};window.closeModal=function(t){const a=document.getElementById(t);a&&(a.classList.add("hidden"),a.classList.remove("flex"))};async function V(){const{data:{user:t}}=await y.auth.getUser(),a=document.getElementById("auth-container"),i=document.getElementById("dashboard-container");if(!a||!i){console.error("Error: Los contenedores 'auth-container' o 'dashboard-container' no se encontraron en el HTML.");return}t?(a.classList.add("hidden"),i.classList.remove("hidden"),await L()):(a.classList.remove("hidden"),i.classList.add("hidden"))}async function Ie(t){t.preventDefault();const a=document.getElementById("email").value,i=document.getElementById("password").value,{error:e}=await y.auth.signInWithPassword({email:a,password:i});e?alert(e.message):V()}async function Ce(){await y.auth.signOut(),V()}async function Se(){const t=document.getElementById("sales-month-filter"),a=document.getElementById("filter-status"),i=t==null?void 0:t.value,{start:e,end:n}=ke(i);let o=y.from("ventas").select("total_amount"),r="Total histórico";e&&n&&(o=o.gte("created_at",e).lt("created_at",n),r=`Total del mes de ${new Date(e).toLocaleDateString("es-ES",{year:"numeric",month:"long"})}`);const{data:s,error:c}=await o;if(c){console.error("Error al cargar ventas:",c),document.getElementById("total-sales").textContent=w(0),a&&(a.textContent="Error al cargar");return}const l=s.reduce((m,b)=>m+b.total_amount,0);document.getElementById("total-sales").textContent=w(l),a&&(a.textContent=r);const{data:d,error:p}=await y.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",0);if(p){console.error("Error al cargar deudas:",p),document.getElementById("total-debt").textContent=w(0);return}const u=d.reduce((m,b)=>m+b.saldo_pendiente,0);document.getElementById("total-debt").textContent=w(u)}async function _e(){try{const{data:t,error:a}=await y.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name, client_id)").gt("saldo_pendiente",.01).order("created_at",{ascending:!1}).limit(5);if(a){console.error("Error al cargar tabla de deudas:",a);return}const i=document.getElementById("debt-sales-body");if(!i)return;i.innerHTML="";const e=document.getElementById("no-debt-message");if(e&&e.classList.add("hidden"),t.length===0){e&&e.classList.remove("hidden");return}t.forEach(n=>{var c,l;const o=((c=n.clientes)==null?void 0:c.name)||"Cliente Desconocido",r=(l=n.clientes)==null?void 0:l.client_id,s=document.createElement("tr");s.className="hover:bg-gray-50",s.innerHTML=`
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.venta_id}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${o}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-red-600">${w(n.saldo_pendiente)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                        type="button" 
                        class="view-debt-btn" 
                        data-client-id="${r}" 
                        data-sale-id="${n.venta_id}" // Si necesitas la venta, mantenla
        class="view-debt-btn bg-red-600 hover:bg-red-700 text-white font-semibold text-xs py-1 px-2 rounded"
                    >
                        Detalles/Pagar
                    </button>
                </td>
            `,i.appendChild(s)}),i.querySelectorAll(".view-debt-btn").forEach(n=>{n.addEventListener("click",()=>{const o=n.dataset.clientId;O(o)})})}catch(t){console.error("Error inesperado en loadDebts:",t)}}async function Ae(){try{const{data:t,error:a}=await y.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name, client_id), description").order("created_at",{ascending:!1}).limit(7);if(a){console.error("Error al cargar ventas recientes:",a);return}const i=document.getElementById("recent-sales-body"),e=document.getElementById("no-sales-message");if(!i)return;if(i.innerHTML="",e&&e.classList.add("hidden"),t.length===0){e&&e.classList.remove("hidden");return}t.forEach(n=>{var c,l;const o=((c=n.clientes)==null?void 0:c.name)||"Cliente Desconocido",r=(l=n.clientes)==null?void 0:l.client_id,s=document.createElement("tr");s.className="hover:bg-gray-50",s.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.venta_id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${o}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${$(n.created_at)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${w(n.total_amount)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${n.saldo_pendiente>0?"text-red-600":"text-green-600"}">${w(n.saldo_pendiente)}</td>
                
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"> 
                    <button type="button" 
                            class="view-sale-details-btn text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 rounded bg-indigo-100"
                            data-sale-id="${n.venta_id}"
                            data-client-id="${r}"> 
                        Detalles
                    </button>
                </td>
            `,i.appendChild(s)}),i.querySelectorAll(".view-sale-details-btn").forEach(n=>{n.addEventListener("click",()=>{const o=n.dataset.saleId,r=n.dataset.clientId;me(o,r)})})}catch(t){console.error("Error inesperado en loadRecentSales:",t)}}async function L(){await Se(),await _e(),await Ae(),await B("gestion"),await A(),await $e(),await ue()}async function ue(){const t=document.getElementById("client-select");if(!t)return;t.innerHTML='<option value="" disabled selected>Cargando clientes...</option>';const{data:a,error:i}=await y.from("clientes").select("client_id, name").order("name",{ascending:!0});if(i){console.error("Error al cargar clientes para venta:",i),t.innerHTML='<option value="" disabled selected>Error al cargar (revisar consola)</option>';return}if(a.length===0){t.innerHTML='<option value="" disabled selected>No hay clientes activos</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione un Cliente</option>',a.forEach(e=>{const n=document.createElement("option");n.value=e.client_id,n.textContent=e.name,t.appendChild(n)})}async function A(){if(!y){console.warn("Supabase no inicializado. No se pudieron cargar los productos.");return}const{data:t,error:a}=await y.from("productos").select("producto_id, name, type, price, parent_product");if(a){console.error("Error al cargar todos los productos:",a),I=[];return}I=t||[]}function Le(){const t=document.getElementById("product-main-select"),a=document.getElementById("subproduct-select"),i=document.getElementById("product-unit-price");if(!t||!a||!i||typeof I>"u")return;const e=t.value;if(a.innerHTML='<option value="" selected>Sin Paquete</option>',a.disabled=!0,i.value="0.00",!e)return;if(!I.find(r=>String(r.producto_id)===String(e))){console.warn(`Producto principal con ID ${e} no encontrado.`);return}J(e);const o=I.filter(r=>r.type&&r.type.trim().toUpperCase()==="PACKAGE"&&r.parent_product&&String(r.parent_product)===String(e));o.length>0&&(a.disabled=!1,a.innerHTML='<option value="" disabled selected>Seleccione un Paquete</option>',o.forEach(r=>{const s=document.createElement("option");s.value=r.producto_id;const c=typeof w=="function"?w(r.price):`$${r.price.toFixed(2)}`;s.textContent=`${r.name} (${c})`,a.appendChild(s)}))}async function U(){const t=document.getElementById("product-main-select"),a=document.getElementById("subproduct-select"),i=document.getElementById("product-unit-price");if(!t||!a||!i)return;const e=I.filter(n=>n.type&&n.type.trim().toUpperCase()==="MAIN");if(a.innerHTML='<option value="" selected>Sin Paquete</option>',i.value="0.00",a.disabled=!0,e.length===0){t.innerHTML='<option value="" disabled selected>❌ No hay Productos Base (Tipo: MAIN)</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione Producto Base</option>',e.forEach(n=>{const o=document.createElement("option");o.value=n.producto_id,o.textContent=`${n.name}`,t.appendChild(o)})}async function pe(t){const a=document.getElementById(t);if(!a)return;const i=I.filter(e=>e.type&&e.type.trim().toUpperCase()==="MAIN");if(a.innerHTML='<option value="" disabled selected>Seleccione Producto Principal</option>',i.length===0){a.innerHTML='<option value="" disabled selected>❌ No hay Productos Base (Tipo: MAIN)</option>';return}i.forEach(e=>{const n=document.createElement("option");n.value=e.producto_id,n.textContent=`${e.name} ($${e.price.toFixed(2)})`,a.appendChild(n)})}function J(t){const a=document.getElementById("product-unit-price"),i=I.find(e=>String(e.producto_id)===String(t));a&&(i&&i.price!==void 0?a.value=i.price.toFixed(2):a.value="0.00")}function ne(){const t=C.reduce((e,n)=>e+n.subtotal,0),a=document.getElementById("total-amount");a&&(a.value=t.toFixed(2)),R(t);const i=document.getElementById("submit-sale-btn");return C.length>0?i==null||i.removeAttribute("disabled"):i==null||i.setAttribute("disabled","true"),t}function F(){const t=document.getElementById("sale-items-container");if(t){if(t.innerHTML="",C.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">Agrega productos a la venta.</td></tr>',ne();return}C.forEach((a,i)=>{const e=document.createElement("tr");e.className="hover:bg-gray-50",e.innerHTML=`
            <td class="px-6 py-3 text-sm font-medium text-gray-900">${a.name}</td>
            <td class="px-6 py-3 text-sm text-gray-500">${w(a.price)}</td>
            <td class="px-6 py-3 text-sm text-gray-500 text-center">${a.quantity}</td>
            <td class="px-6 py-3 text-sm font-bold">${w(a.subtotal)}</td>
            <td class="px-6 py-3 text-right text-sm font-medium">
                <button type="button" onclick="removeItemFromSale(${i})" 
                        class="text-red-600 hover:text-red-900">
                    <i class="fas fa-times-circle"></i>
                </button>
            </td>
        `,t.appendChild(e)}),ne()}}window.removeItemFromSale=function(t){C.splice(t,1),F()};function Pe(t){t.preventDefault();const a=document.getElementById("product-main-select"),i=document.getElementById("subproduct-select"),e=document.getElementById("product-quantity"),n=a==null?void 0:a.value,o=i==null?void 0:i.value,r=parseFloat(e==null?void 0:e.value);let s=o;s||(s=n);const c=String(s),l=I.find(g=>String(g.producto_id)===c);if(!l){alert("Por favor, selecciona un Producto o Paquete válido.");return}if(isNaN(r)||r<=0){alert("La cantidad debe ser mayor a cero.");return}let d=l.name;if(o){const g=I.find(h=>String(h.producto_id)===String(n));g&&(d=`${g.name} (${l.name})`)}const p=l.price,u=r*p,m={product_id:c,name:d,quantity:r,price:p,subtotal:u},b=C.findIndex(g=>g.product_id===c);b>-1?(C[b].quantity+=r,C[b].subtotal+=u):C.push(m),F(),a.value="",i.value="",e.value="1",J(null),U()}async function Be(t,a,i,e){if(!y||isNaN(e)||e<=0){alert("El precio debe ser un monto positivo.");return}try{const{data:n,error:o}=await y.from("detalle_ventas").select("quantity").eq("id",a).single();if(o||!n)throw new Error("No se pudo obtener el detalle del ítem.");const s=n.quantity*e,{error:c}=await y.from("detalle_ventas").update({price:e,subtotal:s}).eq("id",a);if(c)throw c;const{data:l,error:d}=await y.from("detalle_ventas").select("subtotal").eq("venta_id",t);if(d||!l)throw d;const p=l.reduce((b,g)=>b+g.subtotal,0),u=p,{error:m}=await y.from("ventas").update({total_amount:p,saldo_pendiente:u}).eq("venta_id",t);if(m)throw m;alert(`✅ Deuda de ${w(u)} registrada exitosamente.`),await B("gestion"),await O(i)}catch(n){console.error("Error al actualizar precio post-venta:",n),alert(`Error al actualizar la venta: ${n.message}`)}}function R(t=null){const a=document.getElementById("paid-amount"),i=document.getElementById("payment-method"),e=document.getElementById("total-amount"),n=t||parseFloat(e==null?void 0:e.value)||0,o=i==null?void 0:i.value;let r=parseFloat(a==null?void 0:a.value)||0;o==="Deuda"?(r=0,a&&(a.value="0.00",a.readOnly=!0)):(a&&(a.readOnly=!1),r>n&&(r=n,a&&(a.value=n.toFixed(2))));const s=Math.max(0,n-r),c=document.getElementById("remaining-balance");c&&(c.value=s.toFixed(2)),a&&o!=="Deuda"&&a.setAttribute("max",n.toFixed(2))}async function De(t){if(!y)return{totalVentas:0,deudaNeta:0};try{const{data:a,error:i}=await y.from("transacciones_deuda").select("type, amount").eq("client_id",t);if(i)throw i;let e=0,n=0;return a.forEach(o=>{o.type==="cargo_venta"?(e+=o.amount,n+=o.amount):n-=o.amount}),n=Math.max(0,n),{totalVentas:e,deudaNeta:n}}catch(a){return console.error(`Error al obtener resumen del cliente ${t}:`,a),{totalVentas:0,deudaNeta:0}}}async function Me(t){if(t.preventDefault(),!y)return;const a=document.getElementById("abono-client-id-input"),i=document.getElementById("abono-amount"),e=document.getElementById("abono-method");if(!a||!i||!e){console.error("Error FATAL: No se encontraron los campos del formulario de abono. Revise los IDs en el HTML."),alert("Error interno: Faltan campos en el formulario. Contacte soporte.");return}const n=a.value,o=parseFloat(i.value),r=e.value;if(!n||o<=0){alert("Por favor, seleccione un cliente y un monto válido.");return}try{const{data:s,error:c}=await y.from("abonos").insert({client_id:n,fecha_abono:new Date().toISOString()}).select("abono_id").single();if(c)throw c;const l=s.abono_id,{error:d}=await y.from("pagos").insert({abono_id:l,amount:o,payment_method:r});if(d)throw d;alert("✅ Abono registrado exitosamente."),closeModal("modal-record-abono"),closeModal("modal-client-debt-report"),await B("gestion")}catch(s){console.error("Error al registrar abono:",s.message||s),alert("Hubo un error al registrar el abono. Intente nuevamente.")}}async function Te(t){var d,p,u,m;t.preventDefault();const a=((d=document.getElementById("client-select"))==null?void 0:d.value)??null,i=((p=document.getElementById("payment-method"))==null?void 0:p.value)??"Efectivo",e=((u=document.getElementById("sale-description"))==null?void 0:u.value.trim())??null,n=((m=document.getElementById("paid-amount"))==null?void 0:m.value)??"0";let o=parseFloat(n);const r=C.reduce((b,g)=>b+g.subtotal,0);i==="Deuda"&&(o=0);const s=r-o;if(!a){alert("Por favor, selecciona un cliente.");return}if(C.length===0){alert("Debes agregar al menos un producto a la venta.");return}if(r<0){alert("El total de la venta no puede ser negativo.");return}let c=o,l=s;if(r===0&&(c=0,l=0),i!=="Deuda"&&(c<0||c>r)){alert("El monto pagado es inválido.");return}if(!(l>.01&&i!=="Deuda"&&!confirm(`¡Atención! Hay un saldo pendiente de ${w(l)}. ¿Deseas continuar registrando esta cantidad como deuda?`)))try{const{data:b,error:g}=await y.from("ventas").insert([{client_id:a,total_amount:r,paid_amount:c,saldo_pendiente:l,metodo_pago:i,description:e}]).select("venta_id");if(g||!b||b.length===0){console.error("Error al insertar venta:",g),alert(`Error al registrar la venta: ${(g==null?void 0:g.message)||"Desconocido"}`);return}const h=b[0].venta_id,_=C.map(x=>({venta_id:h,product_id:x.product_id,name:x.name,quantity:x.quantity,price:x.price,subtotal:x.subtotal})),{error:S}=await y.from("detalle_ventas").insert(_);if(S&&(console.error("Error al insertar detalles de venta:",S),alert(`Venta registrada (ID: ${h}), pero falló el registro de detalles: ${S.message}`)),c>0){const{error:x}=await y.from("pagos").insert([{venta_id:h,amount:c,client_id:a,metodo_pago:i}]);x&&(console.error("Error al registrar pago inicial:",x),alert(`Advertencia: El pago inicial falló. ${x.message}`))}closeModal("new-sale-modal"),await L(),he(h)}catch(b){console.error("Error fatal al registrar la venta:",b.message),alert("Error fatal al registrar la venta: "+b.message)}finally{C=[],F(),document.getElementById("new-sale-form").reset()}}let G=null;async function O(t){if(!y){console.error("Supabase no está inicializado.");return}G=t;const a=H.find(i=>i.client_id.toString()===t.toString());if(!a){console.error("Cliente no encontrado en allClients.");return}try{const{data:i,error:e}=await y.from("transacciones_deuda").select(`
                transaction_id, created_at, type, amount, client_id
            `).eq("client_id",t).order("created_at",{ascending:!0});if(e)throw e;const n=document.getElementById("client-transactions-body"),o=document.getElementById("client-report-total-debt");if(!n||!o)return;let r=0,s="";i.forEach(l=>{const d=l.type==="cargo_venta";d?r+=l.amount:r-=l.amount;const p=r;let u="",m="";switch(l.type){case"cargo_venta":u="Venta (Cargo)",m="Venta que generó deuda.";break;case"abono_inicial":u="Pago Inicial",m="Pago realizado al momento de la venta.";break;case"abono_posterior":u="Abono",m="Pago posterior a la venta.";break;default:u="Movimiento",m="Movimiento de deuda."}let b="";const g=Math.abs(parseFloat(l.amount))<.01;l.type==="cargo_venta"&&g&&t&&(b=`
                    <button onclick="handleViewSaleDetails('${l.transaction_id}', '${t}')"
                            class="ml-2 px-2 py-1 text-xs text-white bg-yellow-500 rounded hover:bg-yellow-600 transition duration-150">
                        Añadir Precio
                    </button>
                 `),s+=`
                <tr>
                    <td class="px-3 py-2 text-sm">${$(l.created_at)}</td>
                    <td class="px-3 py-2 text-sm" title="${m}">${u} ${b}</td>
                    <td class="px-3 py-2 text-sm ${d?"text-red-600":"text-green-600"}">
                        ${w(l.amount)}
                    </td>
                    <td class="px-3 py-2 text-sm font-semibold">${w(p)}</td>
                </tr>
            `}),document.getElementById("client-report-name").textContent=a.name,n.innerHTML=s;const c=r;o.textContent=w(c),o.className=`font-bold ${c>0?"text-red-600":"text-green-600"}`,openModal("modal-client-debt-report")}catch(i){console.error("Error al cargar el reporte de deuda:",i),alert("Hubo un error al cargar el reporte de deuda del cliente.")}}async function me(t,a){if(!y){console.error("Supabase no está inicializado.");return}const i=H.find(e=>e.client_id.toString()===a.toString());if(!i){console.error("Cliente no encontrado en allClients."),alert("Error: Cliente no encontrado para esta venta.");return}G=a;try{const{data:e,error:n}=await y.from("ventas").select("venta_id, total_amount, saldo_pendiente, created_at, description, metodo_pago").eq("venta_id",t).single();if(n||!e){console.error("Error al cargar detalles de la venta (Tabla Ventas):",n),alert("Error: No se encontró la venta principal (ID: "+t+") en la tabla 'ventas'.");return}const{data:o,error:r}=await y.from("detalle_ventas").select("detalle_id, quantity, price, subtotal, productos(name)").eq("venta_id",t).order("detalle_id",{ascending:!0});if(r)throw r;const{data:s,error:c}=await y.from("pagos").select("amount, metodo_pago, created_at").eq("venta_id",t).order("created_at",{ascending:!0});if(c)throw c;document.getElementById("detail-sale-id").textContent=`#${e.venta_id}`,document.getElementById("detail-client-name").textContent=i.name,document.getElementById("detail-date").textContent=$(e.created_at),document.getElementById("detail-total-amount").textContent=w(e.total_amount),document.getElementById("detail-saldo-pendiente").textContent=w(e.saldo_pendiente),document.getElementById("detail-comments").textContent=e.description||"Sin comentarios.",document.getElementById("payment-sale-id").value=e.venta_id;const l=document.getElementById("detail-items-body");l.innerHTML="",(o||[]).forEach(m=>{var b;l.innerHTML+=`
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-3">${((b=m.productos)==null?void 0:b.name)||"Producto Desconocido"}</td>
                    <td class="px-6 py-3 text-center">${m.quantity}</td>
                    <td class="px-6 py-3 text-right">${w(m.price)}</td>
                    <td class="px-6 py-3 text-right">${w(m.subtotal)}</td>
                </tr>
            `});const d=document.getElementById("detail-payments-body");d.innerHTML="",s.length===0?d.innerHTML='<tr><td colspan="3" class="px-6 py-3 text-center text-gray-500 italic">No hay pagos registrados para esta venta.</td></tr>':s.forEach(m=>{d.innerHTML+=`
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3">${$(m.created_at)}</td>
                        <td class="px-6 py-3 text-right font-semibold text-green-600">${w(m.amount)}</td>
                        <td class="px-6 py-3 text-center">${m.metodo_pago}</td>  
                    </tr>
                `});const p=document.getElementById("sale-edit-section");if(Math.abs(parseFloat(e.total_amount))<.01&&e.metodo_pago==="Deuda"&&o.length>0){p.classList.remove("hidden");const m=o[0];document.getElementById("sale-edit-transaction-id").value=`${e.venta_id}|${m.detalle_id}|${a}`,document.getElementById("sale-edit-price").value=m.price.toFixed(2)}else p.classList.add("hidden");openModal("modal-detail-sale")}catch(e){console.error("Error al cargar detalles de venta:",e),alert("Hubo un error al cargar los detalles de la venta.")}}async function B(t="gestion"){if(!y){console.error("Supabase no está inicializado.");return}const a=document.getElementById("clients-list-body");if(!a){console.error("Contenedor de clientes ('clients-list-body') no encontrado.");return}const i=t==="gestion";try{const{data:e,error:n}=await y.from("clientes").select("client_id, name, telefono").order("name",{ascending:!0});if(n)throw n;H=e;const o=e.map(s=>De(s.client_id)),r=await Promise.all(o);a.innerHTML="",e.forEach((s,c)=>{const l=r[c],d=document.createElement("tr");d.className="hover:bg-gray-50";let p="";i?p=`
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" class="edit-client-btn text-indigo-600 hover:text-indigo-900 mr-2" 
                                        data-client-id="${s.client_id}">
                            <i class="fas fa-edit"></i> Editar
                
                <button type="button" class="delete-client-btn text-red-600 hover:text-red-900 mr-2" 
                 data-client-id="${s.client_id}" 
               data-client-name="${s.name}">
                 <i class="fas fa-trash"></i> Eliminar
                </button>

                     <button type="button" class="view-debt-btn text-blue-600 hover:text-blue-900" 
                        data-client-id="${s.client_id}" title="Ver ventas y abonos del cliente">
                        <i class="fas fa-file-invoice-dollar"></i> Ver Deuda
                    </button>
                    </td>
                `:p='<td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium"></td>',d.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${s.client_id}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${s.name}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${s.telefono||"N/A"}</td>
                
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">
                    $${l.totalVentas.toFixed(2)}
                </td>
                
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold 
                    ${l.deudaNeta>0?"text-red-600":"text-green-600"}">
                    $${l.deudaNeta.toFixed(2)}
                </td>
                
                ${p} 
            `,a.appendChild(d)}),i&&(a.querySelectorAll(".edit-client-btn").forEach(s=>{s.addEventListener("click",()=>{fe(s.dataset.clientId)})}),a.querySelectorAll(".delete-client-btn").forEach(s=>{s.addEventListener("click",()=>{ge(s.dataset.clientId,s.dataset.clientName)})}),a.querySelectorAll(".view-debt-btn").forEach(s=>{s.addEventListener("click",()=>{O(s.dataset.clientId)})}))}catch(e){console.error("Error inesperado al cargar clientes:",e.message||e)}}async function oe(t){t.preventDefault();const a=document.getElementById("name").value,i=document.getElementById("phone").value,{error:e}=await y.from("clientes").insert([{name:a,telefono:i,is_active:!0}]);if(e)alert("Error al registrar cliente: "+e.message);else{alert("Cliente registrado exitosamente."),await Ze();const n=document.getElementById("client-form");n?n.reset():console.warn("Advertencia: No se encontró el formulario 'client-form' para resetear."),closeModal("modal-new-client"),await B()}}function fe(t){if(!y){console.error("Supabase no está inicializado.");return}const a=H.find(o=>String(o.client_id)===String(t));if(!a){alert("Error: Cliente no encontrado para editar.");return}const i=document.getElementById("edit-client-id");i&&(i.value=a.client_id);const e=document.getElementById("edit-client-name");e&&(e.value=a.name);const n=document.getElementById("edit-client-phone");n&&(n.value=a.telefono||""),openModal("edit-client-modal")}async function re(t){t.preventDefault();const a=document.getElementById("edit-client-id").value,i=document.getElementById("edit-client-name").value.trim(),e=document.getElementById("edit-client-phone").value.trim();if(!a){alert("Error de Edición: No se pudo obtener la ID del cliente.");return}const{error:n}=await y.from("clientes").update({name:i,telefono:e}).eq("client_id",a);n?(console.error("Error al actualizar cliente:",n),alert("Error al actualizar cliente: "+n.message)):(alert("Cliente actualizado exitosamente."),await L(),document.getElementById("edit-client-form").reset(),closeModal("edit-client-modal"))}async function Ne(t){var d;if(t.preventDefault(),!y||!T){alert("Error: Supabase no está disponible o el ID del producto a editar es desconocido.");return}const a=document.getElementById("edit-product-name"),i=document.getElementById("edit-product-type"),e=document.getElementById("edit-sale-price"),n=a.value.trim(),o=i.value,r=parseFloat(e.value);let s=null;if(isNaN(r)||r<0||e.value.trim()===""){alert("El precio de venta debe ser un número válido (mayor o igual a cero).");return}if(o==="PACKAGE"){const p=document.getElementById("edit-parent-product-select");if(s=(p==null?void 0:p.value)||null,!s){alert("Los paquetes deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const c={name:n,type:o,price:r,parent_product:s},{error:l}=await y.from("productos").update(c).eq("producto_id",T);l?(console.error("Error de Supabase al actualizar producto:",l.message),alert("Error al actualizar producto: "+l.message)):(alert("Producto actualizado exitosamente."),closeModal("modal-edit-product"),T=null,(d=document.getElementById("edit-product-form"))==null||d.reset(),await A(),await q())}function ae(){const t=document.getElementById("new-product-type"),a=document.getElementById("parent-product-container"),i=document.getElementById("parent-product-select");!t||!a||!i||(t.value==="PACKAGE"?(a.classList.remove("hidden"),a.classList.add("block"),i.setAttribute("required","required")):(a.classList.add("hidden"),a.classList.remove("block"),i.removeAttribute("required"),i.value=""))}async function $e(){const t=document.getElementById("products-table-body");if(!t)return;await A(),t.innerHTML="";const a=I;if(a.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">No hay productos registrados.</td></tr>';return}a.forEach(i=>{const e=document.createElement("tr");e.className="hover:bg-gray-50",e.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${i.producto_id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${i.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${i.type}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${w(i.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-product-id="${i.producto_id}" class="text-indigo-600 hover:text-indigo-900 edit-product-btn mr-2">Editar</button>
                <button data-product-id="${i.producto_id}" class="text-red-600 hover:text-red-900 delete-product-btn">Eliminar</button>
            </td>
        `,t.appendChild(e)}),document.querySelectorAll(".edit-product-btn").forEach(i=>{i.onclick=()=>{const e=i.getAttribute("data-product-id");openEditProductModal(e)}}),document.querySelectorAll(".delete-product-btn").forEach(i=>{i.onclick=()=>{const e=i.getAttribute("data-product-id");handleDeleteProduct(e)}})}async function He(t){var l;if(t.preventDefault(),!y){alert("Error de conexión: Supabase no está disponible.");return}const a=document.getElementById("new-product-name"),i=document.getElementById("new-product-type"),e=document.getElementById("new-product-price");if(!a||!i||!e){console.error("Error FATAL: No se encontraron todos los campos del formulario en el DOM. Verifique los IDs."),alert("Error al intentar guardar el producto. Verifique los IDs en la consola.");return}const n=a.value.trim(),o=i.value,r=parseFloat(e.value);let s=null;if(isNaN(r)||r<0||e.value.trim()===""){alert("El precio unitario debe ser un número válido (mayor o igual a cero).");return}if(o==="PACKAGE"){const d=document.getElementById("parent-product-select");if(s=(d==null?void 0:d.value)||null,!s){alert("Los paquetes deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const{error:c}=await y.from("productos").insert([{name:n,type:o,price:r,parent_product:s}]);c?(console.error("Error de Supabase al registrar producto:",c.message),alert("Error al registrar producto: "+c.message)):(alert("Producto registrado exitosamente."),closeModal("modal-register-product"),(l=document.getElementById("new-product-form"))==null||l.reset(),await A(),await q())}function Fe(t){const a=I.find(e=>String(e.producto_id)===String(t));if(!a){alert("Error: Producto no encontrado para edición.");return}document.getElementById("product-id").value=a.producto_id,document.getElementById("edit-product-name").value=a.name,document.getElementById("edit-product-type").value=a.type,document.getElementById("edit-sale-price").value=a.price||0;const i=document.getElementById("edit-parent-product-container");a.type==="PACKAGE"?(i.classList.remove("hidden"),pe("edit-parent-product-select"),document.getElementById("edit-parent-product-select").value=a.parent_product):i.classList.add("hidden"),document.getElementById("product-modal-title").textContent="Editar Producto: "+a.name}function Oe(t){T=t,Fe(t),openModal("modal-edit-product")}let N=null;function qe(t){N=t;const a=I.find(i=>String(i.producto_id)===String(t));a&&(document.getElementById("delete-product-name-placeholder").textContent=a.name),openModal("modal-delete-confirmation")}async function Ue(){if(!N)return;const{error:t}=await y.from("productos").delete().eq("producto_id",N);t?(console.error("Error al eliminar producto:",t.message),alert("Error al eliminar producto: "+t.message)):(alert("Producto eliminado exitosamente."),closeModal("modal-delete-confirmation"),N=null,await A(),await q())}let z=null;function ge(t,a){z=t;const i=document.getElementById("delete-client-name-placeholder");i&&(i.textContent=a),openModal("client-delete-confirmation")}async function Re(){const t=z;if(!t){alert("Error de Eliminación: ID del cliente no encontrada.");return}const{error:a}=await y.from("clientes").delete().eq("client_id",t);if(a){console.error("Error al intentar eliminar el cliente:",a),a.code==="23503"?alert("❌ ERROR: No se puede eliminar el cliente. Tiene ventas o abonos pendientes asociados. Asegúrate de eliminar el historial del cliente o configurar la eliminación en cascada en Supabase."):alert("❌ Error desconocido al eliminar cliente: "+a.message),closeModal("client-delete-confirmation");return}alert("✅ Cliente eliminado definitivamente."),closeModal("client-delete-confirmation"),z=null,await L()}var ie;(ie=document.getElementById("confirm-delete-client-btn"))==null||ie.addEventListener("click",Re);function ze(t){var i;const a=document.getElementById("abono-client-id-input");a&&(a.value=t),(i=document.getElementById("abono-client-form"))==null||i.reset(),openModal("modal-record-abono")}async function se(){const t=document.getElementById("report-month-selector"),a=document.getElementById("monthly-sales-report-body"),i=document.getElementById("report-total-sales"),e=document.getElementById("monthly-report-no-data");if(!a||!i||!e){console.error("Error: Contenedores de Reporte Mensual ausentes. (Carga diferida OK)");return}const n=t?t.value:null;let o,r;if(n){const[u,m]=n.split("-").map(Number);o=new Date(u,m-1,1),r=new Date(u,m,0),r.setHours(23,59,59,999)}else{const u=new Date;o=new Date(u.getFullYear(),u.getMonth(),1),r=new Date(u.getFullYear(),u.getMonth()+1,0),r.setHours(23,59,59,999)}const s=o.toISOString(),c=r.toISOString(),{data:l,error:d}=await y.from("ventas").select(`
            venta_id, 
            created_at, 
            client_id, 
            total_amount, 
            saldo_pendiente, 
            metodo_pago, 
            description
        `).gte("created_at",s).lte("created_at",c).order("created_at",{ascending:!1});if(d){console.error("Error al cargar reporte de ventas:",d.message),alert("Error al cargar reporte de ventas. Consulte la consola."),a.innerHTML="",i.textContent="$0.00",e.classList.remove("hidden");return}let p=0;a.innerHTML="",l&&l.length>0?(e.classList.add("hidden"),l.forEach(u=>{p+=u.total_amount;const m=new Date(u.created_at).toLocaleDateString("es-MX",{year:"numeric",month:"short",day:"numeric"}),b=de[u.client_id]||"N/A",g=a.insertRow();g.className="hover:bg-gray-50";const h=u.description||"-";g.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap">${u.venta_id}</td>
                <td class="px-3 py-3 whitespace-nowrap">${m}</td>
                <td class="px-3 py-3 whitespace-nowrap">${b}</td>
                <td class="px-3 py-3 whitespace-nowrap font-semibold">${w(u.total_amount)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-red-600">${w(u.saldo_pendiente)}</td>
                <td class="px-3 py-3 whitespace-nowrap">${u.metodo_pago}</td>
                
                <td class="px-3 py-3 text-sm truncate-cell">
                    <div class="truncate w-40" title="${h}">
                        ${h}
                    </div>
                </td>

              <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
        <button 
            data-venta-id="${u.venta_id}"  
            data-client-id="${u.client_id}"  class="view-sale-details-btn text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 rounded bg-indigo-100"
        >
            Detalles
        </button>
    </td>
            `})):e.classList.remove("hidden"),i.textContent=w(p)}function Ve(){const t=document.getElementById("report-month-selector");if(!t)return;t.innerHTML="";const a=new Date,i=a.getFullYear(),e=a.getMonth(),n=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];for(let o=0;o<12;o++){const r=new Date(i,e-o,1),s=r.getFullYear(),c=r.getMonth(),l=`${s}-${String(c+1).padStart(2,"0")}`,d=`${n[c]} ${s}`,p=document.createElement("option");p.value=l,p.textContent=d,o===0&&(p.selected=!0),t.appendChild(p)}}function ye(t){var l;const i=(d,p)=>{const u=w(p),m=32-d.length-u.length;return d+" ".repeat(m)+u},e=d=>{const p=32-d.length,u=Math.floor(p/2);return" ".repeat(u)+d};let n=e("Creativa Cortes CNC")+`
`;n+=`--------------------------------
`,n+=`
`,n+=e("Tel: 9851001141")+`
`,n+=e("Dirección: Calle 33 x 48 y 46")+`
`,n+=e("Col. Candelaria")+`
`,n+="Fecha: "+new Date(t.created_at).toLocaleDateString("es-MX")+`
`,n+="Venta: "+t.venta_id+`
`,n+=`--------------------------------
`;const o=((l=t.clientes)==null?void 0:l.name)||"Consumidor Final";n+="Cliente: "+o+`
`,n+=`================================
`,n+=`
`,n+=`Producto             Cant.  Total
`,n+=`--------------------------------
`,t.detalle_ventas.forEach(d=>{const u=d.productos.name.substring(0,18).padEnd(18," "),m=d.quantity.toString().padStart(5," "),b=w(d.subtotal).padStart(6," ");n+=`${u} ${m} ${b}
`}),n+=`--------------------------------
`,n+=`
`;const r=t.total_amount||0,s=t.saldo_pendiente||0,c=r-s;return n+=i("SALDO PENDIENTE:",s)+`
`,n+=i("ANTICIPO:",c)+`
`,n+=`================================
`,n+=i("TOTAL:",r)+`
`,n+=`================================
`,n+=`
`,n+=e("¡Gracias por su compra!")+`
`,n+=`
`,n+=`--------------------------------
`,n}let be=null;async function he(t){const{data:a,error:i}=await y.from("ventas").select("*, clientes(name), detalle_ventas (quantity, price, subtotal, productos(name))").eq("venta_id",t).single();if(i||!a)return;const n=`<pre style="font-family: monospace; font-size: 14px; margin: 0 auto; text-align: left;">${ye(a)}</pre>`,o=document.getElementById("ticket-preview-content");o&&(o.innerHTML=n),be=t,openModal("modal-ticket-preview")}window.showTicketPreviewModal=he;async function Je(t){const{data:a,error:i}=await y.from("ventas").select("*, clientes(name), detalle_ventas (quantity, price, subtotal, productos(name))").eq("venta_id",t).single();if(i||!a){console.error("Error al obtener datos para impresión:",i==null?void 0:i.message);return}const e=ye(a);if(!qz.websocket.isActive()){alert("QZ Tray no está conectado. Por favor, asegúrate de que esté corriendo y recarga la página.");return}try{const n=[{type:"raw",data:e},{type:"raw",data:"VA\0"}],o=qz.configs.create("Mi Impresora de Tickets",{encoding:"858"});await qz.print(o,n),console.log("Ticket enviado a la impresora correctamente.")}catch(n){alert("Error de impresión con QZ Tray. Revisa la consola para más detalles."),console.error(n)}}async function Ge(){const{data:t,error:a}=await y.from("clientes").select("client_id, name");if(a){console.error("Error al cargar datos de clientes para el mapa:",a);return}de=t.reduce((i,e)=>(i[e.client_id]=e.name,i),{})}async function Ze(){const t=document.getElementById("clients-list-body"),a=document.getElementById("clients-list-controls"),i=document.getElementById("toggle-clients-list"),e=document.getElementById("client-count-summary"),{data:n,error:o}=await y.from("clientes").select("client_id, name, phone").order("client_id",{ascending:!1});if(o){console.error("Error al cargar clientes:",o.message);return}t.innerHTML="";const r=10,s=n.length;let c=!1;if(n.forEach((l,d)=>{const p=!c&&d>=r,u=t.insertRow();u.className=p?"hidden":"hover:bg-gray-50",u.dataset.clientId=l.client_id,u.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${l.client_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">${l.name}</td>
            <td class="px-3 py-2 whitespace-nowrap">${l.phone||"-"}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button data-client-id="${l.client_id}" class="edit-client-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button data-client-id="${l.client_id}" class="delete-client-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `}),s>r){a.classList.remove("hidden"),e.textContent=`Mostrando ${r} de ${s} clientes.`;const l=()=>{c=!c,t.querySelectorAll("tr").forEach((p,u)=>{u>=r&&p.classList.toggle("hidden",!c)}),i.textContent=c?"Mostrar menos":`Mostrar los ${s-r} restantes`,e.textContent=c?`Mostrando todos (${s}) clientes.`:`Mostrando ${r} de ${s} clientes.`};i.onclick=l,l()}else a.classList.add("hidden")}async function q(){const t=document.getElementById("products-table-body");if(!t){console.error("Error: No se encontró el <tbody> con ID 'products-table-body'.");return}if(t.innerHTML="",I.length===0){t.innerHTML='<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay productos registrados.</td></tr>';return}I.forEach(a=>{let i="";if(a.type==="PACKAGE")if(a.parent_product){const r=I.find(s=>String(s.producto_id)===String(a.parent_product));i=r?`<span class="text-xs text-gray-500 ml-1">(Padre: ${r.name})</span>`:'<span class="text-xs text-red-500 ml-1">(ID Padre No Válida/Eliminada)</span>'}else i='<span class="text-xs text-red-500 ml-1">(Sin Padre Asociado)</span>';const e=a.type==="PACKAGE"?"Paquete/Servicio":"Producto Individual",n=a.price?parseFloat(a.price).toFixed(2):"0.00",o=t.insertRow();o.className="hover:bg-gray-50",o.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${a.producto_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">
                ${a.name} ${i}
            </td>
            <td class="px-3 py-2 whitespace-nowrap">${e}</td>
            <td class="px-3 py-2 whitespace-nowrap">$${n}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button data-product-id="${a.producto_id}" class="edit-product-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button data-product-id="${a.producto_id}" class="delete-product-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `})}document.addEventListener("DOMContentLoaded",async()=>{var a,i,e,n,o,r,s,c,l,d,p,u,m,b,g,h,_,S,x,E,P,D,K,Q,W,j,Y,X,ee,te;if(window.supabase)y=window.supabase.createClient(ce,le);else{console.error("Error Fatal: Librería Supabase no encontrada. La aplicación no funcionará.");return}V(),await A(),await Ge(),(a=document.getElementById("open-sale-modal-btn"))==null||a.addEventListener("click",async()=>{}),document.querySelectorAll("[data-close-modal]").forEach(f=>{}),(i=document.getElementById("open-sale-modal-btn"))==null||i.addEventListener("click",async()=>{var f;try{(f=document.getElementById("new-sale-form"))==null||f.reset(),await ue(),await A(),U(),C=[],F(),document.getElementById("total-amount").value="0.00",document.getElementById("paid-amount").value="0.00",document.getElementById("remaining-balance").value="0.00",openModal("new-sale-modal")}catch(v){console.error("Error al cargar datos del modal de venta:",v),alert("Error al cargar los datos. Revise la consola (F12).")}}),document.querySelectorAll("[data-close-modal]").forEach(f=>{f.addEventListener("click",v=>{v.preventDefault();const k=f.getAttribute("data-close-modal");closeModal(k)})}),(e=document.getElementById("new-sale-form"))==null||e.addEventListener("submit",Te),(n=document.getElementById("paid-amount"))==null||n.addEventListener("input",()=>R()),(o=document.getElementById("payment-method"))==null||o.addEventListener("change",()=>R()),(r=document.getElementById("add-product-btn"))==null||r.addEventListener("click",Pe),Ve(),U(),(s=document.getElementById("report-month-selector"))==null||s.addEventListener("change",se),(c=document.getElementById("login-form"))==null||c.addEventListener("submit",Ie),(l=document.getElementById("logout-btn"))==null||l.addEventListener("click",Ce),(d=document.getElementById("sales-month-filter"))==null||d.addEventListener("change",()=>{L()}),(p=document.getElementById("reset-sales-filter"))==null||p.addEventListener("click",()=>{const f=document.getElementById("sales-month-filter");f&&(f.value=""),L()}),(u=document.getElementById("print-ticket-btn"))==null||u.addEventListener("click",()=>{Je(be)}),(m=document.getElementById("open-monthly-report-btn"))==null||m.addEventListener("click",()=>{se(),openModal("modal-monthly-report")}),(b=document.getElementById("admin-clients-btn"))==null||b.addEventListener("click",async()=>{openModal("modal-admin-clients"),await B("gestion")});const t=document.getElementById("modal-monthly-report");t==null||t.addEventListener("click",f=>{if(f.target.classList.contains("view-sale-details-btn")){const v=f.target.getAttribute("data-venta-id"),k=f.target.getAttribute("data-client-id");me(v,k)}}),(g=document.getElementById("open-register-client-modal-btn"))==null||g.addEventListener("click",()=>{document.getElementById("client-modal-title").textContent="Registrar Nuevo Cliente";const f=document.getElementById("new-client-form");f==null||f.reset(),f==null||f.removeEventListener("submit",re),f==null||f.addEventListener("submit",oe),openModal("modal-register-client")}),(h=document.getElementById("new-client-form"))==null||h.addEventListener("submit",oe),(_=document.getElementById("post-sale-price-form"))==null||_.addEventListener("submit",async f=>{f.preventDefault();const v=document.getElementById("edit-venta-id").value,k=document.getElementById("edit-detalle-venta-id").value,ve=document.getElementById("edit-client-id").value,Ee=parseFloat(document.getElementById("new-unit-price").value);await Be(v,k,ve,Ee),closeModal("modal-edit-sale-item")}),(S=document.getElementById("open-admin-products-modal"))==null||S.addEventListener("click",async()=>{try{await A(),await q(),openModal("admin-products-modal")}catch(f){console.error("Error al cargar la administración de productos:",f),alert("Error al cargar la lista de productos.")}}),(x=document.getElementById("open-product-modal-btn"))==null||x.addEventListener("click",()=>{var f;closeModal("admin-products-modal"),(f=document.getElementById("new-product-form"))==null||f.reset(),ae(),openModal("modal-register-product")}),(E=document.getElementById("new-product-type"))==null||E.addEventListener("change",f=>{ae(),f.target.value==="PACKAGE"&&pe("parent-product-select")}),(P=document.getElementById("new-product-form"))==null||P.addEventListener("submit",He),(D=document.getElementById("products-table-body"))==null||D.addEventListener("click",f=>{if(!f.target.hasAttribute("data-product-id"))return;const v=f.target.getAttribute("data-product-id");f.target.classList.contains("edit-product-btn")&&(f.preventDefault(),Oe(v)),f.target.classList.contains("delete-product-btn")&&(f.preventDefault(),qe(v))}),(K=document.getElementById("clients-list-body"))==null||K.addEventListener("click",async f=>{const v=f.target.closest("button");if(v){f.preventDefault();const k=v.getAttribute("data-client-id");v.classList.contains("edit-client-btn")&&await fe(k),v.classList.contains("delete-client-btn")&&ge(k),v.classList.contains("view-debt-btn")&&await O(k)}}),(Q=document.getElementById("edit-client-form"))==null||Q.addEventListener("submit",re),(W=document.getElementById("open-abono-from-report-btn"))==null||W.addEventListener("click",()=>{closeModal("modal-client-debt-report"),ze(G)}),document.addEventListener("click",f=>{document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(k=>{f.target===k&&closeModal(k.id)})}),document.querySelectorAll("[data-open-modal]").forEach(f=>{f.addEventListener("click",v=>{v.preventDefault();const k=f.getAttribute("data-open-modal");openModal(k)})}),(j=document.getElementById("confirm-delete-btn"))==null||j.addEventListener("click",Ue),(Y=document.getElementById("edit-product-form"))==null||Y.addEventListener("submit",Ne),(X=document.getElementById("product-main-select"))==null||X.addEventListener("change",Le),(ee=document.getElementById("subproduct-select"))==null||ee.addEventListener("change",f=>{J(f.target.value)}),(te=document.getElementById("abono-client-form"))==null||te.addEventListener("submit",Me),document.addEventListener("keydown",f=>{if(f.key==="Escape"){const v=document.querySelectorAll(".modal-overlay:not(.hidden)"),k=v[v.length-1];k&&closeModal(k.id)}})})});export default Ke();
