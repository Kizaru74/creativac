import{createClient as O}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.0/+esm";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function a(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=a(n);fetch(n.href,o)}})();const T="https://wnwftbamyaotqdsivmas.supabase.co",H="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo",d=O(T,H),_=document.getElementById("auth-modal"),P=document.getElementById("app-container"),U=document.getElementById("login-form"),k=document.getElementById("add-sale-form"),M=document.getElementById("update-debt-form");document.getElementById("profile-update-form");const j=document.getElementById("addSaleBtn"),J=document.getElementById("logoutBtn"),K=document.getElementById("addProductAdminBtn"),l=document.getElementById("add-sale-modal"),v=document.getElementById("update-debt-modal"),h=document.getElementById("product-admin-modal");document.getElementById("user-profile-modal");const D=document.getElementById("product-package-modal"),g=document.getElementById("debtListBody"),E=document.getElementById("salesListBody"),N=document.getElementById("totalSalesDisplay"),C=document.getElementById("totalDebtDisplay"),F=document.getElementById("debtorCountDisplay"),p=$("#base-product-id"),i=$("#subcategory-id"),A=document.getElementById("main-products-content"),S=document.getElementById("add-main-product-form"),Y=document.getElementById("package-main-product-name"),y=document.getElementById("add-package-form"),x=document.getElementById("packages-list-body");let b=null;function m(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(t)}function w(t){t?(_.classList.add("hidden"),P.classList.remove("hidden"),g.innerHTML===""&&L()):(_.classList.remove("hidden"),P.classList.add("hidden"),g.innerHTML="",E.innerHTML="",N.textContent="...",C.textContent="...",F.textContent="...")}function c(t,e){console.error(`Error en ${t}:`,e),alert(`Error al ${t}: ${e.message||e}`)}async function z({clientName:t,amount:e,baseProductId:a,subcategoryId:r,description:n}){const o=parseFloat(e);try{const{error:s}=await d.rpc("update_client_debt",{p_client_name:t,p_amount:o,p_main_product_id:parseInt(a),p_package_id:parseInt(r),p_description:n});if(s)throw new Error(`Error al procesar venta: ${s.message}`);alert(`Venta registrada con éxito. Se sumaron ${m(o)} a la deuda de ${t}.`),L(),l.classList.add("hidden")}catch(s){c("registrar venta",s)}}function R(){d.auth.getSession().then(({data:{session:t}})=>{w(!!t)}),U.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("login-identifier").value,a=document.getElementById("login-password").value;try{const{error:r}=await d.auth.signInWithPassword({email:e,password:a});if(r){alert(`Error de autenticación: ${r.message}. Asegúrate de que las credenciales sean correctas.`);return}w(!0)}catch(r){c("autenticar",r)}}),J.addEventListener("click",async()=>{try{await d.auth.signOut(),w(!1),window.location.reload()}catch(t){c("cerrar sesión",t)}})}async function L(){await Promise.all([V(),G(),Z(),u()])}async function V(){var t,e,a;try{const{data:r,error:n}=await d.rpc("get_total_sales"),{data:o,error:s}=await d.rpc("get_total_debt"),{data:q,error:f}=await d.rpc("get_debtor_count");if(n||s||f)throw new Error((n==null?void 0:n.message)||(s==null?void 0:s.message)||(f==null?void 0:f.message));N.textContent=m(((t=r[0])==null?void 0:t.total_sales)||0),C.textContent=m(((e=o[0])==null?void 0:e.total_debt)||0),F.textContent=(((a=q[0])==null?void 0:a.debtor_count)||0).toString()}catch(r){c("cargar resumen",r)}}async function G(){try{const{data:t,error:e}=await d.from("clientes").select("id, name, debt, last_update").gt("debt",0).order("debt",{ascending:!1}).limit(5);if(e)throw e;g.innerHTML=t.map(a=>`
            <tr class="hover:bg-gray-50">
                <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.name}</td> 
                <td class="p-4 whitespace-nowrap text-sm font-bold text-red-600">${m(a.debt)}</td> 
                <td class="p-4 whitespace-nowrap text-sm text-gray-500">${new Date(a.last_update).toLocaleDateString()}</td>
                <td class="p-4 whitespace-nowrap text-sm">
                    <button data-client-id="${a.id}" class="open-update-debt-modal text-indigo-600 hover:text-indigo-900">
                        Registrar Abono
                    </button>
                </td>
            </tr>
        `).join("")}catch(t){c("cargar deudas",t),g.innerHTML='<tr><td colspan="4" class="p-4 text-center text-red-500">Error al cargar deudas.</td></tr>'}}async function Z(){try{const{data:t,error:e}=await d.from("transacciones_detalle_view").select(`
                client_name, 
                amount, 
                created_at,
                main_product_name,
                package_name
            `).order("created_at",{ascending:!1}).limit(10);if(e)throw e;E.innerHTML=t.map(a=>`
            <tr class="hover:bg-gray-50">
                <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.client_name}</td>
                <td class="p-4 whitespace-nowrap text-sm text-green-600">${m(a.amount)}</td>
                <td class="p-4 text-sm text-gray-500 product-cell" title="${a.main_product_name} / ${a.package_name||""}">
                    ${a.main_product_name||"N/A"} / ${a.package_name||"N/A"}
                </td>
                <td class="p-4 whitespace-nowrap text-sm text-gray-500">${new Date(a.created_at).toLocaleDateString()}</td>
                <td class="p-4 whitespace-nowrap text-sm">
                    <span class="text-gray-400">Detalle</span>
                </td>
            </tr>
        `).join("")}catch(t){c("cargar ventas recientes",t),E.innerHTML='<tr><td colspan="5" class="p-4 text-center text-red-500">Error al cargar ventas recientes. Asegúrate de que la tabla/vista "transacciones_detalle_view" exista.</td></tr>'}}async function u(){try{const{data:t,error:e}=await d.from("productos").select("id, name").eq("type","MAIN").order("name");if(e)throw e;p.empty().append('<option value="">-- Seleccionar Producto Base --</option>'),t.forEach(a=>{p.append(new Option(a.name,a.id))}),p.on("change",async function(){const a=$(this).val();if(i.empty().prop("disabled",!0).select2("destroy").val("").select2(),a){const{data:r,error:n}=await d.from("productos").select("id, name").eq("type","PACKAGE").eq("parent_product",a).order("name");if(n)throw n;i.append('<option value="">-- Seleccionar Subcategoría --</option>'),r.forEach(o=>{i.append(new Option(o.name,o.id))}),i.prop("disabled",!1).select2("destroy").select2({width:"100%",dropdownParent:l})}}).select2({width:"100%",dropdownParent:l}),i.select2({width:"100%",dropdownParent:l}).prop("disabled",!0)}catch(t){c("poblar selectores de productos",t)}}async function I(){try{const{data:t,error:e}=await d.from("productos").select("id, name, description").eq("type","MAIN").order("name");if(e)throw e;A.innerHTML=Q(t,"MAIN"),X()}catch(t){c("cargar productos principales",t),A.innerHTML='<p class="text-red-500">Error al cargar productos principales.</p>'}}function Q(t,e){if(!t||t.length===0)return'<p class="text-gray-500 p-4">No hay productos registrados.</p>';let a=`
    <div class="border border-gray-200 rounded-lg max-h-96 overflow-y-auto"> 
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10"> 
                <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
    `;return a+=t.map(r=>`
        <tr class="hover:bg-gray-50">
            <td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${r.name}</td>
            <td class="p-3 text-sm text-gray-500 truncate max-w-xs">${r.description||"N/A"}</td>
            <td class="p-3 whitespace-nowrap text-sm font-medium space-x-2">
                <button data-main-id="${r.id}" data-main-name="${r.name}" 
                        class="view-packages-btn text-blue-600 hover:text-blue-900 text-sm">
                    Ver Subcategorías
                </button>
                <button data-category-id="${r.id}" 
                        class="delete-category-btn text-red-600 hover:text-red-900 text-sm">
                    Eliminar
                </button>
            </td>
        </tr>
    `).join(""),a+="</tbody></table></div>",a}function W(){K.addEventListener("click",()=>{h.classList.remove("hidden"),I()}),document.getElementById("close-product-admin-modal").addEventListener("click",()=>{h.classList.add("hidden")}),S.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("new-main-name").value.trim(),a=document.getElementById("new-main-description").value;try{const{error:r}=await d.from("productos").insert([{name:e,description:a,type:"MAIN",parent_product:null}]);if(r)throw r;alert(`Producto Principal "${e}" creado con éxito.`),S.reset(),I(),u()}catch(r){c("crear producto principal",r)}})}function X(){document.querySelectorAll(".delete-category-btn").forEach(t=>{t.addEventListener("click",async e=>{const a=e.target.dataset.categoryId;if(confirm("¿Está seguro de eliminar este Producto Principal? Esto eliminará también sus subcategorías."))try{const{error:r}=await d.from("productos").delete().eq("id",a);if(r)throw r;alert("Producto Principal eliminado con éxito."),I(),u()}catch(r){c("eliminar producto principal",r)}})}),document.querySelectorAll(".view-packages-btn").forEach(t=>{t.addEventListener("click",e=>{const a=e.target.dataset.mainId,r=e.target.dataset.mainName;tt(a,r)})})}function tt(t,e){Y.textContent=e,y.dataset.mainId=t,h.classList.add("hidden"),D.classList.remove("hidden"),B(t)}function et(){D.classList.add("hidden"),h.classList.remove("hidden"),y.reset()}document.getElementById("close-product-package-modal").addEventListener("click",et);async function B(t){try{const{data:e,error:a}=await d.from("productos").select("id, name, description").eq("type","PACKAGE").eq("parent_product",t).order("name");if(a)throw a;at(e),rt()}catch(e){c("cargar subcategorías",e),x.innerHTML='<tr><td colspan="3" class="p-4 text-center text-red-500">Error al cargar subcategorías.</td></tr>'}}function at(t){if(!t||t.length===0){x.innerHTML='<tr><td colspan="3" class="p-4 text-center text-gray-500">No hay subcategorías registradas para este producto.</td></tr>';return}x.innerHTML=t.map(e=>`
        <tr class="hover:bg-gray-50">
            <td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${e.name}</td>
            <td class="p-3 text-sm text-gray-500 truncate max-w-xs">${e.description||"N/A"}</td>
            <td class="p-3 whitespace-nowrap text-sm font-medium">
                <button data-package-id="${e.id}" 
                        class="delete-package-btn text-red-600 hover:text-red-900 text-sm">
                    Eliminar
                </button>
            </td>
        </tr>
    `).join("")}function rt(){document.querySelectorAll(".delete-package-btn").forEach(t=>{t.addEventListener("click",async e=>{const a=e.target.dataset.packageId,r=y.dataset.mainId;if(confirm("¿Está seguro de eliminar esta Subcategoría?"))try{const{error:n}=await d.from("productos").delete().eq("id",a);if(n)throw n;alert("Subcategoría eliminada con éxito."),B(r),u()}catch(n){c("eliminar subcategoría",n)}})})}y.addEventListener("submit",async t=>{t.preventDefault();const e=t.target.dataset.mainId,a=document.getElementById("new-package-name").value.trim(),r=document.getElementById("new-package-description").value;if(!e){alert("Error: No se pudo obtener el ID del producto principal.");return}try{const{error:n}=await d.from("productos").insert([{name:a,description:r,type:"PACKAGE",parent_product:parseInt(e)}]);if(n)throw n;alert(`Subcategoría "${a}" creada con éxito.`),y.reset(),B(e),u()}catch(n){c("crear subcategoría",n)}});j.addEventListener("click",()=>{l.classList.remove("hidden"),u()});document.getElementById("close-add-sale-modal").addEventListener("click",()=>{l.classList.add("hidden"),k.reset(),p.select2("destroy").val("").select2(),i.select2("destroy").val("").select2()});g.addEventListener("click",t=>{t.target.classList.contains("open-update-debt-modal")&&(b=t.target.dataset.clientId,document.getElementById("debt-client-display").textContent=t.target.closest("tr").querySelector("td").textContent,v.classList.remove("hidden"))});document.getElementById("close-update-debt-modal").addEventListener("click",()=>{v.classList.add("hidden"),M.reset(),b=null});k.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("sale-client-name").value,a=document.getElementById("sale-amount").value,r=p.val(),n=i.val(),o=document.getElementById("sale-description").value;if(!r||!n){alert("Por favor, selecciona tanto el Producto Principal como la Subcategoría.");return}await z({clientName:e,amount:a,baseProductId:r,subcategoryId:n,description:o})});M.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("debt-payment-amount").value;if(!b||!e){alert("Faltan datos de cliente o monto de abono.");return}try{const{error:a}=await d.rpc("register_payment",{p_client_id:parseInt(b),p_amount:parseFloat(e)});if(a)throw a;alert(`Abono de ${m(e)} registrado con éxito.`),L(),v.classList.add("hidden")}catch(a){c("registrar abono",a)}});document.addEventListener("DOMContentLoaded",()=>{R(),W()});
