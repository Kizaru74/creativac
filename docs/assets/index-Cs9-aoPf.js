(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const Ie="https://wnwftbamyaotqdsivmas.supabase.co",xe="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo";let c,L=[],_=[],V=null,P=null,G=[],j=!1;window.supabase?c=window.supabase.createClient(Ie,xe):(console.error("Error Fatal: Librer√≠a Supabase no encontrada. La aplicaci√≥n no funcionar√°."),c=null);window.loadDashboardMetrics=async function(){if(!c){console.error("Supabase no est√° inicializado para cargar m√©tricas.");return}try{const{data:t,error:e}=await c.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",.01);if(e)throw e;let n=0;t&&t.length>0&&(n=t.reduce((i,s)=>i+parseFloat(s.saldo_pendiente||0),0));const{data:o,error:a}=await c.from("ventas").select("total_amount").not("total_amount","is",null);if(a)throw a;let r=0;o&&o.length>0&&(r=o.reduce((i,s)=>i+parseFloat(s.total_amount||0),0));const l=document.getElementById("total-debt");l&&(l.textContent=g(n));const d=document.getElementById("historical-total-sales");d&&(d.textContent=g(r))}catch(t){console.error("Error al cargar m√©tricas del dashboard:",t)}};function g(t){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(t)}function F(t){const e={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(t).toLocaleDateString("es-MX",e)}window.openModal=function(t){var n;const e=document.getElementById(t);e?(e.classList.add("flex"),e.classList.remove("hidden"),(n=e.querySelector("input, select, textarea"))==null||n.focus()):console.error(`Error: No se encontr√≥ el modal con ID: ${t}`)};window.closeModal=function(t){const e=document.getElementById(t);e&&(e.classList.add("hidden"),e.classList.remove("flex"))};async function J(){const{data:{user:t}}=await c.auth.getUser(),e=document.getElementById("auth-container"),n=document.getElementById("dashboard-container");if(!e||!n){console.error("Error: Los contenedores 'auth-container' o 'dashboard-container' no se encontraron en el HTML.");return}t?(e.classList.add("hidden"),n.classList.remove("hidden"),await M()):(e.classList.remove("hidden"),n.classList.add("hidden"))}async function _e(t){t.preventDefault();const e=document.getElementById("email").value,n=document.getElementById("password").value,{error:o}=await c.auth.signInWithPassword({email:e,password:n});o?alert(o.message):J()}async function Le(){await c.auth.signOut(),J()}async function De(){try{const{data:t,error:e}=await c.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name, client_id)").gt("saldo_pendiente",.01).order("created_at",{ascending:!1}).limit(5);if(e){console.error("Error al cargar tabla de deudas:",e);return}const n=document.getElementById("debt-sales-body");if(!n)return;n.innerHTML="";const o=document.getElementById("no-debt-message");if(o&&o.classList.add("hidden"),t.length===0){o&&o.classList.remove("hidden");return}t.forEach(a=>{var i,s;const r=((i=a.clientes)==null?void 0:i.name)||"Cliente Desconocido",l=(s=a.clientes)==null?void 0:s.client_id,d=document.createElement("tr");d.className="hover:bg-gray-50",d.innerHTML=`
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.venta_id}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${r}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-red-600">${g(a.saldo_pendiente)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                        type="button" 
                        class="view-debt-btn" 
                        data-client-id="${l}" 
                        data-sale-id="${a.venta_id}" // Si necesitas la venta, mantenla
            class="view-debt-btn bg-red-600 hover:bg-red-700 text-white font-semibold text-xs py-1 px-2 rounded"
                    >
                        Detalles/Pagar
                    </button>
                </td>
            `,n.appendChild(d)}),n.querySelectorAll(".view-debt-btn").forEach(a=>{a.addEventListener("click",()=>{const r=a.dataset.clientId;handleViewClientDebt(r)})})}catch(t){console.error("Error inesperado en loadDebts:",t)}}async function Ce(){try{const{data:t,error:e}=await c.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name, client_id), description").order("created_at",{ascending:!1}).limit(7);if(e){console.error("Error al cargar ventas recientes:",e);return}const n=document.getElementById("recent-sales-body"),o=document.getElementById("no-sales-message");if(!n)return;if(n.innerHTML="",o&&o.classList.add("hidden"),t.length===0){o&&o.classList.remove("hidden");return}t.forEach(a=>{var i,s;const r=((i=a.clientes)==null?void 0:i.name)||"Cliente Desconocido",l=(s=a.clientes)==null?void 0:s.client_id,d=document.createElement("tr");d.className="hover:bg-gray-50",d.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.venta_id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${r}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${F(a.created_at)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${g(a.total_amount)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${a.saldo_pendiente>0?"text-red-600":"text-green-600"}">${g(a.saldo_pendiente)}</td>
                
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"> 
                    <button type="button" 
                            class="view-sale-details-btn text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 rounded bg-indigo-100"
                            data-sale-id="${a.venta_id}"
                            data-client-id="${l}"> 
                        Detalles
                    </button>
                </td>
            `,n.appendChild(d)}),n.querySelectorAll(".view-sale-details-btn").forEach(a=>{a.addEventListener("click",()=>{const r=a.dataset.saleId,l=a.dataset.clientId;handleViewSaleDetails(r,l)})})}catch(t){console.error("Error inesperado en loadRecentSales:",t)}}async function M(){await De(),await Ce(),await T("gestion"),await $(),await qe(),await ue(),await loadClientDebtsTable()}async function ue(){const t=document.getElementById("client-select");if(!t)return;t.innerHTML='<option value="" disabled selected>Cargando clientes...</option>';const{data:e,error:n}=await c.from("clientes").select("client_id, name").order("name",{ascending:!0});if(n){console.error("Error al cargar clientes para venta:",n),t.innerHTML='<option value="" disabled selected>Error al cargar (revisar consola)</option>';return}if(e.length===0){t.innerHTML='<option value="" disabled selected>No hay clientes activos</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione un Cliente</option>',e.forEach(o=>{const a=document.createElement("option");a.value=o.client_id,a.textContent=o.name,t.appendChild(a)})}async function $(){if(!c){console.warn("Supabase no inicializado. No se pudieron cargar los productos.");return}const{data:t,error:e}=await c.from("productos").select("producto_id, name, type, price, parent_product");if(e){console.error("Error al cargar todos los productos:",e),L=[],window.allProductsMap={};return}L=t||[],window.allProductsMap=L.reduce((n,o)=>(n[o.producto_id]=o,n),{}),console.log(`‚úÖ Mapa de productos cargado: ${Object.keys(window.allProductsMap).length} √≠tems.`)}function Be(){const t=document.getElementById("product-main-select"),e=document.getElementById("subproduct-select"),n=document.getElementById("product-unit-price");if(!t||!e||!n||typeof L>"u")return;const o=t.value;if(e.innerHTML='<option value="" selected>Sin Paquete</option>',e.disabled=!0,n.value="0.00",!o)return;if(!L.find(l=>String(l.producto_id)===String(o))){console.warn(`Producto principal con ID ${o} no encontrado.`);return}X(o);const r=L.filter(l=>l.type&&l.type.trim().toUpperCase()==="PACKAGE"&&l.parent_product&&String(l.parent_product)===String(o));r.length>0&&(e.disabled=!1,e.innerHTML='<option value="" disabled selected>Seleccione un Paquete</option>',r.forEach(l=>{const d=document.createElement("option");d.value=l.producto_id;const i=typeof g=="function"?g(l.price):`$${l.price.toFixed(2)}`;d.textContent=`${l.name} (${i})`,e.appendChild(d)}))}async function me(){const t=document.getElementById("product-main-select"),e=document.getElementById("subproduct-select"),n=document.getElementById("product-unit-price");if(!t||!e||!n)return;const o=L.filter(a=>a.type&&a.type.trim().toUpperCase()==="MAIN");if(e.innerHTML='<option value="" selected>Sin Paquete</option>',n.value="0.00",e.disabled=!0,o.length===0){t.innerHTML='<option value="" disabled selected>‚ùå No hay Productos Base (Tipo: MAIN)</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione Producto Base</option>',o.forEach(a=>{const r=document.createElement("option");r.value=a.producto_id,r.textContent=`${a.name}`,t.appendChild(r)})}async function pe(t){const e=document.getElementById(t);if(!e)return;const n=L.filter(o=>o.type&&o.type.trim().toUpperCase()==="MAIN");if(e.innerHTML='<option value="" disabled selected>Seleccione Producto Principal</option>',n.length===0){e.innerHTML='<option value="" disabled selected>‚ùå No hay Productos Base (Tipo: MAIN)</option>';return}n.forEach(o=>{const a=document.createElement("option");a.value=o.producto_id,a.textContent=`${o.name} ($${o.price.toFixed(2)})`,e.appendChild(a)})}function X(t){const e=document.getElementById("product-unit-price"),n=L.find(o=>String(o.producto_id)===String(t));e&&(n&&n.price!==void 0?e.value=n.price.toFixed(2):e.value="0.00")}function q(t){let e=t;if(typeof e!="number"||isNaN(e)){const s=document.getElementById("total-amount"),m=le(s==null?void 0:s.value);e=parseFloat(m)||0}const n=document.getElementById("paid-amount"),o=document.getElementById("display-saldo-pendiente"),a=document.getElementById("payment-method");if(!n||!a||!o)return;const r=a.value;let l=le(n.value),d=parseFloat(l)||0;n.value.trim()===""&&(n.value="0.00"),r==="Deuda"&&(d=0);let i=e-d;e<=0&&(i=0),o.value=g(i),o.classList.remove("bg-red-100","bg-green-100","text-red-700","text-green-700"),i>0?o.classList.add("bg-red-100","text-red-700"):o.classList.add("bg-green-100","text-green-700")}function R(){const t=_.reduce((o,a)=>o+a.subtotal,0);console.log("Grand Total calculado:",t);const e=document.getElementById("total-amount");e&&(e.value=t.toFixed(2)),q(t);const n=document.getElementById("submit-sale-btn");return _.length>0?n==null||n.removeAttribute("disabled"):n==null||n.setAttribute("disabled","true"),t}function K(){const t=document.getElementById("sale-items-table-body");if(!t){console.error("Error FATAL: Elemento 'sale-items-table-body' no encontrado en el DOM.");return}let e="";_.length===0?e='<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500 italic">Agrega productos a la venta.</td></tr>':_.forEach((n,o)=>{let a=n.name;!n.name.includes("(")&&n.type&&n.type.trim().toUpperCase()!=="MAIN"&&(a=`${n.name} (${n.type})`),e+=`
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${a}</td>
                    
                    <td class="px-4 py-2 text-sm text-gray-500 text-center">${n.quantity}</td> 
                    
                    <td class="px-4 py-2 text-sm text-gray-500 cursor-pointer hover:bg-yellow-100 transition-colors"
                        id="price-${o}"
                        onclick="promptEditItemPrice(${o}, ${n.price})">
                        ${g(n.price)}
                    </td>
                    
                    <td class="px-4 py-2 text-sm font-bold">${g(n.subtotal)}</td>
                    <td class="px-4 py-2 text-right text-sm font-medium">
                        <button type="button" onclick="removeItemFromSale(${o})" 
                                class="text-red-600 hover:text-red-900">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </td>
                </tr>
            `}),t.innerHTML=e,R()}window.removeItemFromSale=function(t){if(t<0||t>=_.length){console.error("√çndice de √≠tem de venta inv√°lido para eliminar.");return}confirm(`¬øEst√°s seguro de que quieres eliminar "${_[t].name}" de la venta?`)&&(_.splice(t,1),K(),R())};function Se(t){t.preventDefault();const e=document.getElementById("product-main-select"),n=document.getElementById("subproduct-select"),o=document.getElementById("product-quantity"),a=document.getElementById("product-unit-price"),r=32,l=e==null?void 0:e.value,d=n==null?void 0:n.value,i=parseFloat(o==null?void 0:o.value);let s=d;s||(s=l);const m=String(s);let u=L.find(E=>String(E.producto_id)===m);const y=a==null?void 0:a.value;let w=parseFloat(y==null?void 0:y.replace(",","."))||0;if(w===0&&u&&(w=u.price||0),!u&&(parseInt(m,10)===0||!m)&&w===0&&(u={producto_id:r,name:"Servicio Manual / $0.00",price:0,type:"MANUAL"},s=r),!u){alert("Por favor, selecciona un Producto o Paquete v√°lido.");return}if(isNaN(i)||i<=0){alert("La cantidad debe ser mayor a cero.");return}const h=i*w;let v=u.name;if(d){const E=L.find(I=>String(I.producto_id)===String(l));E&&(v=`${E.name} (${u.name})`)}else u.type&&u.type.trim().toUpperCase()!=="MAIN"&&(v=`${u.name} (${u.type})`);const x={product_id:parseInt(s,10),name:v,quantity:i,price:w,subtotal:h,type:u.type||null},D=parseInt(s,10),C=_.findIndex(E=>E.product_id===D);C>-1?(_[C].quantity+=i,_[C].subtotal+=h):_.push(x),K(),R(),e.value="",n.value="",o.value="1",X(null),me()}async function Me(t,e,n,o){if(!c||isNaN(o)||o<=0){alert("El precio debe ser un monto positivo.");return}try{const{data:a,error:r}=await c.from("detalle_ventas").select("quantity").eq("id",e).single();if(r||!a)throw new Error("No se pudo obtener el detalle del √≠tem.");const d=a.quantity*o,{error:i}=await c.from("detalle_ventas").update({price:o,subtotal:d}).eq("id",e);if(i)throw i;const{data:s,error:m}=await c.from("detalle_ventas").select("subtotal").eq("venta_id",t);if(m||!s)throw m;const u=s.reduce((h,v)=>h+v.subtotal,0),y=u,{error:w}=await c.from("ventas").update({total_amount:u,saldo_pendiente:y}).eq("venta_id",t);if(w)throw w;alert(`‚úÖ Deuda de ${g(y)} registrada exitosamente.`),await T("gestion"),await handleViewClientDebt(n)}catch(a){console.error("Error al actualizar precio post-venta:",a),alert(`Error al actualizar la venta: ${a.message}`)}}function le(t){return typeof t!="string"?0:t.replace(/[^\d.-]/g,"")}async function $e(t){if(!c)return{totalVentas:0,deudaNeta:0};try{const{data:e,error:n}=await c.from("transacciones_deuda").select("type, amount").eq("client_id",t);if(n)throw n;let o=0,a=0;return e.forEach(r=>{r.type==="cargo_venta"?(o+=r.amount,a+=r.amount):a-=r.amount}),a=Math.max(0,a),{totalVentas:o,deudaNeta:a}}catch(e){return console.error(`Error al obtener resumen del cliente ${t}:`,e),{totalVentas:0,deudaNeta:0}}}async function Ae(t){var l;if(t.preventDefault(),!c)return;const e=parseFloat(document.getElementById("abono-amount").value),n=(l=document.getElementById("abono-method"))==null?void 0:l.value;if(isNaN(e)||e<=0){alert("Por favor, ingresa un monto v√°lido para el abono (mayor a cero).");return}if(!n||n===""){alert("Por favor, selecciona un M√©todo de Pago.");return}const o=window.allClientsMap[P]!==void 0;let a=[],r=null;if(o){const d=P;r=d;const{data:i,error:s}=await c.from("ventas").select("venta_id, saldo_pendiente, client_id, created_at").eq("client_id",d).gt("saldo_pendiente",.01).order("created_at",{ascending:!0});if(s){console.error("Error al buscar ventas pendientes:",s),alert("Error al buscar ventas pendientes para abonar.");return}if(i.length===0){alert("El cliente no tiene ventas pendientes para abonar.");return}let m=e;for(const u of i){if(m<=0)break;const y=u.saldo_pendiente,w=Math.min(m,y);a.push({venta_id:u.venta_id,client_id:u.client_id,amount:w,new_saldo_pendiente:y-w}),m-=w}}else{const d=P,{data:i,error:s}=await c.from("ventas").select("saldo_pendiente, client_id").eq("venta_id",d).single();if(s||!i){alert("Error al obtener la venta para abonar.");return}if(e>i.saldo_pendiente){alert(`El abono excede el saldo pendiente (${g(i.saldo_pendiente)}). Ajuste el monto.`);return}r=i.client_id,a.push({venta_id:d,client_id:i.client_id,amount:e,new_saldo_pendiente:i.saldo_pendiente-e})}try{for(const i of a){const{error:s}=await c.from("pagos").insert([{venta_id:i.venta_id,client_id:i.client_id,amount:i.amount,metodo_pago:n}]);if(s)throw s;const{error:m}=await c.from("ventas").update({saldo_pendiente:i.new_saldo_pendiente}).eq("venta_id",i.venta_id);if(m)throw m}alert(`¬°Abono de ${g(e)} registrado con √©xito!`),document.getElementById("abono-client-form").reset(),closeModal("modal-record-abono");const d=document.getElementById("modal-client-debt-report");d&&!d.classList.contains("hidden")&&r&&await handleViewClientDebt(r),await M(),await T("gestion")}catch(d){console.error("Error al registrar abono:",d.message||d),alert("Hubo un error al registrar el abono. Intente nuevamente.")}P=null}async function fe(t){var m,u,y,w;t.preventDefault();const e=((m=document.getElementById("client-select"))==null?void 0:m.value)??null,n=((u=document.getElementById("payment-method"))==null?void 0:u.value)??"Efectivo",o=((y=document.getElementById("sale-description"))==null?void 0:y.value.trim())??null,a=((w=document.getElementById("paid-amount"))==null?void 0:w.value.replace(/[^\d.-]/g,""))??"0";let r=parseFloat(a);const l=_.reduce((h,v)=>h+v.subtotal,0);n==="Deuda"&&(r=0);let d=r,i=l-r;if(!e){alert("Por favor, selecciona un cliente.");return}if(_.length===0){alert("Debes agregar al menos un producto a la venta.");return}if(l<0){alert("El total de la venta no puede ser negativo.");return}if(l===0?(d=0,i=0):i<0&&(i=0),n!=="Deuda"&&(d<0||d>l)){alert("El monto pagado es inv√°lido.");return}if(i>.01&&n!=="Deuda"&&!confirm(`¬°Atenci√≥n! Hay un saldo pendiente de ${g(i)}. ¬øDeseas continuar registrando esta cantidad como deuda?`))return;const s=_.find(h=>!h.product_id||isNaN(h.product_id)||parseInt(h.product_id,10)===0);if(s){alert(`Error de Producto: El √≠tem "${s.name}" tiene un ID inv√°lido (${s.product_id}). Por favor, revise la selecci√≥n.`);return}try{const{data:h,error:v}=await c.from("ventas").insert([{client_id:e,total_amount:l,paid_amount:d,saldo_pendiente:i,metodo_pago:n,description:o}]).select("venta_id");if(v||!h||h.length===0){console.error("Error al insertar venta (Ventas):",v),alert(`Error al registrar la venta: ${(v==null?void 0:v.message)||"Desconocido"}`);return}const x=h[0].venta_id,D=_.map(E=>({venta_id:x,product_id:parseInt(E.product_id,10),name:E.name,quantity:E.quantity,price:E.price,subtotal:E.subtotal})),{error:C}=await c.from("detalle_ventas").insert(D);if(C){console.error("üõë ERROR BD - DETALLES FALLIDOS:",C);let E=C.message||"Error desconocido al insertar detalles.";throw new Error(`BD Fall√≥ al insertar detalles (ID Venta: ${x}). Mensaje Supabase: ${E}`)}if(d>0){const{error:E}=await c.from("pagos").insert([{venta_id:x,amount:d,client_id:e,metodo_pago:n}]);E&&(console.error("Error al registrar pago inicial (Pagos):",E),alert(`Advertencia: El pago inicial fall√≥. ${E.message}`))}closeModal("new-sale-modal"),_=[],K(),document.getElementById("new-sale-form").reset(),await M(),await T("gestion"),be(x)}catch(h){console.error("Error FATAL al registrar la venta:",h),alert("Error fatal al registrar la venta: "+h.message);return}}window.handleNewSale=fe;window.loadDashboardMetrics=async function(){if(!c){console.error("Supabase no est√° inicializado para cargar m√©tricas.");return}try{const{data:t,error:e}=await c.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",.01);if(e)throw e;let n=0;t&&t.length>0&&(n=t.reduce((i,s)=>i+parseFloat(s.saldo_pendiente||0),0));const{data:o,error:a}=await c.from("ventas").select("total_amount").not("total_amount","is",null);if(a)throw a;let r=0;o&&o.length>0&&(r=o.reduce((i,s)=>i+parseFloat(s.total_amount||0),0));const l=document.getElementById("total-debt");l&&(l.textContent=g(n));const d=document.getElementById("historical-total-sales");d&&(d.textContent=g(r))}catch(t){console.error("Error al cargar m√©tricas del dashboard:",t)}};window.handleViewClientDebt=async function(t){if(!c){console.error("Supabase no est√° inicializado.");return}window.viewingClientId=t;try{const e=G.find(i=>i.client_id.toString()===t.toString());if(!e){console.error("Cliente no encontrado para ID:",t),alert("Error: Cliente no encontrado.");return}const{data:n,error:o}=await c.from("transacciones_deuda").select("*").eq("client_id",t).order("created_at",{ascending:!0});if(o)throw o;document.getElementById("client-report-name").textContent=e.name;const a=document.getElementById("client-transactions-body");a.innerHTML="";let r=0;console.log(`--- DEBUG INICIO: Reporte de Deuda para ${e.name} ---`),(n||[]).forEach(i=>{const s=parseFloat(i.amount);let m="",u="",y="";if(i.type==="cargo_venta")r+=s,u=`Venta: ${i.product_name||"Producto/Servicio"}`,m=g(s),y="text-red-600 font-bold";else{r-=s,m=`-${g(s)}`,y="text-green-600 font-bold";const D=i.metodo_pago?` (${i.metodo_pago})`:"";i.description&&i.description.includes("Pago Inicial")?u=`Pago Inicial de Venta${D}`:u=`Abono a Deuda${D}`}console.log(`  [${i.type} ${i.id}] Monto: ${s} | Saldo Acumulado: ${r.toFixed(2)}`);const w=Math.abs(r),h=g(w);let v="",x="Saldo: ";r>.01?(v="text-red-600 font-extrabold",x="Deuda: "):r<-.01?(v="text-green-600 font-extrabold",x="Cr√©dito: "):(v="text-gray-700 font-extrabold",x="Saldado: "),a.innerHTML+=`
                <tr class="hover:bg-gray-50 text-sm">
                    <td class="px-3 py-3 whitespace-nowrap text-gray-500">${F(i.created_at)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-gray-800">${u}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-left ${y}">${m}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-left ${v}">${x}${h}</td>
                </tr>
            `});const l=g(Math.abs(r)),d=document.getElementById("client-report-total-debt");console.log(`--- DEBUG FINAL: Saldo Total Calculado: ${r.toFixed(2)} ---`),r>.01?(d.textContent=l,d.className="text-red-600 font-extrabold text-xl"):r<-.01?(d.textContent=`Cr√©dito ${l}`,d.className="text-green-600 font-bold text-xl"):(d.textContent=g(0),d.className="text-gray-600 font-extrabold text-xl"),openModal("modal-client-debt-report")}catch(e){console.error("Error al cargar la deuda del cliente:",e),alert("Hubo un error al cargar el historial de deuda.")}};window.handleViewSaleDetails=async function(t,e){var a;if(!c){console.error("Supabase no est√° inicializado."),alert("Error de configuraci√≥n: Supabase no est√° disponible.");return}const n=parseInt(t,10);if(isNaN(n)){console.error("ID de transacci√≥n inv√°lido."),alert("Error: El ID de la venta es inv√°lido.");return}const o=G.find(r=>{var l;return((l=r.client_id)==null?void 0:l.toString())===(e==null?void 0:e.toString())});if(!o){console.error("Cliente no encontrado en allClients."),alert("Error: Cliente no encontrado para esta venta. Intente recargar la p√°gina.");return}window.viewingClientId=e;try{const{data:r,error:l}=await c.from("ventas").select("venta_id, total_amount, paid_amount, saldo_pendiente, created_at, description, metodo_pago").eq("venta_id",n).single();if(l||!r)throw console.error("Error al cargar detalles de la venta (Tabla Ventas):",l),new Error("No se encontr√≥ la venta principal (ID: "+n+").");const{data:d,error:i}=await c.from("detalle_ventas").select("detalle_id, quantity, price, subtotal, product_id, productos(name, parent_product)").eq("venta_id",n).order("detalle_id",{ascending:!0});if(i)throw i;const{data:s,error:m}=await c.from("pagos").select("amount, metodo_pago, created_at").eq("venta_id",n).order("created_at",{ascending:!0});if(m)throw m;document.getElementById("detail-sale-id").textContent=r.venta_id,document.getElementById("detail-client-name").textContent=o.name,document.getElementById("detail-sale-date").textContent=F(r.created_at),document.getElementById("detail-payment-method").textContent=r.metodo_pago,document.getElementById("detail-grand-total").textContent=g(r.total_amount),document.getElementById("detail-paid-amount").textContent=g(r.paid_amount),document.getElementById("detail-remaining-debt").textContent=g(r.saldo_pendiente);const u=document.getElementById("detail-products-body");u.innerHTML="",(d||[]).forEach(E=>{const I=E.productos;let B="N/A";if(I&&I.parent_product&&window.allProductsMap){const A=window.allProductsMap[I.parent_product];A&&(B=A.name)}u.innerHTML+=`
                <tr>
                    <td class="px-4 py-2">
                        ${B!=="N/A"&&B?B+" (":""}
                        <span class="font-medium">${(I==null?void 0:I.name)||"Producto Desconocido"}</span>
                        ${B!=="N/A"&&B?")":""}
                    </td> 
                    <td class="px-4 py-2 text-center">${E.quantity}</td>
                    <td class="px-4 py-2 text-right">${g(E.price)}</td>
                    <td class="px-4 py-2 font-medium text-right">${g(E.subtotal)}</td>
                </tr>
            `});const y=document.getElementById("detail-abonos-body"),w=document.getElementById("no-abonos-message");y.innerHTML="",s.length===0?w.classList.remove("hidden"):(w.classList.add("hidden"),s.forEach(E=>{y.innerHTML+=`
                    <tr>
                        <td class="px-4 py-2">${F(E.created_at)}</td>
                        <td class="px-4 py-2 font-medium text-right">${g(E.amount)}</td>
                    </tr>
                `}));const h=document.getElementById("price-edit-section"),v=document.querySelector('[data-open-modal="abono-client-modal"]'),x=parseFloat(r.total_amount)<.01&&parseFloat(r.saldo_pendiente)<.01,D=parseFloat(r.saldo_pendiente)>.01,C=r.saldo_pendiente;if(x){h==null||h.classList.remove("hidden"),v==null||v.classList.add("hidden");const E=(d||[])[0];document.getElementById("edit-sale-id-display").textContent=r.venta_id,document.getElementById("edit-sale-transaction-id").value=r.venta_id,E&&E.detalle_id?(document.getElementById("edit-sale-detail-id").value=E.detalle_id,document.getElementById("edit-new-price").value=E.price||"",document.getElementById("edit-product-name").textContent=((a=E.productos)==null?void 0:a.name)||"√çtem Principal"):(h==null||h.classList.add("hidden"),v==null||v.classList.remove("hidden"))}else if(D){h==null||h.classList.add("hidden"),v==null||v.classList.remove("hidden");const E=document.getElementById("debt-to-pay-id"),I=document.getElementById("abono-current-debt");E&&(E.value=r.venta_id),I&&(I.textContent=g(C))}else h==null||h.classList.add("hidden"),v==null||v.classList.add("hidden");openModal("modal-detail-sale")}catch(r){console.error("Error al cargar detalles de venta:",r),alert("Hubo un error al cargar los detalles de la venta.")}};async function Te(t){if(t.preventDefault(),!c){console.error("Supabase no est√° inicializado."),alert("Error de configuraci√≥n.");return}const e=t.target,n=e.elements["debt-to-pay-id"].value,o=parseFloat(e.elements["abono-amount"].value),a=e.elements["payment-method-abono"].value;if(isNaN(o)||o<=0){alert("Ingrese un monto de abono v√°lido y mayor a cero.");return}try{const{data:r,error:l}=await c.from("ventas").select("total_amount, paid_amount, saldo_pendiente, client_id").eq("venta_id",n).single();if(l||!r)throw new Error("Venta no encontrada.");const d=r.saldo_pendiente;if(o>d){alert(`El abono (${g(o)}) es mayor que la deuda pendiente (${g(d)}). Ajuste el monto.`);return}const i=r.paid_amount+o,s=d-o,m=r.client_id,{error:u}=await c.from("pagos").insert([{venta_id:n,client_id:m,amount:o,metodo_pago:a,type:"abono"}]);if(u)throw new Error("Error al registrar el pago: "+u.message);const{error:y}=await c.from("ventas").update({paid_amount:i,saldo_pendiente:s}).eq("venta_id",n);if(y)throw new Error("Error al actualizar la venta: "+y.message);alert(`Abono de ${g(o)} registrado con √©xito. Deuda restante: ${g(s)}.`),e.reset(),closeModal("abono-client-modal"),await M(),handleViewSaleDetails(n,m)}catch(r){console.error("Error al registrar abono:",r),alert("Fallo al registrar el abono: "+r.message)}}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("edit-sale-price-form");t&&t.addEventListener("submit",ge)});window.loadClientDebtsTable=async function(){if(!c||!window.allClientsMap)return;const t=document.getElementById("debts-table-body"),e=document.getElementById("no-debts-message");if(!(!t||!e)){t.innerHTML='<tr><td colspan="4" class="text-center py-4 text-gray-500">Cargando deudas...</td></tr>',e.classList.add("hidden");try{const{data:n,error:o}=await c.from("ventas").select(`
                venta_id, 
                client_id, 
                created_at, 
                saldo_pendiente,
                clientes(name) 
            `).gt("saldo_pendiente",.01).order("created_at",{ascending:!1});if(o)throw o;const a={};(n||[]).forEach(l=>{var i;const d=l.client_id;a[d]||(a[d]={clientId:d,name:((i=l.clientes)==null?void 0:i.name)||"Cliente Desconocido",totalDebt:0,lastSaleDate:l.created_at,lastSaleId:l.venta_id}),a[d].totalDebt+=l.saldo_pendiente});const r=Object.values(a);if(t.innerHTML="",r.length===0){e.classList.remove("hidden");return}r.forEach(l=>{const d=t.insertRow();d.className="hover:bg-gray-50",d.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${l.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-lg font-extrabold text-red-600">${g(l.totalDebt)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${F(l.lastSaleDate)} (Venta #${l.lastSaleId})</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button 
                        onclick="handleViewSaleDetails(${l.lastSaleId}, ${l.clientId})" 
                        class="text-indigo-600 hover:text-indigo-900 font-medium text-xs py-1 px-2 rounded bg-indigo-100"
                        title="Detalle"
                    >
                        Ver √öltima Venta
                    </button>
                    </td>
            `})}catch(n){console.error("Error al cargar la tabla de deudas:",n),t.innerHTML='<tr><td colspan="4" class="text-center py-4 text-red-600">Error al cargar datos de deudas.</td></tr>'}}};async function ge(t){if(t.preventDefault(),!c){alert("Error: Supabase no est√° inicializado.");return}const e=t.target,n=e.elements["edit-sale-transaction-id"].value,o=e.elements["edit-sale-detail-id"].value,a=e.elements["edit-new-price"].value,r=parseFloat(a),l=window.viewingClientId;if(!n||!o||isNaN(r)||r<=0||!l){alert("Faltan datos (Venta/Detalle/Cliente) o el precio es inv√°lido.");return}if(confirm(`¬øEst√° seguro de establecer el precio de la Venta #${n} a ${g(r)}? Esto definir√° el total y el saldo pendiente.`))try{const{data:d,error:i}=await c.from("detalle_ventas").select("quantity").eq("detalle_id",o).single();if(i||!d)throw new Error("Detalle de venta no encontrado.");const s=r*d.quantity,{error:m}=await c.from("detalle_ventas").update({price:r,subtotal:s}).eq("detalle_id",o);if(m)throw new Error("Error al actualizar detalle: "+m.message);const{error:u}=await c.from("ventas").update({total_amount:s,saldo_pendiente:s,paid_amount:0}).eq("venta_id",n);if(u)throw new Error("Error al actualizar venta: "+u.message);alert(`Venta #${n} actualizada con √©xito. El saldo pendiente ahora es de ${g(s)}.`),closeModal("modal-detail-sale"),window.loadDashboardData&&await M(),window.loadMonthlySalesReport&&await U(),window.loadClientsTable&&await T("gestion"),handleViewSaleDetails(n,l)}catch(d){console.error("Error al editar precio de venta:",d),alert("Fallo al actualizar el precio: "+d.message)}}async function T(t="gestion"){if(!c){console.error("Supabase no est√° inicializado.");return}const e=document.getElementById("clients-list-body");if(!e){console.error("Contenedor de clientes ('clients-list-body') no encontrado.");return}const n=t==="gestion";try{const{data:o,error:a}=await c.from("clientes").select("client_id, name, telefono").order("name",{ascending:!0});if(a)throw a;G=o;const r=o.map(d=>$e(d.client_id)),l=await Promise.all(r);e.innerHTML="",o.forEach((d,i)=>{const s=l[i],m=document.createElement("tr");m.className="hover:bg-gray-50";let u="";n?u=`
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" class="edit-client-btn text-indigo-600 hover:text-indigo-900 mr-2" 
                                        data-client-id="${d.client_id}">
                            <i class="fas fa-edit"></i> Editar
                
                <button type="button" class="delete-client-btn text-red-600 hover:text-red-900 mr-2" 
                 data-client-id="${d.client_id}" 
               data-client-name="${d.name}">
                 <i class="fas fa-trash"></i> Eliminar
                </button>

                     <button type="button" class="view-debt-btn text-blue-600 hover:text-blue-900" 
                        data-client-id="${d.client_id}" title="Ver ventas y abonos del cliente">
                        <i class="fas fa-file-invoice-dollar"></i> Ver Deuda
                    </button>
                    </td>
                `:u='<td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium"></td>',m.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${d.client_id}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${d.name}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${d.telefono||"N/A"}</td>
                
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">
                    $${s.totalVentas.toFixed(2)}
                </td>
                
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold 
                    ${s.deudaNeta>0?"text-red-600":"text-green-600"}">
                    $${s.deudaNeta.toFixed(2)}
                </td>
                
                ${u} 
            `,e.appendChild(m)}),n&&(e.querySelectorAll(".edit-client-btn").forEach(d=>{d.addEventListener("click",()=>{Ee(d.dataset.clientId)})}),e.querySelectorAll(".delete-client-btn").forEach(d=>{d.addEventListener("click",()=>{ye(d.dataset.clientId,d.dataset.clientName)})}),e.querySelectorAll(".view-debt-btn").forEach(d=>{d.addEventListener("click",()=>{handleViewClientDebt(d.dataset.clientId)})}))}catch(o){console.error("Error inesperado al cargar clientes:",o.message||o)}}function Ne(t){const e=L.find(o=>String(o.producto_id)===String(t));if(!e){alert("Error: Producto no encontrado para edici√≥n.");return}document.getElementById("product-id").value=e.producto_id,document.getElementById("edit-product-name").value=e.name,document.getElementById("edit-product-type").value=e.type,document.getElementById("edit-sale-price").value=e.price||0;const n=document.getElementById("edit-parent-product-container");e.type==="PACKAGE"?(n.classList.remove("hidden"),pe("edit-parent-product-select"),document.getElementById("edit-parent-product-select").value=e.parent_product):n.classList.add("hidden"),document.getElementById("product-modal-title").textContent="Editar Producto: "+e.name}async function Pe(t){var m;if(t.preventDefault(),!c||!V){alert("Error: Supabase no est√° disponible o el ID del producto a editar es desconocido.");return}const e=document.getElementById("edit-product-name"),n=document.getElementById("edit-product-type"),o=document.getElementById("edit-sale-price"),a=e.value.trim(),r=n.value,l=parseFloat(o.value);let d=null;if(isNaN(l)||l<0||o.value.trim()===""){alert("El precio de venta debe ser un n√∫mero v√°lido (mayor o igual a cero).");return}if(r==="PACKAGE"){const u=document.getElementById("edit-parent-product-select");if(d=(u==null?void 0:u.value)||null,!d){alert("Los paquetes deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const i={name:a,type:r,price:l,parent_product:d},{error:s}=await c.from("productos").update(i).eq("producto_id",V);s?(console.error("Error de Supabase al actualizar producto:",s.message),alert("Error al actualizar producto: "+s.message)):(alert("Producto actualizado exitosamente."),closeModal("modal-edit-product"),V=null,(m=document.getElementById("edit-product-form"))==null||m.reset(),await $(),await H())}function ie(){const t=document.getElementById("new-product-type"),e=document.getElementById("parent-product-container"),n=document.getElementById("parent-product-select");!t||!e||!n||(t.value==="PACKAGE"?(e.classList.remove("hidden"),e.classList.add("block"),n.setAttribute("required","required")):(e.classList.add("hidden"),e.classList.remove("block"),n.removeAttribute("required"),n.value=""))}async function qe(){const t=document.getElementById("products-table-body");if(!t)return;await $(),t.innerHTML="";const e=L;if(e.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">No hay productos registrados.</td></tr>';return}e.forEach(n=>{const o=document.createElement("tr");o.className="hover:bg-gray-50",o.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.producto_id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${n.type}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${g(n.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-product-id="${n.producto_id}" class="text-indigo-600 hover:text-indigo-900 edit-product-btn mr-2">Editar</button>
                <button data-product-id="${n.producto_id}" class="text-red-600 hover:text-red-900 delete-product-btn">Eliminar</button>
            </td>
        `,t.appendChild(o)}),document.querySelectorAll(".edit-product-btn").forEach(n=>{n.onclick=()=>{const o=n.getAttribute("data-product-id");openEditProductModal(o)}}),document.querySelectorAll(".delete-product-btn").forEach(n=>{n.onclick=()=>{const o=n.getAttribute("data-product-id");handleDeleteProduct(o)}})}async function Fe(t){var s;if(t.preventDefault(),!c){alert("Error de conexi√≥n: Supabase no est√° disponible.");return}const e=document.getElementById("new-product-name"),n=document.getElementById("new-product-type"),o=document.getElementById("new-product-price");if(!e||!n||!o){console.error("Error FATAL: No se encontraron todos los campos del formulario en el DOM. Verifique los IDs."),alert("Error al intentar guardar el producto. Verifique los IDs en la consola.");return}const a=e.value.trim(),r=n.value,l=parseFloat(o.value);let d=null;if(isNaN(l)||l<0||o.value.trim()===""){alert("El precio unitario debe ser un n√∫mero v√°lido (mayor o igual a cero).");return}if(r==="PACKAGE"){const m=document.getElementById("parent-product-select");if(d=(m==null?void 0:m.value)||null,!d){alert("Los paquetes deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const{error:i}=await c.from("productos").insert([{name:a,type:r,price:l,parent_product:d}]);i?(console.error("Error de Supabase al registrar producto:",i.message),alert("Error al registrar producto: "+i.message)):(alert("Producto registrado exitosamente."),closeModal("modal-register-product"),(s=document.getElementById("new-product-form"))==null||s.reset(),await $(),await H())}function Re(t){V=t,Ne(t),openModal("modal-edit-product")}let z=null;function He(t){z=t;const e=L.find(n=>String(n.producto_id)===String(t));e&&(document.getElementById("delete-product-name-placeholder").textContent=e.name),openModal("modal-delete-confirmation")}async function ke(){if(!z)return;const{error:t}=await c.from("productos").delete().eq("producto_id",z);t?(console.error("Error al eliminar producto:",t.message),alert("Error al eliminar producto: "+t.message)):(alert("Producto eliminado exitosamente."),closeModal("modal-delete-confirmation"),z=null,await $(),await H())}let Y=null;function ye(t,e){Y=t;const n=document.getElementById("delete-client-name-placeholder");n&&(n.textContent=e),openModal("client-delete-confirmation")}async function Oe(){const t=Y;if(!t){alert("Error de Eliminaci√≥n: ID del cliente no encontrada.");return}const{error:e}=await c.from("clientes").delete().eq("client_id",t);if(e){console.error("Error al intentar eliminar el cliente:",e),e.code==="23503"?alert("‚ùå ERROR: No se puede eliminar el cliente. Tiene ventas o abonos pendientes asociados. Aseg√∫rate de eliminar el historial del cliente o configurar la eliminaci√≥n en cascada en Supabase."):alert("‚ùå Error desconocido al eliminar cliente: "+e.message),closeModal("client-delete-confirmation");return}alert("‚úÖ Cliente eliminado definitivamente."),closeModal("client-delete-confirmation"),Y=null,await M()}async function Ve(t){t.preventDefault();const e=document.getElementById("name").value,n=document.getElementById("phone").value,{error:o}=await c.from("clientes").insert([{name:e,telefono:n,is_active:!0}]);if(o)alert("Error al registrar cliente: "+o.message);else{alert("Cliente registrado exitosamente."),await je();const a=document.getElementById("client-form");a?a.reset():console.warn("Advertencia: No se encontr√≥ el formulario 'client-form' para resetear."),closeModal("modal-new-client"),await T()}}function Ee(t){if(!c){console.error("Supabase no est√° inicializado.");return}const e=G.find(r=>String(r.client_id)===String(t));if(!e){alert("Error: Cliente no encontrado para editar.");return}const n=document.getElementById("edit-client-id");n&&(n.value=e.client_id);const o=document.getElementById("edit-client-name");o&&(o.value=e.name);const a=document.getElementById("edit-client-phone");a&&(a.value=e.telefono||""),openModal("edit-client-modal")}async function se(t){t.preventDefault();const e=document.getElementById("edit-client-id").value,n=document.getElementById("edit-client-name").value.trim(),o=document.getElementById("edit-client-phone").value.trim();if(!e){alert("Error de Edici√≥n: No se pudo obtener la ID del cliente.");return}const{error:a}=await c.from("clientes").update({name:n,telefono:o}).eq("client_id",e);a?(console.error("Error al actualizar cliente:",a),alert("Error al actualizar cliente: "+a.message)):(alert("Cliente actualizado exitosamente."),await M(),document.getElementById("edit-client-form").reset(),closeModal("edit-client-modal"))}var ce;(ce=document.getElementById("confirm-delete-client-btn"))==null||ce.addEventListener("click",Oe);async function ze(t){if(t.preventDefault(),!c){console.error("Supabase no est√° inicializado.");return}const e=document.getElementById("abono-amount-sale");document.getElementById("payment-method-sale").value,document.getElementById("payment-sale-id").value;let n=e?e.valueAsNumber:0;if(isNaN(n)){const o=e.value.replace(",",".");n=parseFloat(o)||0}{alert("Por favor, ingresa un monto de abono v√°lido y aseg√∫rate de que la venta y el cliente est√©n cargados.");return}}async function U(t,e){if(console.log(`>>> Ejecutando loadMonthlySalesReport (DIAGN√ìSTICO FINAL) para Mes: ${t}, A√±o: ${e}`),!c){console.error("Supabase no est√° inicializado. No se pueden cargar los reportes.");return}const n=document.getElementById("monthly-sales-report-body"),o=document.getElementById("report-total-sales"),a=document.getElementById("report-total-debt-generated"),r=document.getElementById("monthly-report-no-data");if(!n||!o||!a||!r){let l=[];n||l.push("#monthly-sales-report-body"),o||l.push("#report-total-sales"),a||l.push("#report-total-debt-generated"),r||l.push("#monthly-report-no-data"),alert("ERROR CR√çTICO (DOM FALTANTE): El reporte fall√≥ porque falta el elemento HTML: "+l.join(", ")),console.error("‚õîÔ∏è FALLO DE DOM: Elementos faltantes:",l.join(", "));return}n.innerHTML='<tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando reporte...</td></tr>',o.textContent="...",a.textContent="...",r.classList.add("hidden");try{const l=new Date().getMonth()+1,d=new Date().getFullYear();let i=t&&t>=1&&t<=12?t:l,s=e&&e>=2e3?e:d;console.log(`[DEBUG FINAL] CONSULTA SUPABASE para Mes: ${i}, A√±o: ${s}`);let m=new Date(Date.UTC(s,i-1,1)),u=i,y=s;u===12?(u=1,y+=1):u+=1;let w=new Date(Date.UTC(y,u-1,1));const h=m.toISOString(),v=w.toISOString();console.log(`[DEBUG] RANGO FINAL AJUSTADO (UTC): GTE ${h} | LT ${v}`);const{data:x,error:D}=await c.from("ventas").select(`
                venta_id, 
                client_id, 
                created_at, 
                total_amount, 
                saldo_pendiente,
                clientes(name) 
            `).gte("created_at",h).lt("created_at",v).order("created_at",{ascending:!1});if(D)throw D;let C=0,E=0;n.innerHTML="",x&&x.length>0?(x.forEach(I=>{var N;C+=I.total_amount,E+=I.saldo_pendiente;const B=n.insertRow();B.className="hover:bg-gray-50";const A=((N=I.clientes)==null?void 0:N.name)||"Cliente Desconocido",k=new Date(I.created_at).toLocaleDateString();B.innerHTML=`
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${k} (Venta #${I.venta_id})</td>
                    <td class="px-6 py-3 whitespace-nowrap font-medium text-gray-900">${A}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">${g(I.total_amount)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm ${I.saldo_pendiente>.01?"text-red-600 font-bold":"text-green-600"}">
                        ${g(I.saldo_pendiente)}
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm">
                        <button 
                            onclick="handleViewSaleDetails(${I.venta_id}, ${I.client_id})" 
                            class="text-indigo-600 hover:text-indigo-900 font-medium text-xs py-1 px-2 rounded bg-indigo-100"
                        >
                            Ver Detalle
                        </button>
                    </td>
                `}),r.classList.add("hidden")):r.classList.remove("hidden"),o.textContent=g(C),a.textContent=g(E)}catch(l){console.error("Error al cargar el reporte mensual:",l),n.innerHTML='<tr><td colspan="5" class="text-center py-4 text-red-600">Fallo al cargar datos. Consulte la consola.</td></tr>',o.textContent=g(0),a.textContent=g(0)}}function he(){const t=document.getElementById("report-month-select");if(!t)return;t.innerHTML="";const e=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],n=new Date().getMonth()+1;e.forEach((o,a)=>{const r=a+1,l=document.createElement("option");l.value=r,l.textContent=o,r===n&&(l.selected=!0),t.appendChild(l)})}function Ue(){const t=document.getElementById("report-year-select");if(!t)return;t.innerHTML="";const e=new Date().getFullYear(),n=e-2;for(let o=e+1;o>=n;o--){const a=document.createElement("option");a.value=o,a.textContent=o,o===e&&(a.selected=!0),t.appendChild(a)}}window.initReportSelectors=function(){j||(console.log("Inicializando selectores de reporte (Mes/A√±o) por primera vez..."),he(),Ue(),j=!0,window.loadMonthlySalesReport&&window.loadMonthlySalesReport())};function ve(t){var s;const n=(m,u)=>{const y=g(u),w=32-m.length-y.length;return m+" ".repeat(w)+y},o=m=>{const u=32-m.length,y=Math.floor(u/2);return" ".repeat(y)+m};let a=o("Creativa Cortes CNC")+`
`;a+=`--------------------------------
`,a+=`
`,a+=o("Tel: 9851001141")+`
`,a+=o("Direcci√≥n: Calle 33 x 48 y 46")+`
`,a+=o("Col. Candelaria")+`
`,a+="Fecha: "+new Date(t.created_at).toLocaleDateString("es-MX")+`
`,a+="Venta: "+t.venta_id+`
`,a+=`--------------------------------
`;const r=((s=t.clientes)==null?void 0:s.name)||"Consumidor Final";a+="Cliente: "+r+`
`,a+=`================================
`,a+=`
`,a+=`Producto             Cant.  Total
`,a+=`--------------------------------
`,t.detalle_ventas.forEach(m=>{const y=m.productos.name.substring(0,18).padEnd(18," "),w=m.quantity.toString().padStart(5," "),h=g(m.subtotal).padStart(6," ");a+=`${y} ${w} ${h}
`}),a+=`--------------------------------
`,a+=`
`;const l=t.total_amount||0,d=t.saldo_pendiente||0,i=l-d;return a+=n("SALDO PENDIENTE:",d)+`
`,a+=n("ANTICIPO:",i)+`
`,a+=`================================
`,a+=n("TOTAL:",l)+`
`,a+=`================================
`,a+=`
`,a+=o("¬°Gracias por su compra!")+`
`,a+=`
`,a+=`--------------------------------
`,a}let we=null;async function be(t){const{data:e,error:n}=await c.from("ventas").select("*, clientes(name), detalle_ventas (quantity, price, subtotal, productos(name))").eq("venta_id",t).single();if(n||!e)return;const a=`<pre style="font-family: monospace; font-size: 14px; margin: 0 auto; text-align: left;">${ve(e)}</pre>`,r=document.getElementById("ticket-preview-content");r&&(r.innerHTML=a),we=t,openModal("modal-ticket-preview")}window.showTicketPreviewModal=be;async function Ge(t){const{data:e,error:n}=await c.from("ventas").select("*, clientes(name), detalle_ventas (quantity, price, subtotal, productos(name))").eq("venta_id",t).single();if(n||!e){console.error("Error al obtener datos para impresi√≥n:",n==null?void 0:n.message);return}const o=ve(e);if(!qz.websocket.isActive()){alert("QZ Tray no est√° conectado. Por favor, aseg√∫rate de que est√© corriendo y recarga la p√°gina.");return}try{const a=[{type:"raw",data:o},{type:"raw",data:"VA\0"}],r=qz.configs.create("XP-58 (copy 1)",{encoding:"858"});await qz.print(r,a),console.log("Ticket enviado a la impresora correctamente.")}catch(a){alert("Error de impresi√≥n con QZ Tray. Revisa la consola para m√°s detalles."),console.error(a)}}async function Ke(){const{data:t,error:e}=await c.from("clientes").select("client_id, name");if(e){console.error("Error al cargar datos de clientes para el mapa:",e);return}t.reduce((n,o)=>(n[o.client_id]=o.name,n),{})}async function je(){const t=document.getElementById("clients-list-body"),e=document.getElementById("clients-list-controls"),n=document.getElementById("toggle-clients-list"),o=document.getElementById("client-count-summary"),{data:a,error:r}=await c.from("clientes").select("client_id, name, phone").order("client_id",{ascending:!1});if(r){console.error("Error al cargar clientes:",r.message);return}t.innerHTML="";const l=10,d=a.length;let i=!1;if(a.forEach((s,m)=>{const u=!i&&m>=l,y=t.insertRow();y.className=u?"hidden":"hover:bg-gray-50",y.dataset.clientId=s.client_id,y.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${s.client_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">${s.name}</td>
            <td class="px-3 py-2 whitespace-nowrap">${s.phone||"-"}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button data-client-id="${s.client_id}" class="edit-client-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button data-client-id="${s.client_id}" class="delete-client-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `}),d>l){e.classList.remove("hidden"),o.textContent=`Mostrando ${l} de ${d} clientes.`;const s=()=>{i=!i,t.querySelectorAll("tr").forEach((u,y)=>{y>=l&&u.classList.toggle("hidden",!i)}),n.textContent=i?"Mostrar menos":`Mostrar los ${d-l} restantes`,o.textContent=i?`Mostrando todos (${d}) clientes.`:`Mostrando ${l} de ${d} clientes.`};n.onclick=s,s()}else e.classList.add("hidden")}async function H(){const t=document.getElementById("products-table-body");if(!t){console.error("Error: No se encontr√≥ el <tbody> con ID 'products-table-body'.");return}if(t.innerHTML="",L.length===0){t.innerHTML='<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay productos registrados.</td></tr>';return}L.forEach(e=>{let n="";if(e.type==="PACKAGE")if(e.parent_product){const l=L.find(d=>String(d.producto_id)===String(e.parent_product));n=l?`<span class="text-xs text-gray-500 ml-1">(Padre: ${l.name})</span>`:'<span class="text-xs text-red-500 ml-1">(ID Padre No V√°lida/Eliminada)</span>'}else n='<span class="text-xs text-red-500 ml-1">(Sin Padre Asociado)</span>';const o=e.type==="PACKAGE"?"Paquete/Servicio":"Producto Individual",a=e.price?parseFloat(e.price).toFixed(2):"0.00",r=t.insertRow();r.className="hover:bg-gray-50",r.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${e.producto_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">
                ${e.name} ${n}
            </td>
            <td class="px-3 py-2 whitespace-nowrap">${o}</td>
            <td class="px-3 py-2 whitespace-nowrap">$${a}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button data-product-id="${e.producto_id}" class="edit-product-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button data-product-id="${e.producto_id}" class="delete-product-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `})}document.addEventListener("DOMContentLoaded",async()=>{var d,i,s,m,u,y,w,h,v,x,D,C,E,I,B,A,k,N,W,Z,Q,ee,te,ne,ae,oe,re,de;function t(p){const f=document.getElementById(p);f?(f.classList.remove("hidden"),f.classList.add("flex")):console.error(`Error: Modal con ID '${p}' no encontrado.`)}function e(p){const f=document.getElementById(p);if(f){f.classList.add("hidden"),f.classList.remove("flex");const b=f.querySelector("form");b&&b.reset()}}document.querySelectorAll("[data-open-modal]").forEach(p=>{p.addEventListener("click",f=>{f.preventDefault();const b=p.getAttribute("data-open-modal");t(b)})}),document.querySelectorAll("[data-close-modal]").forEach(p=>{p.addEventListener("click",f=>{f.preventDefault();const b=p.getAttribute("data-close-modal");e(b)})}),document.addEventListener("click",p=>{document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(b=>{p.target===b&&e(b.id)})}),document.addEventListener("keydown",p=>{if(p.key==="Escape"){const f=document.querySelectorAll(".modal-overlay:not(.hidden)"),b=f[f.length-1];b&&e(b.id)}});function n(p){document.querySelectorAll(".menu-item").forEach(S=>{S.classList.remove("active-menu-item")}),document.querySelectorAll(".dashboard-view").forEach(S=>{S.classList.add("hidden")});const f=document.getElementById(p);f&&f.classList.remove("hidden");const b=document.querySelector(`[data-view="${p}"]`);b&&b.classList.add("active-menu-item"),p==="home-view"?M():p==="clients-view"?T("gestion"):p==="products-view"?H():p==="report-view"&&(!j&&window.initReportSelectors?window.initReportSelectors():window.loadMonthlySalesReport&&window.loadMonthlySalesReport())}if(document.querySelectorAll("[data-view]").forEach(p=>{p.addEventListener("click",f=>{f.preventDefault();const b=p.getAttribute("data-view");n(b)})}),!window.supabase){console.error("Error Fatal: Librer√≠a Supabase no encontrada. La aplicaci√≥n no funcionar√°.");return}window.supabase||console.error("Error Fatal: Librer√≠a Supabase no encontrada. La aplicaci√≥n no funcionar√°."),await $(),await Ke(),J(),he();const o=document.getElementById("report-month-selector");o&&o.addEventListener("change",U),U(),(d=document.getElementById("open-sale-modal-btn"))==null||d.addEventListener("click",async()=>{var p;try{(p=document.getElementById("new-sale-form"))==null||p.reset(),await ue(),await $(),me(),_=[],K(),document.getElementById("total-amount").value="0.00",document.getElementById("paid-amount").value="0.00",document.getElementById("display-saldo-pendiente").value="0.00",t("new-sale-modal")}catch(f){console.error("Error al cargar datos del modal de venta:",f),alert("Error al cargar los datos. Revise la consola (F12).")}}),(i=document.getElementById("new-sale-form"))==null||i.addEventListener("submit",fe),(s=document.getElementById("paid-amount"))==null||s.addEventListener("input",()=>q()),(m=document.getElementById("payment-method"))==null||m.addEventListener("change",()=>q()),(u=document.getElementById("paid-amount"))==null||u.addEventListener("input",()=>{R()}),(y=document.getElementById("payment-method"))==null||y.addEventListener("change",()=>{R()}),(w=document.getElementById("add-product-btn"))==null||w.addEventListener("click",Se),(h=document.getElementById("abono-client-form"))==null||h.addEventListener("submit",Ae),(v=document.getElementById("register-payment-form"))==null||v.addEventListener("submit",ze);const a=document.getElementById("paid-amount");a&&a.addEventListener("input",q);const r=document.getElementById("payment-method");r&&r.addEventListener("change",q),(x=document.getElementById("login-form"))==null||x.addEventListener("submit",_e),(D=document.getElementById("logout-btn"))==null||D.addEventListener("click",Le),(C=document.getElementById("sales-month-filter"))==null||C.addEventListener("change",()=>{M()}),(E=document.getElementById("reset-sales-filter"))==null||E.addEventListener("click",()=>{const p=document.getElementById("sales-month-filter");p&&(p.value=""),M()}),(I=document.getElementById("print-ticket-btn"))==null||I.addEventListener("click",()=>{Ge(we)}),(B=document.getElementById("open-monthly-report-btn"))==null||B.addEventListener("click",()=>{U(),t("modal-monthly-report")}),document.addEventListener("click",function(p){const f=p.target.closest(".view-sale-details-btn");if(f){const b=f.getAttribute("data-venta-id"),S=f.getAttribute("data-client-id");b&&S?(console.log(`DEBUG: Clic en Detalle Detectado. Venta ID: ${b}, Cliente ID: ${S}`),handleViewSaleDetails(b,S)):console.error("ERROR: El bot√≥n de detalle le faltan atributos (data-venta-id o data-client-id).")}}),window.openRegisterClientModal=function(){const p=document.getElementById("client-modal-title");p&&(p.textContent="Registrar Nuevo Cliente");const f=document.getElementById("new-client-form");f==null||f.reset(),f==null||f.removeEventListener("submit",se),f==null||f.addEventListener("submit",Ve),t("modal-new-client")},(A=document.getElementById("post-sale-price-form"))==null||A.addEventListener("submit",async p=>{p.preventDefault();const f=document.getElementById("edit-venta-id").value,b=document.getElementById("edit-detalle-venta-id").value,S=document.getElementById("edit-client-id").value,O=parseFloat(document.getElementById("new-unit-price").value);await Me(f,b,S,O),e("modal-edit-sale-item")}),(k=document.getElementById("open-admin-products-modal"))==null||k.addEventListener("click",async()=>{try{await $(),await H(),t("admin-products-modal")}catch(p){console.error("Error al cargar la administraci√≥n de productos:",p),alert("Error al cargar la lista de productos.")}}),(N=document.getElementById("open-product-modal-btn"))==null||N.addEventListener("click",()=>{var p;e("admin-products-modal"),(p=document.getElementById("new-product-form"))==null||p.reset(),ie(),t("modal-register-product")}),(W=document.getElementById("new-product-type"))==null||W.addEventListener("change",p=>{ie(),p.target.value==="PACKAGE"&&pe("parent-product-select")}),(Z=document.getElementById("new-product-form"))==null||Z.addEventListener("submit",Fe),(Q=document.getElementById("product-main-select"))==null||Q.addEventListener("change",Be),(ee=document.getElementById("subproduct-select"))==null||ee.addEventListener("change",p=>{X(p.target.value)}),(te=document.getElementById("products-table-body"))==null||te.addEventListener("click",p=>{if(!p.target.hasAttribute("data-product-id"))return;const f=p.target.getAttribute("data-product-id");p.target.classList.contains("edit-product-btn")&&(p.preventDefault(),Re(f)),p.target.classList.contains("delete-product-btn")&&(p.preventDefault(),He(f))}),(ne=document.getElementById("confirm-delete-btn"))==null||ne.addEventListener("click",ke),(ae=document.getElementById("edit-product-form"))==null||ae.addEventListener("submit",Pe),(oe=document.getElementById("clients-list-body"))==null||oe.addEventListener("click",async p=>{const f=p.target.closest("button");if(f){p.preventDefault();const b=f.getAttribute("data-client-id");f.classList.contains("edit-client-btn")&&await Ee(b),f.classList.contains("delete-client-btn")&&ye(b),f.classList.contains("view-debt-btn")&&await handleViewClientDebt(b)}}),(re=document.getElementById("edit-client-form"))==null||re.addEventListener("submit",se);const l=document.getElementById("abono-client-form");l==null||l.addEventListener("submit",Te),(de=document.getElementById("open-abono-from-report-btn"))==null||de.addEventListener("click",p=>{var S;if(!window.viewingClientId){p.preventDefault();return}const f=((S=document.getElementById("client-report-total-debt"))==null?void 0:S.textContent)||"$0.00";if(parseFloat(f.replace(/[^0-9.-]+/g,"").replace(",","."))>.01){P=window.viewingClientId;const O=document.getElementById("abono-current-debt");O&&(O.textContent=f),t("modal-record-abono"),e("modal-client-debt-report")}else p.preventDefault(),alert("El cliente no tiene deuda pendiente para registrar un abono.")})});document.addEventListener("DOMContentLoaded",()=>{console.log("DOM Cargado. Inicializando aplicaci√≥n...");const t=document.getElementById("edit-sale-price-form");t&&(t.addEventListener("submit",ge),console.log("Listener de edici√≥n de precio enlazado.")),window.loadDashboardData&&(window.loadDashboardData(),console.log("Datos del Dashboard cargados.")),document.body.addEventListener("click",e=>{if(e.target.classList.contains("view-sale-details-btn")){const n=e.target.dataset.ventaId,o=e.target.dataset.clientId;n&&o&&handleViewSaleDetails(parseInt(n),parseInt(o))}})});document.body.addEventListener("change",t=>{const e=t.target;if(e.id==="report-month-select"||e.id==="report-year-select"){const n=document.getElementById("report-month-select"),o=document.getElementById("report-year-select");let a=parseInt(e.id==="report-month-select"?e.value:n.value)||0,r=parseInt(e.id==="report-year-select"?e.value:o.value)||0;console.log(`[DELEGACI√ìN CORRECTA] Mes: ${a}, A√±o: ${r} pasados a la funci√≥n.`),console.log("INTENTANDO LLAMAR a loadMonthlySalesReport...");try{window.loadMonthlySalesReport&&setTimeout(()=>{console.log("--- LLAMADA AS√çNCRONA DE REPORTE RETRASADA EJECUT√ÅNDOSE ---"),window.loadMonthlySalesReport(a,r)},100)}catch(l){console.error("‚õîÔ∏è ERROR CR√çTICO AL PROGRAMAR LA FUNCI√ìN:",l)}console.log("LISTENER TERMINADO.")}});
