(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const d of a)if(d.type==="childList")for(const r of d.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const d={};return a.integrity&&(d.integrity=a.integrity),a.referrerPolicy&&(d.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?d.credentials="include":a.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function o(a){if(a.ep)return;a.ep=!0;const d=n(a);fetch(a.href,d)}})();const ae="https://wnwftbamyaotqdsivmas.supabase.co",re="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo";let m;window.supabase?m=window.supabase.createClient(ae,re):(console.error("Error Fatal: Librería Supabase no encontrada. La aplicación no funcionará."),m=null);let b=[],w=[],S=null,ee={};function y(t){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(t)}function te(t){const e={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(t).toLocaleDateString("es-MX",e)}function de(t){if(!t)return{start:null,end:null};const[e,n]=t.split("-").map(Number),o=new Date(e,n-1,1),a=new Date(e,n,1),d=o.toISOString().substring(0,10),r=a.toISOString().substring(0,10);return{start:d,end:r}}window.openModal=function(t){const e=document.getElementById(t);e&&(e.classList.add("flex"),e.classList.remove("hidden"))};window.closeModal=function(t){const e=document.getElementById(t);e&&(e.classList.add("hidden"),e.classList.remove("flex"))};async function k(){const{data:{user:t}}=await m.auth.getUser(),e=document.getElementById("auth-container"),n=document.getElementById("dashboard-container");if(!e||!n){console.error("Error: Los contenedores 'auth-container' o 'dashboard-container' no se encontraron en el HTML.");return}t?(e.classList.add("hidden"),n.classList.remove("hidden"),await $()):(e.classList.remove("hidden"),n.classList.add("hidden"))}async function ie(t){t.preventDefault();const e=document.getElementById("email").value,n=document.getElementById("password").value,{error:o}=await m.auth.signInWithPassword({email:e,password:n});o?alert(o.message):k()}async function le(){await m.auth.signOut(),k()}async function ce(){const t=document.getElementById("sales-month-filter"),e=document.getElementById("filter-status"),n=t==null?void 0:t.value,{start:o,end:a}=de(n);let d=m.from("ventas").select("total_amount"),r="Total histórico";o&&a&&(d=d.gte("created_at",o).lt("created_at",a),r=`Total del mes de ${new Date(o).toLocaleDateString("es-ES",{year:"numeric",month:"long"})}`);const{data:c,error:l}=await d;if(l){console.error("Error al cargar ventas:",l),document.getElementById("total-sales").textContent=y(0),e&&(e.textContent="Error al cargar");return}const s=c.reduce((v,f)=>v+f.total_amount,0);document.getElementById("total-sales").textContent=y(s),e&&(e.textContent=r);const{data:g,error:p}=await m.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",0);if(p){console.error("Error al cargar deudas:",p),document.getElementById("total-debt").textContent=y(0);return}const u=g.reduce((v,f)=>v+f.saldo_pendiente,0);document.getElementById("total-debt").textContent=y(u)}async function se(){const{data:t,error:e}=await m.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name)").gt("saldo_pendiente",.01).order("created_at",{ascending:!1}).limit(5);if(e){console.error("Error al cargar tabla de deudas:",e);return}const n=document.getElementById("debt-sales-body");if(!n)return;n.innerHTML="";const o=document.getElementById("no-debt-message");if(o&&o.classList.add("hidden"),t.length===0){o&&o.classList.remove("hidden");return}t.forEach(a=>{var c;const d=((c=a.clientes)==null?void 0:c.name)||"Cliente Desconocido",r=document.createElement("tr");r.className="hover:bg-gray-50",r.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.venta_id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">${y(a.saldo_pendiente)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button 
                    onclick="openSaleDetailModal(${a.venta_id})" 
                    class="text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 rounded bg-indigo-100"
                >
                    Detalles/Pagar
                </button>
            </td>
        `,n.appendChild(r)})}async function ue(){const{data:t,error:e}=await m.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name), description").order("created_at",{ascending:!1}).limit(10);if(e){console.error("Error al cargar ventas recientes:",e);return}const n=document.getElementById("recent-sales-body"),o=document.getElementById("no-sales-message");if(n){if(n.innerHTML="",o&&o.classList.add("hidden"),t.length===0){o&&o.classList.remove("hidden");return}t.forEach(a=>{var c;const d=((c=a.clientes)==null?void 0:c.name)||"Cliente Desconocido",r=document.createElement("tr");r.className="hover:bg-gray-50",r.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.venta_id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${te(a.created_at)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${y(a.total_amount)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${a.saldo_pendiente>0?"text-red-600":"text-green-600"}">${y(a.saldo_pendiente)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="openSaleDetailModal(${a.venta_id})" class="text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 rounded bg-indigo-100">
                    Detalles
                </button>
            </td>
        `,n.appendChild(r)})}}async function $(){await ce(),await se(),await ue(),await A(),await _(),await Ee(),await M()}async function M(){const t=document.getElementById("client-select");if(!t)return;t.innerHTML='<option value="" disabled selected>Cargando clientes...</option>';const{data:e,error:n}=await m.from("clientes").select("client_id, name").order("name",{ascending:!0});if(n){console.error("Error al cargar clientes para venta:",n),t.innerHTML='<option value="" disabled selected>Error al cargar (revisar consola)</option>';return}if(e.length===0){t.innerHTML='<option value="" disabled selected>No hay clientes activos</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione un Cliente</option>',e.forEach(o=>{const a=document.createElement("option");a.value=o.client_id,a.textContent=o.name,t.appendChild(a)})}async function _(){if(!m){console.warn("Supabase no inicializado. No se pudieron cargar los productos.");return}const{data:t,error:e}=await m.from("productos").select("producto_id, name, type, price, parent_product");if(e){console.error("Error al cargar todos los productos:",e),b=[];return}b=t||[]}function me(){const t=document.getElementById("product-main-select"),e=document.getElementById("subproduct-select"),n=document.getElementById("product-unit-price");if(!t||!e||!n||typeof b>"u")return;const o=t.value;if(e.innerHTML='<option value="" selected>Sin Paquete</option>',e.disabled=!0,n.value="0.00",!o)return;if(!b.find(r=>String(r.producto_id)===String(o))){console.warn(`Producto principal con ID ${o} no encontrado.`);return}O(o);const d=b.filter(r=>r.type&&r.type.trim().toUpperCase()==="PACKAGE"&&r.parent_product&&String(r.parent_product)===String(o));d.length>0&&(e.disabled=!1,e.innerHTML='<option value="" disabled selected>Seleccione un Paquete</option>',d.forEach(r=>{const c=document.createElement("option");c.value=r.producto_id;const l=typeof y=="function"?y(r.price):`$${r.price.toFixed(2)}`;c.textContent=`${r.name} (${l})`,e.appendChild(c)}))}async function H(){const t=document.getElementById("product-main-select"),e=document.getElementById("subproduct-select"),n=document.getElementById("product-unit-price");if(!t||!e||!n)return;const o=b.filter(a=>a.type&&a.type.trim().toUpperCase()==="MAIN");if(e.innerHTML='<option value="" selected>Sin Paquete</option>',n.value="0.00",e.disabled=!0,o.length===0){t.innerHTML='<option value="" disabled selected>❌ No hay Productos Base (Tipo: MAIN)</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione Producto Base</option>',o.forEach(a=>{const d=document.createElement("option");d.value=a.producto_id,d.textContent=`${a.name}`,t.appendChild(d)})}async function ne(t){const e=document.getElementById(t);if(!e)return;const n=b.filter(o=>o.type&&o.type.trim().toUpperCase()==="MAIN");if(e.innerHTML='<option value="" disabled selected>Seleccione Producto Principal</option>',n.length===0){e.innerHTML='<option value="" disabled selected>❌ No hay Productos Base (Tipo: MAIN)</option>';return}n.forEach(o=>{const a=document.createElement("option");a.value=o.producto_id,a.textContent=`${o.name} ($${o.price.toFixed(2)})`,e.appendChild(a)})}function O(t){const e=document.getElementById("product-unit-price"),n=b.find(o=>String(o.producto_id)===String(t));e&&(n&&n.price!==void 0?e.value=n.price.toFixed(2):e.value="0.00")}function J(){const t=w.reduce((o,a)=>o+a.subtotal,0),e=document.getElementById("total-amount");e&&(e.value=t.toFixed(2)),F(t);const n=document.getElementById("submit-sale-btn");return w.length>0?n==null||n.removeAttribute("disabled"):n==null||n.setAttribute("disabled","true"),t}function P(){const t=document.getElementById("sale-items-container");if(t){if(t.innerHTML="",w.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">Agrega productos a la venta.</td></tr>',J();return}w.forEach((e,n)=>{const o=document.createElement("tr");o.className="hover:bg-gray-50",o.innerHTML=`
            <td class="px-6 py-3 text-sm font-medium text-gray-900">${e.name}</td>
            <td class="px-6 py-3 text-sm text-gray-500">${y(e.price)}</td>
            <td class="px-6 py-3 text-sm text-gray-500 text-center">${e.quantity}</td>
            <td class="px-6 py-3 text-sm font-bold">${y(e.subtotal)}</td>
            <td class="px-6 py-3 text-right text-sm font-medium">
                <button type="button" onclick="removeItemFromSale(${n})" 
                        class="text-red-600 hover:text-red-900">
                    <i class="fas fa-times-circle"></i>
                </button>
            </td>
        `,t.appendChild(o)}),J()}}window.removeItemFromSale=function(t){w.splice(t,1),P()};function pe(t){t.preventDefault();const e=document.getElementById("product-main-select"),n=document.getElementById("subproduct-select"),o=document.getElementById("product-quantity"),a=e==null?void 0:e.value,d=n==null?void 0:n.value,r=parseFloat(o==null?void 0:o.value);let c=d;c||(c=a);const l=String(c),s=b.find(E=>String(E.producto_id)===l);if(!s){alert("Por favor, selecciona un Producto o Paquete válido.");return}if(isNaN(r)||r<=0){alert("La cantidad debe ser mayor a cero.");return}let g=s.name;if(d){const E=b.find(B=>String(B.producto_id)===String(a));E&&(g=`${E.name} (${s.name})`)}const p=s.price,u=r*p,v={product_id:l,name:g,quantity:r,price:p,subtotal:u},f=w.findIndex(E=>E.product_id===l);f>-1?(w[f].quantity+=r,w[f].subtotal+=u):w.push(v),P(),e.value="",n.value="",o.value="1",O(null),H()}function F(t=null){const e=document.getElementById("paid-amount"),n=document.getElementById("payment-method"),o=document.getElementById("total-amount"),a=t||parseFloat(o==null?void 0:o.value)||0,d=n==null?void 0:n.value;let r=parseFloat(e==null?void 0:e.value)||0;d==="Deuda"?(r=0,e&&(e.value="0.00",e.readOnly=!0)):(e&&(e.readOnly=!1),r>a&&(r=a,e&&(e.value=a.toFixed(2))));const c=Math.max(0,a-r),l=document.getElementById("remaining-balance");l&&(l.value=c.toFixed(2)),e&&d!=="Deuda"&&e.setAttribute("max",a.toFixed(2))}async function ge(t){var g,p,u,v;t.preventDefault();const e=((g=document.getElementById("client-select"))==null?void 0:g.value)??null,n=((p=document.getElementById("payment-method"))==null?void 0:p.value)??"Efectivo",o=((u=document.getElementById("sale-description"))==null?void 0:u.value.trim())??null,a=((v=document.getElementById("paid-amount"))==null?void 0:v.value)??"0";let d=parseFloat(a);const r=w.reduce((f,E)=>f+E.subtotal,0);n==="Deuda"&&(d=0);const c=r-d;if(!e){alert("Por favor, selecciona un cliente.");return}if(w.length===0){alert("Debes agregar al menos un producto a la venta.");return}if(r<0){alert("El total de la venta no puede ser negativo.");return}let l=d,s=c;if(r===0&&(l=0,s=0),n!=="Deuda"&&(l<0||l>r)){alert("El monto pagado es inválido.");return}if(!(s>.01&&n!=="Deuda"&&!confirm(`¡Atención! Hay un saldo pendiente de ${y(s)}. ¿Deseas continuar registrando esta cantidad como deuda?`)))try{const{data:f,error:E}=await m.from("ventas").insert([{client_id:e,total_amount:r,paid_amount:l,saldo_pendiente:s,metodo_pago:n,description:o}]).select("venta_id");if(E||!f||f.length===0){console.error("Error al insertar venta:",E),alert(`Error al registrar la venta: ${(E==null?void 0:E.message)||"Desconocido"}`);return}const B=f[0].venta_id,D=w.map(x=>({venta_id:B,product_id:x.product_id,name:x.name,quantity:x.quantity,price:x.price,subtotal:x.subtotal})),{error:L}=await m.from("detalle_ventas").insert(D);if(L&&(console.error("Error al insertar detalles de venta:",L),alert(`Venta registrada (ID: ${B}), pero falló el registro de detalles: ${L.message}`)),l>0){const{error:x}=await m.from("pagos").insert([{venta_id:B,amount:l,client_id:e,metodo_pago:n}]);x&&(console.error("Error al registrar pago inicial:",x),alert(`Advertencia: El pago inicial falló. ${x.message}`))}alert("Venta registrada exitosamente."),closeModal("new-sale-modal"),await $()}catch(f){console.error("Error fatal al registrar la venta:",f.message),alert("Error fatal al registrar la venta: "+f.message)}finally{w=[],P(),document.getElementById("new-sale-form").reset()}}async function A(){const t=document.getElementById("clients-list-body");if(!t){console.error("Contenedor de clientes ('clients-list-body') no encontrado.");return}if(!m){console.error("Supabase no está inicializado.");return}try{const{data:e,error:n}=await m.from("clientes").select("client_id, name, telefono").order("name",{ascending:!0});if(n){console.error("Error al cargar clientes:",n.message);return}allClients=e,t.innerHTML="",e.forEach(o=>{const a=document.createElement("tr");a.className="hover:bg-gray-50",a.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${o.client_id}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${o.name}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${o.telefono||"N/A"}</td>
                
                <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                    <button type="button" class="edit-client-btn text-indigo-600 hover:text-indigo-900 mr-2" 
                            data-client-id="${o.client_id}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button type="button" class="delete-client-btn text-red-600 hover:text-red-900" 
                            data-client-id="${o.client_id}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </td>
            `,t.appendChild(a)})}catch(e){console.error("Error inesperado en loadClientsTable:",e)}}async function V(t){t.preventDefault();const e=document.getElementById("name").value,n=document.getElementById("phone").value,{error:o}=await m.from("clientes").insert([{name:e,telefono:n,is_active:!0}]);o?alert("Error al registrar cliente: "+o.message):(alert("Cliente registrado exitosamente."),await oe(),closeModal("modal-new-client"),document.getElementById("client-form").reset(),await A(),await M())}function ye(t){const e=allClients.find(n=>String(n.client_id)===String(t));if(!e){alert("Error: Cliente no encontrado en los datos cargados.");return}document.getElementById("edit-client-id").value=e.client_id,document.getElementById("edit-client-name").value=e.name||"",document.getElementById("edit-client-phone").value=e.telefono||"",openModal("edit-client-modal")}async function X(t){t.preventDefault();const e=document.getElementById("edit-client-id").value,n=document.getElementById("edit-client-name").value.trim(),o=document.getElementById("edit-client-phone").value.trim();if(!e){alert("Error de Edición: No se pudo obtener la ID del cliente.");return}const{error:a}=await m.from("clientes").update({name:n,telefono:o}).eq("client_id",e);a?alert("Error al actualizar cliente: "+a.message):(alert("Cliente actualizado exitosamente."),document.getElementById("edit-client-form").reset(),closeModal("edit-client-modal"),await A(),await M())}async function fe(t){var g;if(t.preventDefault(),!m||!S){alert("Error: Supabase no está disponible o el ID del producto a editar es desconocido.");return}const e=document.getElementById("edit-product-name"),n=document.getElementById("edit-product-type"),o=document.getElementById("edit-sale-price"),a=e.value.trim(),d=n.value,r=parseFloat(o.value);let c=null;if(isNaN(r)||r<0||o.value.trim()===""){alert("El precio de venta debe ser un número válido (mayor o igual a cero).");return}if(d==="PACKAGE"){const p=document.getElementById("edit-parent-product-select");if(c=(p==null?void 0:p.value)||null,!c){alert("Los paquetes deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const l={name:a,type:d,price:r,parent_product:c},{error:s}=await m.from("productos").update(l).eq("producto_id",S);s?(console.error("Error de Supabase al actualizar producto:",s.message),alert("Error al actualizar producto: "+s.message)):(alert("Producto actualizado exitosamente."),closeModal("modal-edit-product"),S=null,(g=document.getElementById("edit-product-form"))==null||g.reset(),await _(),await T())}function j(){const t=document.getElementById("new-product-type"),e=document.getElementById("parent-product-container"),n=document.getElementById("parent-product-select");!t||!e||!n||(t.value==="PACKAGE"?(e.classList.remove("hidden"),e.classList.add("block"),n.setAttribute("required","required")):(e.classList.add("hidden"),e.classList.remove("block"),n.removeAttribute("required"),n.value=""))}async function Ee(){await _();const t=document.getElementById("products-table-body");if(!t)return;t.innerHTML="";const e=b;if(e.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">No hay productos registrados.</td></tr>';return}e.forEach(n=>{const o=document.createElement("tr");o.className="hover:bg-gray-50",o.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.producto_id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${n.type}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${y(n.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-product-id="${n.producto_id}" class="text-indigo-600 hover:text-indigo-900 edit-product-btn mr-2">Editar</button>
                <button data-product-id="${n.producto_id}" class="text-red-600 hover:text-red-900 delete-product-btn">Eliminar</button>
            </td>
        `,t.appendChild(o)}),document.querySelectorAll(".edit-product-btn").forEach(n=>{n.onclick=()=>{const o=n.getAttribute("data-product-id");openEditProductModal(o)}}),document.querySelectorAll(".delete-product-btn").forEach(n=>{n.onclick=()=>{const o=n.getAttribute("data-product-id");handleDeleteProduct(o)}})}async function he(t){var s;if(t.preventDefault(),!m){alert("Error de conexión: Supabase no está disponible.");return}const e=document.getElementById("new-product-name"),n=document.getElementById("new-product-type"),o=document.getElementById("new-product-price");if(!e||!n||!o){console.error("Error FATAL: No se encontraron todos los campos del formulario en el DOM. Verifique los IDs."),alert("Error al intentar guardar el producto. Verifique los IDs en la consola.");return}const a=e.value.trim(),d=n.value,r=parseFloat(o.value);let c=null;if(isNaN(r)||r<0||o.value.trim()===""){alert("El precio unitario debe ser un número válido (mayor o igual a cero).");return}if(d==="PACKAGE"){const g=document.getElementById("parent-product-select");if(c=(g==null?void 0:g.value)||null,!c){alert("Los paquetes deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const{error:l}=await m.from("productos").insert([{name:a,type:d,price:r,parent_product:c}]);l?(console.error("Error de Supabase al registrar producto:",l.message),alert("Error al registrar producto: "+l.message)):(alert("Producto registrado exitosamente."),closeModal("modal-register-product"),(s=document.getElementById("new-product-form"))==null||s.reset(),await _(),await T())}function ve(t){const e=b.find(o=>String(o.producto_id)===String(t));if(!e){alert("Error: Producto no encontrado para edición.");return}document.getElementById("product-id").value=e.producto_id,document.getElementById("edit-product-name").value=e.name,document.getElementById("edit-product-type").value=e.type,document.getElementById("edit-sale-price").value=e.price||0;const n=document.getElementById("edit-parent-product-container");e.type==="PACKAGE"?(n.classList.remove("hidden"),ne("edit-parent-product-select"),document.getElementById("edit-parent-product-select").value=e.parent_product):n.classList.add("hidden"),document.getElementById("product-modal-title").textContent="Editar Producto: "+e.name}function Q(t){S=t,ve(t),openModal("modal-edit-product")}let C=null;function W(t){C=t;const e=b.find(n=>String(n.producto_id)===String(t));e&&(document.getElementById("delete-product-name-placeholder").textContent=e.name),openModal("modal-delete-confirmation")}async function be(){if(!C)return;const{error:t}=await m.from("productos").delete().eq("producto_id",C);t?(console.error("Error al eliminar producto:",t.message),alert("Error al eliminar producto: "+t.message)):(alert("Producto eliminado exitosamente."),closeModal("modal-delete-confirmation"),C=null,await _(),await T())}let q=null;function we(t){q=t;const e=allClients.find(n=>String(n.client_id)===String(t));if(e){const n=document.getElementById("delete-client-name-placeholder");n&&(n.textContent=e.name)}openModal("client-delete-confirmation")}async function xe(){const t=q;if(!t)return;const{error:e}=await m.from("clientes").delete().eq("client_id",t);e?alert("Error al eliminar cliente: "+e.message):(alert("Cliente eliminado exitosamente."),closeModal("client-delete-confirmation"),q=null,await A(),await M())}var Z;(Z=document.getElementById("confirm-delete-client-btn"))==null||Z.addEventListener("click",xe);window.openSaleDetailModal=async function(t){var c;const{data:e,error:n}=await m.from("ventas").select(`
            *, 
            clientes(name, telefono), 
            detalle_ventas(*), 
            pagos(*)
        `).eq("venta_id",t).single();if(n||!e){console.error("Error al cargar detalles de la venta:",n),alert("Error al cargar detalles de la venta.");return}document.getElementById("detail-sale-id").textContent=`#${e.venta_id}`,document.getElementById("detail-client-name").textContent=((c=e.clientes)==null?void 0:c.name)||"N/A",document.getElementById("detail-date").textContent=te(e.created_at),document.getElementById("detail-total-amount").textContent=y(e.total_amount),document.getElementById("detail-saldo-pendiente").textContent=y(e.saldo_pendiente),document.getElementById("detail-comments").textContent=e.description||"Sin comentarios";const o=document.getElementById("detail-items-body");o.innerHTML="",e.detalle_ventas.forEach(l=>{o.innerHTML+=`
            <tr>
                <td class="px-6 py-2 whitespace-nowrap">${l.name}</td>
                <td class="px-6 py-2 whitespace-nowrap text-center">${l.quantity}</td>
                <td class="px-6 py-2 whitespace-nowrap text-right">${y(l.price)}</td>
                <td class="px-6 py-2 whitespace-nowrap text-right font-semibold">${y(l.subtotal)}</td>
            </tr>
        `});const a=document.getElementById("detail-payments-body");a.innerHTML="",e.pagos.sort((l,s)=>new Date(s.created_at)-new Date(l.created_at)),e.pagos.length===0?a.innerHTML='<tr><td colspan="3" class="px-6 py-2 text-center text-gray-500">No hay abonos registrados.</td></tr>':e.pagos.forEach(l=>{const s=new Date(l.created_at).toLocaleDateString("es-MX",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});a.innerHTML+=`
                <tr>
                    <td class="px-6 py-2 whitespace-nowrap">${s}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-right font-semibold text-green-700">${y(l.amount)}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-center">${l.metodo_pago}</td>
                </tr>
            `}),document.getElementById("payment-sale-id").value=e.venta_id,document.getElementById("abono-amount").value="";const d=document.getElementById("abono-amount");d&&(d.setAttribute("max",e.saldo_pendiente.toFixed(2)),d.setAttribute("placeholder",`Máx ${y(e.saldo_pendiente)}`));const r=document.getElementById("submit-abono-btn");r&&(r.disabled=e.saldo_pendiente<=.01,r.textContent=e.saldo_pendiente<=.01?"Pagado":"Abonar"),openModal("modal-detail-sale")};async function N(){const t=document.getElementById("report-month-selector"),e=document.getElementById("monthly-sales-report-body"),n=document.getElementById("report-total-sales"),o=document.getElementById("monthly-report-no-data"),a=t?t.value:null;let d,r;if(a){const[u,v]=a.split("-").map(Number);d=new Date(u,v-1,1),r=new Date(u,v,0),r.setHours(23,59,59,999)}else{const u=new Date;d=new Date(u.getFullYear(),u.getMonth(),1),r=new Date(u.getFullYear(),u.getMonth()+1,0),r.setHours(23,59,59,999)}const c=d.toISOString(),l=r.toISOString(),{data:s,error:g}=await m.from("ventas").select(`
            venta_id, 
            created_at, 
            client_id, 
            total_amount, 
            saldo_pendiente, 
            metodo_pago, 
            description
        `).gte("created_at",c).lte("created_at",l).order("created_at",{ascending:!1});if(g){console.error("Error al cargar reporte de ventas:",g.message),alert("Error al cargar reporte de ventas. Consulte la consola."),e.innerHTML="",n.textContent="$0.00",o.classList.remove("hidden");return}let p=0;e.innerHTML="",s&&s.length>0?(o.classList.add("hidden"),s.forEach(u=>{p+=u.total_amount;const v=new Date(u.created_at).toLocaleDateString("es-MX",{year:"numeric",month:"short",day:"numeric"}),f=ee[u.client_id]||"N/A",E=e.insertRow();E.className="hover:bg-gray-50",E.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap">${u.venta_id}</td>
                <td class="px-3 py-3 whitespace-nowrap">${v}</td>
                <td class="px-3 py-3 whitespace-nowrap">${f}</td>
                <td class="px-3 py-3 whitespace-nowrap font-semibold">${y(u.total_amount)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-red-600">${y(u.saldo_pendiente)}</td>
                <td class="px-3 py-3 whitespace-nowrap">${u.metodo_pago}</td>
                <td class="px-3 py-3 whitespace-nowrap">${u.description||"-"}</td>
            `})):o.classList.remove("hidden"),n.textContent=y(p)}function Ie(){const t=document.getElementById("report-month-selector");if(!t)return;t.innerHTML="";const e=new Date,n=e.getFullYear(),o=e.getMonth(),a=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];for(let d=0;d<12;d++){const r=new Date(n,o-d,1),c=r.getFullYear(),l=r.getMonth(),s=`${c}-${String(l+1).padStart(2,"0")}`,g=`${a[l]} ${c}`,p=document.createElement("option");p.value=s,p.textContent=g,d===0&&(p.selected=!0),t.appendChild(p)}}async function Be(){const{data:t,error:e}=await m.from("clientes").select("client_id, name");if(e){console.error("Error al cargar datos de clientes para el mapa:",e);return}ee=t.reduce((n,o)=>(n[o.client_id]=o.name,n),{})}async function oe(){const t=document.getElementById("clients-list-body"),e=document.getElementById("clients-list-controls"),n=document.getElementById("toggle-clients-list"),o=document.getElementById("client-count-summary"),{data:a,error:d}=await m.from("clientes").select("client_id, name, phone").order("client_id",{ascending:!1});if(d){console.error("Error al cargar clientes:",d.message);return}t.innerHTML="";const r=10,c=a.length;let l=!1;if(a.forEach((s,g)=>{const p=!l&&g>=r,u=t.insertRow();u.className=p?"hidden":"hover:bg-gray-50",u.dataset.clientId=s.client_id,u.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${s.client_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">${s.name}</td>
            <td class="px-3 py-2 whitespace-nowrap">${s.phone||"-"}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button data-client-id="${s.client_id}" class="edit-client-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button data-client-id="${s.client_id}" class="delete-client-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `}),c>r){e.classList.remove("hidden"),o.textContent=`Mostrando ${r} de ${c} clientes.`;const s=()=>{l=!l,t.querySelectorAll("tr").forEach((p,u)=>{u>=r&&p.classList.toggle("hidden",!l)}),n.textContent=l?"Mostrar menos":`Mostrar los ${c-r} restantes`,o.textContent=l?`Mostrando todos (${c}) clientes.`:`Mostrando ${r} de ${c} clientes.`};n.onclick=s,s()}else e.classList.add("hidden")}async function T(){const t=document.getElementById("products-table-body");if(!t){console.error("Error: No se encontró el <tbody> con ID 'products-table-body'.");return}if(t.innerHTML="",b.length===0){t.innerHTML='<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay productos registrados.</td></tr>';return}b.forEach(e=>{let n="";if(e.type==="PACKAGE")if(e.parent_product){const r=b.find(c=>String(c.producto_id)===String(e.parent_product));n=r?`<span class="text-xs text-gray-500 ml-1">(Padre: ${r.name})</span>`:'<span class="text-xs text-red-500 ml-1">(ID Padre No Válida/Eliminada)</span>'}else n='<span class="text-xs text-red-500 ml-1">(Sin Padre Asociado)</span>';const o=e.type==="PACKAGE"?"Paquete/Servicio":"Producto Individual",a=e.price?parseFloat(e.price).toFixed(2):"0.00",d=t.insertRow();d.className="hover:bg-gray-50",d.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${e.producto_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">
                ${e.name} ${n}
            </td>
            <td class="px-3 py-2 whitespace-nowrap">${o}</td>
            <td class="px-3 py-2 whitespace-nowrap">$${a}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button data-product-id="${e.producto_id}" class="edit-product-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button data-product-id="${e.producto_id}" class="delete-product-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `})}document.addEventListener("DOMContentLoaded",async()=>{var t,e,n,o,a,d,r,c,l,s,g,p,u,v,f,E,B,D,L,x,R,Y,z,U,K,G;k(),await _(),await Be(),(t=document.getElementById("open-sale-modal-btn"))==null||t.addEventListener("click",async()=>{var i;try{(i=document.getElementById("new-sale-form"))==null||i.reset(),await M(),await _(),H(),w=[],P(),document.getElementById("total-amount").value="0.00",document.getElementById("paid-amount").value="0.00",document.getElementById("remaining-balance").value="0.00",openModal("new-sale-modal")}catch(h){console.error("Error al cargar datos del modal de venta:",h),alert("Error al cargar los datos. Revise la consola (F12).")}}),document.querySelectorAll("[data-close-modal]").forEach(i=>{i.addEventListener("click",h=>{h.preventDefault();const I=i.getAttribute("data-close-modal");closeModal(I)})}),(e=document.getElementById("new-sale-form"))==null||e.addEventListener("submit",ge),(n=document.getElementById("paid-amount"))==null||n.addEventListener("input",()=>F()),(o=document.getElementById("payment-method"))==null||o.addEventListener("change",()=>F()),(a=document.getElementById("add-product-btn"))==null||a.addEventListener("click",pe),Ie(),H(),(d=document.getElementById("report-month-selector"))==null||d.addEventListener("change",N),N(),(r=document.getElementById("login-form"))==null||r.addEventListener("submit",ie),(c=document.getElementById("logout-btn"))==null||c.addEventListener("click",le),(l=document.getElementById("sales-month-filter"))==null||l.addEventListener("change",()=>{$()}),(s=document.getElementById("reset-sales-filter"))==null||s.addEventListener("click",()=>{const i=document.getElementById("sales-month-filter");i&&(i.value=""),$()}),(g=document.getElementById("open-monthly-report-btn"))==null||g.addEventListener("click",()=>{N(),openModal("modal-monthly-report")}),(p=document.getElementById("admin-clients-btn"))==null||p.addEventListener("click",()=>{openModal("modal-admin-clients"),oe()}),(u=document.getElementById("open-register-client-modal-btn"))==null||u.addEventListener("click",()=>{document.getElementById("client-modal-title").textContent="Registrar Nuevo Cliente";const i=document.getElementById("new-client-form");i==null||i.reset(),i==null||i.removeEventListener("submit",X),i==null||i.addEventListener("submit",V),openModal("modal-register-client")}),(v=document.getElementById("new-client-form"))==null||v.addEventListener("submit",V),(f=document.getElementById("open-admin-products-modal"))==null||f.addEventListener("click",async()=>{try{await _(),await T(),openModal("admin-products-modal")}catch(i){console.error("Error al cargar la administración de productos:",i),alert("Error al cargar la lista de productos.")}}),(E=document.getElementById("open-product-modal-btn"))==null||E.addEventListener("click",()=>{var i;closeModal("admin-products-modal"),(i=document.getElementById("new-product-form"))==null||i.reset(),j(),openModal("modal-register-product")}),(B=document.getElementById("new-product-type"))==null||B.addEventListener("change",i=>{j(),i.target.value==="PACKAGE"&&ne("parent-product-select")}),(D=document.getElementById("new-product-form"))==null||D.addEventListener("submit",he),(L=document.getElementById("products-table-body"))==null||L.addEventListener("click",i=>{if(!i.target.hasAttribute("data-product-id"))return;const h=i.target.getAttribute("data-product-id");i.target.classList.contains("edit-product-btn")&&(i.preventDefault(),Q(h)),i.target.classList.contains("delete-product-btn")&&(i.preventDefault(),W(h))}),(x=document.getElementById("clients-list-body"))==null||x.addEventListener("click",i=>{const h=i.target.closest("[data-client-id]");if(!h)return;const I=h.getAttribute("data-client-id");h.classList.contains("edit-client-btn")&&(i.preventDefault(),ye(I)),h.classList.contains("delete-client-btn")&&(i.preventDefault(),we(I))}),(R=document.getElementById("edit-client-form"))==null||R.addEventListener("submit",X),document.addEventListener("click",i=>{document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(I=>{i.target===I&&closeModal(I.id)})}),document.querySelectorAll("[data-open-modal]").forEach(i=>{i.addEventListener("click",h=>{h.preventDefault();const I=i.getAttribute("data-open-modal");openModal(I)})}),(Y=document.getElementById("products-table-body"))==null||Y.addEventListener("click",i=>{if(!i.target.hasAttribute("data-product-id"))return;const h=i.target.getAttribute("data-product-id");i.target.classList.contains("edit-product-btn")&&(i.preventDefault(),Q(h)),i.target.classList.contains("delete-product-btn")&&(i.preventDefault(),W(h))}),(z=document.getElementById("confirm-delete-btn"))==null||z.addEventListener("click",be),(U=document.getElementById("edit-product-form"))==null||U.addEventListener("submit",fe),(K=document.getElementById("product-main-select"))==null||K.addEventListener("change",me),(G=document.getElementById("subproduct-select"))==null||G.addEventListener("change",i=>{O(i.target.value)}),document.addEventListener("keydown",i=>{if(i.key==="Escape"){const h=document.querySelectorAll(".modal-overlay:not(.hidden)"),I=h[h.length-1];I&&closeModal(I.id)}})});
