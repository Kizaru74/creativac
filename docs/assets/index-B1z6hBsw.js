(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const d of n)if(d.type==="childList")for(const l of d.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function a(n){const d={};return n.integrity&&(d.integrity=n.integrity),n.referrerPolicy&&(d.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?d.credentials="include":n.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function o(n){if(n.ep)return;n.ep=!0;const d=a(n);fetch(n.href,d)}})();const me="https://wnwftbamyaotqdsivmas.supabase.co",pe="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo";let s,x=[],_=[],T=null,D=null,H=[],ge={};window.supabase?s=window.supabase.createClient(me,pe):(console.error("Error Fatal: Librería Supabase no encontrada. La aplicación no funcionará."),s=null);window.loadDashboardMetrics=async function(){if(!s){console.error("Supabase no está inicializado para cargar métricas.");return}try{const{data:t,error:e}=await s.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",.01);if(e)throw e;let a=0;t&&t.length>0&&(a=t.reduce((i,c)=>i+parseFloat(c.saldo_pendiente||0),0));const{data:o,error:n}=await s.from("ventas").select("total_amount").not("total_amount","is",null);if(n)throw n;let d=0;o&&o.length>0&&(d=o.reduce((i,c)=>i+parseFloat(c.total_amount||0),0));const l=document.getElementById("total-debt");l&&(l.textContent=y(a));const r=document.getElementById("historical-total-sales");r&&(r.textContent=y(d))}catch(t){console.error("Error al cargar métricas del dashboard:",t)}};function y(t){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(t)}function q(t){const e={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(t).toLocaleDateString("es-MX",e)}window.openModal=function(t){const e=document.getElementById(t);e&&(e.classList.add("flex"),e.classList.remove("hidden"))};window.closeModal=function(t){const e=document.getElementById(t);e&&(e.classList.add("hidden"),e.classList.remove("flex"))};async function G(){const{data:{user:t}}=await s.auth.getUser(),e=document.getElementById("auth-container"),a=document.getElementById("dashboard-container");if(!e||!a){console.error("Error: Los contenedores 'auth-container' o 'dashboard-container' no se encontraron en el HTML.");return}t?(e.classList.add("hidden"),a.classList.remove("hidden"),await C()):(e.classList.remove("hidden"),a.classList.add("hidden"))}async function xe(t){t.preventDefault();const e=document.getElementById("email").value,a=document.getElementById("password").value,{error:o}=await s.auth.signInWithPassword({email:e,password:a});o?alert(o.message):G()}async function _e(){await s.auth.signOut(),G()}async function Be(){try{const{data:t,error:e}=await s.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name, client_id)").gt("saldo_pendiente",.01).order("created_at",{ascending:!1}).limit(5);if(e){console.error("Error al cargar tabla de deudas:",e);return}const a=document.getElementById("debt-sales-body");if(!a)return;a.innerHTML="";const o=document.getElementById("no-debt-message");if(o&&o.classList.add("hidden"),t.length===0){o&&o.classList.remove("hidden");return}t.forEach(n=>{var i,c;const d=((i=n.clientes)==null?void 0:i.name)||"Cliente Desconocido",l=(c=n.clientes)==null?void 0:c.client_id,r=document.createElement("tr");r.className="hover:bg-gray-50",r.innerHTML=`
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.venta_id}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-red-600">${y(n.saldo_pendiente)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                        type="button" 
                        class="view-debt-btn" 
                        data-client-id="${l}" 
                        data-sale-id="${n.venta_id}" // Si necesitas la venta, mantenla
        class="view-debt-btn bg-red-600 hover:bg-red-700 text-white font-semibold text-xs py-1 px-2 rounded"
                    >
                        Detalles/Pagar
                    </button>
                </td>
            `,a.appendChild(r)}),a.querySelectorAll(".view-debt-btn").forEach(n=>{n.addEventListener("click",()=>{const d=n.dataset.clientId;handleViewClientDebt(d)})})}catch(t){console.error("Error inesperado en loadDebts:",t)}}async function Le(){try{const{data:t,error:e}=await s.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name, client_id), description").order("created_at",{ascending:!1}).limit(7);if(e){console.error("Error al cargar ventas recientes:",e);return}const a=document.getElementById("recent-sales-body"),o=document.getElementById("no-sales-message");if(!a)return;if(a.innerHTML="",o&&o.classList.add("hidden"),t.length===0){o&&o.classList.remove("hidden");return}t.forEach(n=>{var i,c;const d=((i=n.clientes)==null?void 0:i.name)||"Cliente Desconocido",l=(c=n.clientes)==null?void 0:c.client_id,r=document.createElement("tr");r.className="hover:bg-gray-50",r.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.venta_id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${q(n.created_at)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${y(n.total_amount)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${n.saldo_pendiente>0?"text-red-600":"text-green-600"}">${y(n.saldo_pendiente)}</td>
                
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"> 
                    <button type="button" 
                            class="view-sale-details-btn text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 rounded bg-indigo-100"
                            data-sale-id="${n.venta_id}"
                            data-client-id="${l}"> 
                        Detalles
                    </button>
                </td>
            `,a.appendChild(r)}),a.querySelectorAll(".view-sale-details-btn").forEach(n=>{n.addEventListener("click",()=>{const d=n.dataset.saleId,l=n.dataset.clientId;handleViewSaleDetails(d,l)})})}catch(t){console.error("Error inesperado en loadRecentSales:",t)}}async function C(){await Be(),await Le(),await M("gestion"),await S(),await Te(),await fe()}async function fe(){const t=document.getElementById("client-select");if(!t)return;t.innerHTML='<option value="" disabled selected>Cargando clientes...</option>';const{data:e,error:a}=await s.from("clientes").select("client_id, name").order("name",{ascending:!0});if(a){console.error("Error al cargar clientes para venta:",a),t.innerHTML='<option value="" disabled selected>Error al cargar (revisar consola)</option>';return}if(e.length===0){t.innerHTML='<option value="" disabled selected>No hay clientes activos</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione un Cliente</option>',e.forEach(o=>{const n=document.createElement("option");n.value=o.client_id,n.textContent=o.name,t.appendChild(n)})}async function S(){if(!s){console.warn("Supabase no inicializado. No se pudieron cargar los productos.");return}const{data:t,error:e}=await s.from("productos").select("producto_id, name, type, price, parent_product");if(e){console.error("Error al cargar todos los productos:",e),x=[],window.allProductsMap={};return}x=t||[],window.allProductsMap=x.reduce((a,o)=>(a[o.producto_id]=o,a),{}),console.log(`✅ Mapa de productos cargado: ${Object.keys(window.allProductsMap).length} ítems.`)}function Ce(){const t=document.getElementById("product-main-select"),e=document.getElementById("subproduct-select"),a=document.getElementById("product-unit-price");if(!t||!e||!a||typeof x>"u")return;const o=t.value;if(e.innerHTML='<option value="" selected>Sin Paquete</option>',e.disabled=!0,a.value="0.00",!o)return;if(!x.find(l=>String(l.producto_id)===String(o))){console.warn(`Producto principal con ID ${o} no encontrado.`);return}K(o);const d=x.filter(l=>l.type&&l.type.trim().toUpperCase()==="PACKAGE"&&l.parent_product&&String(l.parent_product)===String(o));d.length>0&&(e.disabled=!1,e.innerHTML='<option value="" disabled selected>Seleccione un Paquete</option>',d.forEach(l=>{const r=document.createElement("option");r.value=l.producto_id;const i=typeof y=="function"?y(l.price):`$${l.price.toFixed(2)}`;r.textContent=`${l.name} (${i})`,e.appendChild(r)}))}async function O(){const t=document.getElementById("product-main-select"),e=document.getElementById("subproduct-select"),a=document.getElementById("product-unit-price");if(!t||!e||!a)return;const o=x.filter(n=>n.type&&n.type.trim().toUpperCase()==="MAIN");if(e.innerHTML='<option value="" selected>Sin Paquete</option>',a.value="0.00",e.disabled=!0,o.length===0){t.innerHTML='<option value="" disabled selected>❌ No hay Productos Base (Tipo: MAIN)</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione Producto Base</option>',o.forEach(n=>{const d=document.createElement("option");d.value=n.producto_id,d.textContent=`${n.name}`,t.appendChild(d)})}async function ye(t){const e=document.getElementById(t);if(!e)return;const a=x.filter(o=>o.type&&o.type.trim().toUpperCase()==="MAIN");if(e.innerHTML='<option value="" disabled selected>Seleccione Producto Principal</option>',a.length===0){e.innerHTML='<option value="" disabled selected>❌ No hay Productos Base (Tipo: MAIN)</option>';return}a.forEach(o=>{const n=document.createElement("option");n.value=o.producto_id,n.textContent=`${o.name} ($${o.price.toFixed(2)})`,e.appendChild(n)})}function K(t){const e=document.getElementById("product-unit-price"),a=x.find(o=>String(o.producto_id)===String(t));e&&(a&&a.price!==void 0?e.value=a.price.toFixed(2):e.value="0.00")}function R(t){const e=document.getElementById("paid-amount"),a=document.getElementById("display-saldo-pendiente"),o=document.getElementById("payment-method");if(!e||!o||!a)return;const n=o.value;let d=e.value.replace(",","."),l=parseFloat(d)||0;e.value.trim()===""&&(e.value="0.00"),n==="Deuda"&&(l=0,e.value="0.00");let r=t-l;t===0&&(r=0),a.value=y(r),a.classList.remove("bg-red-100","bg-green-100","text-red-700","text-green-700"),r>0?a.classList.add("bg-red-100","text-red-700"):(r<0,a.classList.add("bg-green-100","text-green-700"))}function F(){const t=_.reduce((o,n)=>o+n.subtotal,0);console.log("Grand Total calculado:",t);const e=document.getElementById("total-amount");e&&(e.value=t.toFixed(2)),R(t);const a=document.getElementById("submit-sale-btn");return _.length>0?a==null||a.removeAttribute("disabled"):a==null||a.setAttribute("disabled","true"),t}function k(){const t=document.getElementById("sale-items-container");if(t){if(t.innerHTML="",_.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">Agrega productos a la venta.</td></tr>',F();return}_.forEach((e,a)=>{const o=document.createElement("tr");o.className="hover:bg-gray-50",o.innerHTML=`
            <td class="px-6 py-3 text-sm font-medium text-gray-900">${e.name}</td>
            <td class="px-6 py-3 text-sm text-gray-500">${y(e.price)}</td>
            <td class="px-6 py-3 text-sm text-gray-500 text-center">${e.quantity}</td>
            <td class="px-6 py-3 text-sm font-bold">${y(e.subtotal)}</td>
            <td class="px-6 py-3 text-right text-sm font-medium">
                <button type="button" onclick="removeItemFromSale(${a})" 
                        class="text-red-600 hover:text-red-900">
                    <i class="fas fa-times-circle"></i>
                </button>
            </td>
        `,t.appendChild(o)}),F()}}window.removeItemFromSale=function(t){_.splice(t,1),k()};function Me(t){t.preventDefault();const e=document.getElementById("product-main-select"),a=document.getElementById("subproduct-select"),o=document.getElementById("product-quantity"),n=document.getElementById("product-unit-price"),d=e==null?void 0:e.value,l=a==null?void 0:a.value,r=parseFloat(o==null?void 0:o.value);let i=l;i||(i=d);const c=String(i),u=x.find(b=>String(b.producto_id)===c);if(!u){alert("Por favor, selecciona un Producto o Paquete válido.");return}if(isNaN(r)||r<=0){alert("La cantidad debe ser mayor a cero.");return}const m=n==null?void 0:n.value;let f=parseFloat(m==null?void 0:m.replace(",","."))||0;if(f===0&&u.price>0&&(f=u.price),f<=0){alert("El precio unitario no puede ser cero.");return}const h=r*f;let p=u.name;if(l){const b=x.find(L=>String(L.producto_id)===String(d));b&&(p=`${b.name} (${u.name})`)}const v={product_id:c,name:p,quantity:r,price:f,subtotal:h},w=_.findIndex(b=>b.product_id===c);w>-1?(_[w].quantity+=r,_[w].subtotal+=h):_.push(v),k(),e.value="",a.value="",o.value="1",K(null),O()}async function Se(t,e,a,o){if(!s||isNaN(o)||o<=0){alert("El precio debe ser un monto positivo.");return}try{const{data:n,error:d}=await s.from("detalle_ventas").select("quantity").eq("id",e).single();if(d||!n)throw new Error("No se pudo obtener el detalle del ítem.");const r=n.quantity*o,{error:i}=await s.from("detalle_ventas").update({price:o,subtotal:r}).eq("id",e);if(i)throw i;const{data:c,error:u}=await s.from("detalle_ventas").select("subtotal").eq("venta_id",t);if(u||!c)throw u;const m=c.reduce((p,v)=>p+v.subtotal,0),f=m,{error:h}=await s.from("ventas").update({total_amount:m,saldo_pendiente:f}).eq("venta_id",t);if(h)throw h;alert(`✅ Deuda de ${y(f)} registrada exitosamente.`),await M("gestion"),await handleViewClientDebt(a)}catch(n){console.error("Error al actualizar precio post-venta:",n),alert(`Error al actualizar la venta: ${n.message}`)}}async function De(t){if(!s)return{totalVentas:0,deudaNeta:0};try{const{data:e,error:a}=await s.from("transacciones_deuda").select("type, amount").eq("client_id",t);if(a)throw a;let o=0,n=0;return e.forEach(d=>{d.type==="cargo_venta"?(o+=d.amount,n+=d.amount):n-=d.amount}),n=Math.max(0,n),{totalVentas:o,deudaNeta:n}}catch(e){return console.error(`Error al obtener resumen del cliente ${t}:`,e),{totalVentas:0,deudaNeta:0}}}async function le(t){var l;if(t.preventDefault(),!s)return;const e=parseFloat(document.getElementById("abono-amount").value),a=(l=document.getElementById("abono-method"))==null?void 0:l.value;if(isNaN(e)||e<=0){alert("Por favor, ingresa un monto válido para el abono (mayor a cero).");return}if(!a||a===""){alert("Por favor, selecciona un Método de Pago.");return}const o=window.allClientsMap[D]!==void 0;let n=[],d=null;if(o){const r=D;d=r;const{data:i,error:c}=await s.from("ventas").select("venta_id, saldo_pendiente, client_id, created_at").eq("client_id",r).gt("saldo_pendiente",.01).order("created_at",{ascending:!0});if(c){console.error("Error al buscar ventas pendientes:",c),alert("Error al buscar ventas pendientes para abonar.");return}if(i.length===0){alert("El cliente no tiene ventas pendientes para abonar.");return}let u=e;for(const m of i){if(u<=0)break;const f=m.saldo_pendiente,h=Math.min(u,f);n.push({venta_id:m.venta_id,client_id:m.client_id,amount:h,new_saldo_pendiente:f-h}),u-=h}}else{const r=D,{data:i,error:c}=await s.from("ventas").select("saldo_pendiente, client_id").eq("venta_id",r).single();if(c||!i){alert("Error al obtener la venta para abonar.");return}if(e>i.saldo_pendiente){alert(`El abono excede el saldo pendiente (${y(i.saldo_pendiente)}). Ajuste el monto.`);return}d=i.client_id,n.push({venta_id:r,client_id:i.client_id,amount:e,new_saldo_pendiente:i.saldo_pendiente-e})}try{for(const i of n){const{error:c}=await s.from("pagos").insert([{venta_id:i.venta_id,client_id:i.client_id,amount:i.amount,metodo_pago:a}]);if(c)throw c;const{error:u}=await s.from("ventas").update({saldo_pendiente:i.new_saldo_pendiente}).eq("venta_id",i.venta_id);if(u)throw u}alert(`¡Abono de ${y(e)} registrado con éxito!`),document.getElementById("abono-client-form").reset(),closeModal("modal-record-abono");const r=document.getElementById("modal-client-debt-report");r&&!r.classList.contains("hidden")&&d&&await handleViewClientDebt(d),await C(),await M("gestion")}catch(r){console.error("Error al registrar abono:",r.message||r),alert("Hubo un error al registrar el abono. Intente nuevamente.")}D=null}async function $e(t){var u,m,f,h;t.preventDefault();const e=((u=document.getElementById("client-select"))==null?void 0:u.value)??null,a=((m=document.getElementById("payment-method"))==null?void 0:m.value)??"Efectivo",o=((f=document.getElementById("sale-description"))==null?void 0:f.value.trim())??null,n=((h=document.getElementById("paid-amount"))==null?void 0:h.value)??"0";let d=parseFloat(n);const l=_.reduce((p,v)=>p+v.subtotal,0);a==="Deuda"&&(d=0);const r=l-d;if(!e){alert("Por favor, selecciona un cliente.");return}if(_.length===0){alert("Debes agregar al menos un producto a la venta.");return}if(l<0){alert("El total de la venta no puede ser negativo.");return}let i=d,c=r;if(l===0&&(i=0,c=0),a!=="Deuda"&&(i<0||i>l)){alert("El monto pagado es inválido.");return}if(!(c>.01&&a!=="Deuda"&&!confirm(`¡Atención! Hay un saldo pendiente de ${y(c)}. ¿Deseas continuar registrando esta cantidad como deuda?`)))try{const{data:p,error:v}=await s.from("ventas").insert([{client_id:e,total_amount:l,paid_amount:i,saldo_pendiente:c,metodo_pago:a,description:o}]).select("venta_id");if(v||!p||p.length===0){console.error("Error al insertar venta:",v),alert(`Error al registrar la venta: ${(v==null?void 0:v.message)||"Desconocido"}`);return}const w=p[0].venta_id,b=_.map(B=>({venta_id:w,product_id:B.product_id,name:B.name,quantity:B.quantity,price:B.price,subtotal:B.subtotal})),{error:L}=await s.from("detalle_ventas").insert(b);if(L&&(console.error("Error al insertar detalles de venta:",L),alert(`Venta registrada (ID: ${w}), pero falló el registro de detalles: ${L.message}`)),i>0){const{error:B}=await s.from("pagos").insert([{venta_id:w,amount:i,client_id:e,metodo_pago:a}]);B&&(console.error("Error al registrar pago inicial:",B),alert(`Advertencia: El pago inicial falló. ${B.message}`))}closeModal("new-sale-modal"),await C(),await M("gestion"),be(w)}catch(p){console.error("Error fatal al registrar la venta:",p.message),alert("Error fatal al registrar la venta: "+p.message)}finally{_=[],k(),document.getElementById("new-sale-form").reset()}}let V=null;window.loadDashboardMetrics=async function(){if(!s){console.error("Supabase no está inicializado para cargar métricas.");return}try{const{data:t,error:e}=await s.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",.01);if(e)throw e;let a=0;t&&t.length>0&&(a=t.reduce((i,c)=>i+parseFloat(c.saldo_pendiente||0),0));const{data:o,error:n}=await s.from("ventas").select("total_amount").not("total_amount","is",null);if(n)throw n;let d=0;o&&o.length>0&&(d=o.reduce((i,c)=>i+parseFloat(c.total_amount||0),0));const l=document.getElementById("total-debt");l&&(l.textContent=y(a));const r=document.getElementById("historical-total-sales");r&&(r.textContent=y(d))}catch(t){console.error("Error al cargar métricas del dashboard:",t)}};window.handleViewClientDebt=async function(t){if(!s){console.error("Supabase no está inicializado.");return}window.viewingClientId=t;try{const e=H.find(i=>i.client_id.toString()===t.toString());if(!e){console.error("Cliente no encontrado para ID:",t),alert("Error: Cliente no encontrado.");return}const{data:a,error:o}=await s.from("transacciones_deuda").select("*").eq("client_id",t).order("created_at",{ascending:!0});if(o)throw o;document.getElementById("client-report-name").textContent=e.name;const n=document.getElementById("client-transactions-body");n.innerHTML="";let d=0;(a||[]).forEach(i=>{const c=parseFloat(i.amount);let u="",m="",f="";if(i.type==="cargo_venta")d+=c,m=`Venta: ${i.product_name||"Producto/Servicio"}`,u=y(c),f="text-red-600 font-bold";else{d-=c,u=`-${y(c)}`,f="text-green-600 font-bold";const b=i.metodo_pago?` (${i.metodo_pago})`:"";i.description&&i.description.includes("Pago Inicial")?m=`Pago Inicial de Venta${b}`:m=`Abono a Deuda${b}`}const h=Math.abs(d),p=y(h);let v="",w="Saldo: ";d>.01?(v="text-red-600 font-extrabold",w="Deuda: "):d<-.01?(v="text-green-600 font-extrabold",w="Crédito: "):(v="text-gray-700 font-extrabold",w="Saldado: "),n.innerHTML+=`
                <tr class="hover:bg-gray-50 text-sm">
                    <td class="px-3 py-3 whitespace-nowrap text-gray-500">${q(i.created_at)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-gray-800">${m}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-left ${f}">${u}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-left ${v}">${w}${p}</td>
                </tr>
            `});const l=y(Math.abs(d)),r=document.getElementById("client-report-total-debt");d>.01?(r.textContent=l,r.className="text-red-600 font-extrabold text-xl"):d<-.01?(r.textContent=`Crédito ${l}`,r.className="text-green-600 font-bold text-xl"):(r.textContent=y(0),r.className="text-gray-600 font-extrabold text-xl"),openModal("modal-client-debt-report")}catch(e){console.error("Error al cargar la deuda del cliente:",e),alert("Hubo un error al cargar el historial de deuda.")}};window.handleViewSaleDetails=async function(t,e){if(!s){console.error("Supabase no está inicializado.");return}const a=H.find(o=>o.client_id.toString()===e.toString());if(!a){console.error("Cliente no encontrado en allClients."),alert("Error: Cliente no encontrado para esta venta.");return}V=e;try{const{data:o,error:n}=await s.from("ventas").select("venta_id, total_amount, saldo_pendiente, created_at, description, metodo_pago").eq("venta_id",t).single();if(n||!o){console.error("Error al cargar detalles de la venta (Tabla Ventas):",n),alert("Error: No se encontró la venta principal (ID: "+t+") en la tabla 'ventas'.");return}const{data:d,error:l}=await s.from("detalle_ventas").select("detalle_id, quantity, price, subtotal, productos(name, parent_product)").eq("venta_id",t).order("detalle_id",{ascending:!0});if(l)throw l;const{data:r,error:i}=await s.from("pagos").select("amount, metodo_pago, created_at").eq("venta_id",t).order("created_at",{ascending:!0});if(i)throw i;document.getElementById("detail-sale-id").textContent=`#${o.venta_id}`,document.getElementById("detail-client-name").textContent=a.name,document.getElementById("detail-date").textContent=q(o.created_at),document.getElementById("detail-total-amount").textContent=y(o.total_amount),document.getElementById("detail-saldo-pendiente").textContent=y(o.saldo_pendiente),document.getElementById("detail-comments").textContent=o.description||"Sin comentarios.",document.getElementById("payment-sale-id").value=o.venta_id;const c=document.getElementById("detail-items-body");c.innerHTML="",(d||[]).forEach(p=>{const v=p.productos;let w="N/A";if(v&&v.parent_product&&window.allProductsMap){const b=window.allProductsMap[v.parent_product];b?w=b.name:w="Padre no cargado"}c.innerHTML+=`
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-3">
                        ${w!=="N/A"?w+" (":""}
                        <span class="font-semibold">${(v==null?void 0:v.name)||"Producto Desconocido"}</span>
                        ${w!=="N/A"?")":""}
                    </td> 
                    <td class="px-6 py-3 text-center">${p.quantity}</td>
                    <td class="px-6 py-3 text-right">${y(p.price)}</td>
                    <td class="px-6 py-3 text-right">${y(p.subtotal)}</td>
                </tr>
            `});const u=document.getElementById("detail-payments-body");u.innerHTML="",r.length===0?u.innerHTML='<tr><td colspan="3" class="px-6 py-3 text-center text-gray-500 italic">No hay pagos registrados para esta venta.</td></tr>':r.forEach(p=>{u.innerHTML+=`
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3">${q(p.created_at)}</td>
                        <td class="px-6 py-3 text-right font-semibold text-green-600">${y(p.amount)}</td>
                        <td class="px-6 py-3 text-center">${p.metodo_pago}</td>  
                    </tr>
                `});const m=document.getElementById("sale-edit-section"),f=document.getElementById("register-payment-form");if(parseFloat(o.total_amount)<.01&&parseFloat(o.saldo_pendiente)<.01){m.classList.remove("hidden"),f.classList.add("hidden");const p=(d||[])[0];document.getElementById("sale-edit-transaction-id").value=o.venta_id,p&&p.detalle_id?(document.getElementById("sale-edit-detail-id").value=p.detalle_id,document.getElementById("sale-edit-price").value=""):(m.classList.add("hidden"),f.classList.remove("hidden"))}else m.classList.add("hidden"),f.classList.remove("hidden");openModal("modal-detail-sale")}catch(o){console.error("Error al cargar detalles de venta:",o),alert("Hubo un error al cargar los detalles de la venta.")}};window.handleSaveNewPrice=async function(){var n,d,l;const t=(n=document.getElementById("sale-edit-transaction-id"))==null?void 0:n.value,e=(d=document.getElementById("sale-edit-detail-id"))==null?void 0:d.value,a=parseFloat((l=document.getElementById("sale-edit-price"))==null?void 0:l.value),o=V;if(!t||!e||isNaN(a)||a<=0||!o){alert("Faltan datos o el monto es inválido.");return}try{const{error:r}=await s.from("detalle_ventas").update({price:a,subtotal:a}).eq("detalle_id",e);if(r)throw r;const{error:i}=await s.from("ventas").update({total_amount:a,saldo_pendiente:a}).eq("venta_id",t);if(i)throw i;alert(`¡Precio de Venta #${t} actualizado a ${y(a)}!`),closeModal("modal-detail-sale"),await C(),await M("gestion")}catch(r){console.error("Error al guardar el nuevo precio:",r),alert("Error al guardar el nuevo precio.")}};window.handleUpdateSalePrice=async function(){var d,l,r;if(!s){alert("Error: Supabase no está inicializado.");return}const t=(d=document.getElementById("sale-edit-transaction-id"))==null?void 0:d.value,e=(l=document.getElementById("sale-edit-detail-id"))==null?void 0:l.value,a=(r=document.getElementById("sale-edit-price"))==null?void 0:r.value,o=V,n=parseFloat(a);if(!t||!e||isNaN(n)||n<=0||!o){alert("Por favor, ingrese un monto válido y asegúrese de que la venta se cargó correctamente.");return}try{const{error:i}=await s.from("detalle_ventas").update({price:n,subtotal:n}).eq("detalle_id",e);if(i)throw i;const{error:c}=await s.from("ventas").update({total_amount:n,saldo_pendiente:n}).eq("venta_id",t);if(c)throw c;alert(`¡Precio de Venta #${t} actualizado con éxito a ${y(n)}! El saldo pendiente es ahora ${y(n)}.`),closeModal("modal-detail-sale"),await M("gestion")}catch(i){console.error("Error al guardar el nuevo precio:",i),alert("Error al guardar el nuevo precio. Verifique la consola.")}};async function M(t="gestion"){if(!s){console.error("Supabase no está inicializado.");return}const e=document.getElementById("clients-list-body");if(!e){console.error("Contenedor de clientes ('clients-list-body') no encontrado.");return}const a=t==="gestion";try{const{data:o,error:n}=await s.from("clientes").select("client_id, name, telefono").order("name",{ascending:!0});if(n)throw n;H=o;const d=o.map(r=>De(r.client_id)),l=await Promise.all(d);e.innerHTML="",o.forEach((r,i)=>{const c=l[i],u=document.createElement("tr");u.className="hover:bg-gray-50";let m="";a?m=`
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" class="edit-client-btn text-indigo-600 hover:text-indigo-900 mr-2" 
                                        data-client-id="${r.client_id}">
                            <i class="fas fa-edit"></i> Editar
                
                <button type="button" class="delete-client-btn text-red-600 hover:text-red-900 mr-2" 
                 data-client-id="${r.client_id}" 
               data-client-name="${r.name}">
                 <i class="fas fa-trash"></i> Eliminar
                </button>

                     <button type="button" class="view-debt-btn text-blue-600 hover:text-blue-900" 
                        data-client-id="${r.client_id}" title="Ver ventas y abonos del cliente">
                        <i class="fas fa-file-invoice-dollar"></i> Ver Deuda
                    </button>
                    </td>
                `:m='<td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium"></td>',u.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${r.client_id}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${r.name}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${r.telefono||"N/A"}</td>
                
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">
                    $${c.totalVentas.toFixed(2)}
                </td>
                
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold 
                    ${c.deudaNeta>0?"text-red-600":"text-green-600"}">
                    $${c.deudaNeta.toFixed(2)}
                </td>
                
                ${m} 
            `,e.appendChild(u)}),a&&(e.querySelectorAll(".edit-client-btn").forEach(r=>{r.addEventListener("click",()=>{Ee(r.dataset.clientId)})}),e.querySelectorAll(".delete-client-btn").forEach(r=>{r.addEventListener("click",()=>{ve(r.dataset.clientId,r.dataset.clientName)})}),e.querySelectorAll(".view-debt-btn").forEach(r=>{r.addEventListener("click",()=>{handleViewClientDebt(r.dataset.clientId)})}))}catch(o){console.error("Error inesperado al cargar clientes:",o.message||o)}}async function Pe(t){t.preventDefault();const e=document.getElementById("name").value,a=document.getElementById("phone").value,{error:o}=await s.from("clientes").insert([{name:e,telefono:a,is_active:!0}]);if(o)alert("Error al registrar cliente: "+o.message);else{alert("Cliente registrado exitosamente."),await Re();const n=document.getElementById("client-form");n?n.reset():console.warn("Advertencia: No se encontró el formulario 'client-form' para resetear."),closeModal("modal-new-client"),await M()}}function Ee(t){if(!s){console.error("Supabase no está inicializado.");return}const e=H.find(d=>String(d.client_id)===String(t));if(!e){alert("Error: Cliente no encontrado para editar.");return}const a=document.getElementById("edit-client-id");a&&(a.value=e.client_id);const o=document.getElementById("edit-client-name");o&&(o.value=e.name);const n=document.getElementById("edit-client-phone");n&&(n.value=e.telefono||""),openModal("edit-client-modal")}async function ie(t){t.preventDefault();const e=document.getElementById("edit-client-id").value,a=document.getElementById("edit-client-name").value.trim(),o=document.getElementById("edit-client-phone").value.trim();if(!e){alert("Error de Edición: No se pudo obtener la ID del cliente.");return}const{error:n}=await s.from("clientes").update({name:a,telefono:o}).eq("client_id",e);n?(console.error("Error al actualizar cliente:",n),alert("Error al actualizar cliente: "+n.message)):(alert("Cliente actualizado exitosamente."),await C(),document.getElementById("edit-client-form").reset(),closeModal("edit-client-modal"))}async function Ae(t){var u;if(t.preventDefault(),!s||!T){alert("Error: Supabase no está disponible o el ID del producto a editar es desconocido.");return}const e=document.getElementById("edit-product-name"),a=document.getElementById("edit-product-type"),o=document.getElementById("edit-sale-price"),n=e.value.trim(),d=a.value,l=parseFloat(o.value);let r=null;if(isNaN(l)||l<0||o.value.trim()===""){alert("El precio de venta debe ser un número válido (mayor o igual a cero).");return}if(d==="PACKAGE"){const m=document.getElementById("edit-parent-product-select");if(r=(m==null?void 0:m.value)||null,!r){alert("Los paquetes deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const i={name:n,type:d,price:l,parent_product:r},{error:c}=await s.from("productos").update(i).eq("producto_id",T);c?(console.error("Error de Supabase al actualizar producto:",c.message),alert("Error al actualizar producto: "+c.message)):(alert("Producto actualizado exitosamente."),closeModal("modal-edit-product"),T=null,(u=document.getElementById("edit-product-form"))==null||u.reset(),await S(),await z())}function ce(){const t=document.getElementById("new-product-type"),e=document.getElementById("parent-product-container"),a=document.getElementById("parent-product-select");!t||!e||!a||(t.value==="PACKAGE"?(e.classList.remove("hidden"),e.classList.add("block"),a.setAttribute("required","required")):(e.classList.add("hidden"),e.classList.remove("block"),a.removeAttribute("required"),a.value=""))}async function Te(){const t=document.getElementById("products-table-body");if(!t)return;await S(),t.innerHTML="";const e=x;if(e.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">No hay productos registrados.</td></tr>';return}e.forEach(a=>{const o=document.createElement("tr");o.className="hover:bg-gray-50",o.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.producto_id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${a.type}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${y(a.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-product-id="${a.producto_id}" class="text-indigo-600 hover:text-indigo-900 edit-product-btn mr-2">Editar</button>
                <button data-product-id="${a.producto_id}" class="text-red-600 hover:text-red-900 delete-product-btn">Eliminar</button>
            </td>
        `,t.appendChild(o)}),document.querySelectorAll(".edit-product-btn").forEach(a=>{a.onclick=()=>{const o=a.getAttribute("data-product-id");openEditProductModal(o)}}),document.querySelectorAll(".delete-product-btn").forEach(a=>{a.onclick=()=>{const o=a.getAttribute("data-product-id");handleDeleteProduct(o)}})}async function Ne(t){var c;if(t.preventDefault(),!s){alert("Error de conexión: Supabase no está disponible.");return}const e=document.getElementById("new-product-name"),a=document.getElementById("new-product-type"),o=document.getElementById("new-product-price");if(!e||!a||!o){console.error("Error FATAL: No se encontraron todos los campos del formulario en el DOM. Verifique los IDs."),alert("Error al intentar guardar el producto. Verifique los IDs en la consola.");return}const n=e.value.trim(),d=a.value,l=parseFloat(o.value);let r=null;if(isNaN(l)||l<0||o.value.trim()===""){alert("El precio unitario debe ser un número válido (mayor o igual a cero).");return}if(d==="PACKAGE"){const u=document.getElementById("parent-product-select");if(r=(u==null?void 0:u.value)||null,!r){alert("Los paquetes deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const{error:i}=await s.from("productos").insert([{name:n,type:d,price:l,parent_product:r}]);i?(console.error("Error de Supabase al registrar producto:",i.message),alert("Error al registrar producto: "+i.message)):(alert("Producto registrado exitosamente."),closeModal("modal-register-product"),(c=document.getElementById("new-product-form"))==null||c.reset(),await S(),await z())}function qe(t){const e=x.find(o=>String(o.producto_id)===String(t));if(!e){alert("Error: Producto no encontrado para edición.");return}document.getElementById("product-id").value=e.producto_id,document.getElementById("edit-product-name").value=e.name,document.getElementById("edit-product-type").value=e.type,document.getElementById("edit-sale-price").value=e.price||0;const a=document.getElementById("edit-parent-product-container");e.type==="PACKAGE"?(a.classList.remove("hidden"),ye("edit-parent-product-select"),document.getElementById("edit-parent-product-select").value=e.parent_product):a.classList.add("hidden"),document.getElementById("product-modal-title").textContent="Editar Producto: "+e.name}function Fe(t){T=t,qe(t),openModal("modal-edit-product")}let N=null;function He(t){N=t;const e=x.find(a=>String(a.producto_id)===String(t));e&&(document.getElementById("delete-product-name-placeholder").textContent=e.name),openModal("modal-delete-confirmation")}async function ke(){if(!N)return;const{error:t}=await s.from("productos").delete().eq("producto_id",N);t?(console.error("Error al eliminar producto:",t.message),alert("Error al eliminar producto: "+t.message)):(alert("Producto eliminado exitosamente."),closeModal("modal-delete-confirmation"),N=null,await S(),await z())}let U=null;function ve(t,e){U=t;const a=document.getElementById("delete-client-name-placeholder");a&&(a.textContent=e),openModal("client-delete-confirmation")}async function Ve(){const t=U;if(!t){alert("Error de Eliminación: ID del cliente no encontrada.");return}const{error:e}=await s.from("clientes").delete().eq("client_id",t);if(e){console.error("Error al intentar eliminar el cliente:",e),e.code==="23503"?alert("❌ ERROR: No se puede eliminar el cliente. Tiene ventas o abonos pendientes asociados. Asegúrate de eliminar el historial del cliente o configurar la eliminación en cascada en Supabase."):alert("❌ Error desconocido al eliminar cliente: "+e.message),closeModal("client-delete-confirmation");return}alert("✅ Cliente eliminado definitivamente."),closeModal("client-delete-confirmation"),U=null,await C()}var ue;(ue=document.getElementById("confirm-delete-client-btn"))==null||ue.addEventListener("click",Ve);async function ze(t){if(t.preventDefault(),!s){console.error("Supabase no está inicializado.");return}const e=document.getElementById("abono-amount-sale"),a=document.getElementById("payment-method-sale").value,o=document.getElementById("payment-sale-id").value,n=V;let d=e?e.valueAsNumber:0;if(isNaN(d)){const l=e.value.replace(",",".");d=parseFloat(l)||0}if(d<=0||!o||!n){alert("Por favor, ingresa un monto de abono válido y asegúrate de que la venta y el cliente estén cargados.");return}try{const r=document.getElementById("detail-saldo-pendiente").textContent.replace(/[^\d.,-]/g,"").replace(",","."),i=parseFloat(r);if(isNaN(i))throw new Error("Error de cálculo: Saldo pendiente actual no es un número válido.");const c=i-d,{error:u}=await s.from("pagos").insert([{venta_id:o,client_id:n,amount:d,metodo_pago:a}]);if(u)throw u;const{error:m}=await s.from("ventas").update({saldo_pendiente:c}).eq("venta_id",o);if(m)throw m;alert("✅ Abono registrado con éxito. Saldo pendiente actualizado."),e.value="",window.handleViewSaleDetails(o,n),await C(),await M("gestion")}catch(l){console.error("Error al registrar abono en venta:",l),alert(`Hubo un error al registrar el abono: ${l.message}`)}}async function A(){const t=document.getElementById("report-month-selector"),e=document.getElementById("monthly-sales-report-body"),a=document.getElementById("report-total-sales"),o=document.getElementById("report-total-debt-generated"),n=document.getElementById("monthly-report-no-data");if(!e||!a||!n||!o){console.warn("Advertencia: Contenedores de Reporte Mensual ausentes o modal cerrado. (Asegúrese de agregar el ID 'report-total-debt-generated' a su HTML)");return}const d=t?t.value:null;let l,r;if(d){const[p,v]=d.split("-").map(Number);l=new Date(p,v-1,1),r=new Date(p,v,0),r.setHours(23,59,59,999)}else{const p=new Date;l=new Date(p.getFullYear(),p.getMonth(),1),r=new Date(p.getFullYear(),p.getMonth()+1,0),r.setHours(23,59,59,999)}const i=l.toISOString(),c=r.toISOString(),{data:u,error:m}=await s.from("ventas").select(`
            venta_id, 
            created_at, 
            client_id, 
            total_amount, 
            saldo_pendiente, 
            metodo_pago, 
            description
        `).gte("created_at",i).lte("created_at",c).order("created_at",{ascending:!1});if(m){console.error("Error al cargar reporte de ventas:",m.message),e.innerHTML="",a.textContent="$0.00",o.textContent="$0.00",n.classList.remove("hidden");return}let f=0,h=0;e.innerHTML="",u&&u.length>0?(n.classList.add("hidden"),u.forEach(p=>{f+=p.total_amount,h+=p.saldo_pendiente;const v=new Date(p.created_at).toLocaleDateString("es-MX",{year:"numeric",month:"short",day:"numeric"}),w=ge[p.client_id]||"N/A",b=e.insertRow();b.className="hover:bg-gray-50";const L=p.description||"-";b.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap">${p.venta_id}</td>
                <td class="px-3 py-3 whitespace-nowrap">${v}</td>
                <td class="px-3 py-3 whitespace-nowrap">${w}</td>
                <td class="px-3 py-3 whitespace-nowrap font-semibold">${y(p.total_amount)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-red-600">${y(p.saldo_pendiente)}</td>
                <td class="px-3 py-3 whitespace-nowrap">${p.metodo_pago}</td>
                
                <td class="px-3 py-3 text-sm truncate-cell">
                    <div class="truncate w-40" title="${L}">
                        ${L}
                    </div>
                </td>

                <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                        data-venta-id="${p.venta_id}"  
                        data-client-id="${p.client_id}"  class="view-sale-details-btn text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 rounded bg-indigo-100"
                    >
                        Detalles
                    </button>
                </td>
            `})):n.classList.remove("hidden"),a.textContent=y(f),o.textContent=y(h)}function se(){const t=document.getElementById("report-month-selector");if(!t)return;t.innerHTML="";const e=new Date,a=e.getFullYear(),o=e.getMonth(),n=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];for(let d=0;d<12;d++){const l=new Date(a,o-d,1),r=l.getFullYear(),i=l.getMonth(),c=`${r}-${String(i+1).padStart(2,"0")}`,u=`${n[i]} ${r}`,m=document.createElement("option");m.value=c,m.textContent=u,d===0&&(m.selected=!0),t.appendChild(m)}}function he(t){var c;const a=(u,m)=>{const f=y(m),h=32-u.length-f.length;return u+" ".repeat(h)+f},o=u=>{const m=32-u.length,f=Math.floor(m/2);return" ".repeat(f)+u};let n=o("Creativa Cortes CNC")+`
`;n+=`--------------------------------
`,n+=`
`,n+=o("Tel: 9851001141")+`
`,n+=o("Dirección: Calle 33 x 48 y 46")+`
`,n+=o("Col. Candelaria")+`
`,n+="Fecha: "+new Date(t.created_at).toLocaleDateString("es-MX")+`
`,n+="Venta: "+t.venta_id+`
`,n+=`--------------------------------
`;const d=((c=t.clientes)==null?void 0:c.name)||"Consumidor Final";n+="Cliente: "+d+`
`,n+=`================================
`,n+=`
`,n+=`Producto             Cant.  Total
`,n+=`--------------------------------
`,t.detalle_ventas.forEach(u=>{const f=u.productos.name.substring(0,18).padEnd(18," "),h=u.quantity.toString().padStart(5," "),p=y(u.subtotal).padStart(6," ");n+=`${f} ${h} ${p}
`}),n+=`--------------------------------
`,n+=`
`;const l=t.total_amount||0,r=t.saldo_pendiente||0,i=l-r;return n+=a("SALDO PENDIENTE:",r)+`
`,n+=a("ANTICIPO:",i)+`
`,n+=`================================
`,n+=a("TOTAL:",l)+`
`,n+=`================================
`,n+=`
`,n+=o("¡Gracias por su compra!")+`
`,n+=`
`,n+=`--------------------------------
`,n}let we=null;async function be(t){const{data:e,error:a}=await s.from("ventas").select("*, clientes(name), detalle_ventas (quantity, price, subtotal, productos(name))").eq("venta_id",t).single();if(a||!e)return;const n=`<pre style="font-family: monospace; font-size: 14px; margin: 0 auto; text-align: left;">${he(e)}</pre>`,d=document.getElementById("ticket-preview-content");d&&(d.innerHTML=n),we=t,openModal("modal-ticket-preview")}window.showTicketPreviewModal=be;async function Oe(t){const{data:e,error:a}=await s.from("ventas").select("*, clientes(name), detalle_ventas (quantity, price, subtotal, productos(name))").eq("venta_id",t).single();if(a||!e){console.error("Error al obtener datos para impresión:",a==null?void 0:a.message);return}const o=he(e);if(!qz.websocket.isActive()){alert("QZ Tray no está conectado. Por favor, asegúrate de que esté corriendo y recarga la página.");return}try{const n=[{type:"raw",data:o},{type:"raw",data:"VA\0"}],d=qz.configs.create("XP-58 (copy 1)",{encoding:"858"});await qz.print(d,n),console.log("Ticket enviado a la impresora correctamente.")}catch(n){alert("Error de impresión con QZ Tray. Revisa la consola para más detalles."),console.error(n)}}async function Ie(){const{data:t,error:e}=await s.from("clientes").select("client_id, name");if(e){console.error("Error al cargar datos de clientes para el mapa:",e);return}ge=t.reduce((a,o)=>(a[o.client_id]=o.name,a),{})}async function Re(){const t=document.getElementById("clients-list-body"),e=document.getElementById("clients-list-controls"),a=document.getElementById("toggle-clients-list"),o=document.getElementById("client-count-summary"),{data:n,error:d}=await s.from("clientes").select("client_id, name, phone").order("client_id",{ascending:!1});if(d){console.error("Error al cargar clientes:",d.message);return}t.innerHTML="";const l=10,r=n.length;let i=!1;if(n.forEach((c,u)=>{const m=!i&&u>=l,f=t.insertRow();f.className=m?"hidden":"hover:bg-gray-50",f.dataset.clientId=c.client_id,f.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${c.client_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">${c.name}</td>
            <td class="px-3 py-2 whitespace-nowrap">${c.phone||"-"}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button data-client-id="${c.client_id}" class="edit-client-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button data-client-id="${c.client_id}" class="delete-client-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `}),r>l){e.classList.remove("hidden"),o.textContent=`Mostrando ${l} de ${r} clientes.`;const c=()=>{i=!i,t.querySelectorAll("tr").forEach((m,f)=>{f>=l&&m.classList.toggle("hidden",!i)}),a.textContent=i?"Mostrar menos":`Mostrar los ${r-l} restantes`,o.textContent=i?`Mostrando todos (${r}) clientes.`:`Mostrando ${l} de ${r} clientes.`};a.onclick=c,c()}else e.classList.add("hidden")}async function z(){const t=document.getElementById("products-table-body");if(!t){console.error("Error: No se encontró el <tbody> con ID 'products-table-body'.");return}if(t.innerHTML="",x.length===0){t.innerHTML='<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay productos registrados.</td></tr>';return}x.forEach(e=>{let a="";if(e.type==="PACKAGE")if(e.parent_product){const l=x.find(r=>String(r.producto_id)===String(e.parent_product));a=l?`<span class="text-xs text-gray-500 ml-1">(Padre: ${l.name})</span>`:'<span class="text-xs text-red-500 ml-1">(ID Padre No Válida/Eliminada)</span>'}else a='<span class="text-xs text-red-500 ml-1">(Sin Padre Asociado)</span>';const o=e.type==="PACKAGE"?"Paquete/Servicio":"Producto Individual",n=e.price?parseFloat(e.price).toFixed(2):"0.00",d=t.insertRow();d.className="hover:bg-gray-50",d.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${e.producto_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">
                ${e.name} ${a}
            </td>
            <td class="px-3 py-2 whitespace-nowrap">${o}</td>
            <td class="px-3 py-2 whitespace-nowrap">$${n}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button data-product-id="${e.producto_id}" class="edit-product-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button data-product-id="${e.producto_id}" class="delete-product-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `})}async function Ue(){console.log("Cargando mapa de productos...");const{data:t,error:e}=await s.from("productos").select("producto_id, name");if(e){console.error("Error al cargar datos de productos para el mapa:",e);return}t.reduce((a,o)=>(a[o.producto_id]=o.name,a),{}),console.log(`Mapa de ${t.length} productos cargado.`)}document.addEventListener("DOMContentLoaded",async()=>{await Ie(),await Ue()});document.addEventListener("DOMContentLoaded",async()=>{var o,n,d,l,r,i,c,u,m,f,h,p,v,w,b,L,B,Y,X,J,Z,W,j,Q,ee,te,ne,ae,oe,re,de;if(window.supabase)s=window.supabase.createClient(me,pe);else{console.error("Error Fatal: Librería Supabase no encontrada. La aplicación no funcionará.");return}await S(),await Ie(),G(),se();const t=document.getElementById("report-month-selector");t&&t.addEventListener("change",A),A(),(o=document.getElementById("open-sale-modal-btn"))==null||o.addEventListener("click",async()=>{}),document.querySelectorAll("[data-close-modal]").forEach(g=>{}),(n=document.getElementById("open-sale-modal-btn"))==null||n.addEventListener("click",async()=>{var g;try{(g=document.getElementById("new-sale-form"))==null||g.reset(),await fe(),await S(),O(),_=[],k(),document.getElementById("total-amount").value="0.00",document.getElementById("paid-amount").value="0.00",document.getElementById("display-saldo-pendiente").value="0.00",openModal("new-sale-modal")}catch(E){console.error("Error al cargar datos del modal de venta:",E),alert("Error al cargar los datos. Revise la consola (F12).")}}),document.querySelectorAll("[data-close-modal]").forEach(g=>{g.addEventListener("click",E=>{E.preventDefault();const I=g.getAttribute("data-close-modal");closeModal(I)})}),(d=document.getElementById("new-sale-form"))==null||d.addEventListener("submit",$e),(l=document.getElementById("paid-amount"))==null||l.addEventListener("input",()=>R()),(r=document.getElementById("payment-method"))==null||r.addEventListener("change",()=>R()),(i=document.getElementById("add-product-btn"))==null||i.addEventListener("click",Me),(c=document.getElementById("abono-client-form"))==null||c.addEventListener("submit",le),(u=document.getElementById("register-payment-form"))==null||u.addEventListener("submit",ze);const e=document.getElementById("paid-amount");e&&e.addEventListener("input",()=>{F()}),(m=document.getElementById("payment-method"))==null||m.addEventListener("change",()=>{F()}),se(),O(),(f=document.getElementById("report-month-selector"))==null||f.addEventListener("change",A),(h=document.getElementById("login-form"))==null||h.addEventListener("submit",xe),(p=document.getElementById("logout-btn"))==null||p.addEventListener("click",_e),(v=document.getElementById("sales-month-filter"))==null||v.addEventListener("change",()=>{C()}),(w=document.getElementById("reset-sales-filter"))==null||w.addEventListener("click",()=>{const g=document.getElementById("sales-month-filter");g&&(g.value=""),C()}),(b=document.getElementById("print-ticket-btn"))==null||b.addEventListener("click",()=>{Oe(we)}),(L=document.getElementById("open-monthly-report-btn"))==null||L.addEventListener("click",()=>{A(),openModal("modal-monthly-report")}),(B=document.getElementById("admin-clients-btn"))==null||B.addEventListener("click",async()=>{openModal("modal-admin-clients"),await M("gestion")});const a=document.getElementById("modal-monthly-report");a==null||a.addEventListener("click",g=>{if(g.target.classList.contains("view-sale-details-btn")){const E=g.target.getAttribute("data-venta-id"),I=g.target.getAttribute("data-client-id");handleViewSaleDetails(E,I)}}),window.openRegisterClientModal=function(){const g=document.getElementById("client-modal-title");g&&(g.textContent="Registrar Nuevo Cliente");const E=document.getElementById("new-client-form");E==null||E.reset(),E==null||E.removeEventListener("submit",ie),E==null||E.addEventListener("submit",Pe),openModal("modal-new-client")},(Y=document.getElementById("post-sale-price-form"))==null||Y.addEventListener("submit",async g=>{g.preventDefault();const E=document.getElementById("edit-venta-id").value,I=document.getElementById("edit-detalle-venta-id").value,$=document.getElementById("edit-client-id").value,P=parseFloat(document.getElementById("new-unit-price").value);await Se(E,I,$,P),closeModal("modal-edit-sale-item")}),(X=document.getElementById("open-admin-products-modal"))==null||X.addEventListener("click",async()=>{try{await S(),await z(),openModal("admin-products-modal")}catch(g){console.error("Error al cargar la administración de productos:",g),alert("Error al cargar la lista de productos.")}}),(J=document.getElementById("open-product-modal-btn"))==null||J.addEventListener("click",()=>{var g;closeModal("admin-products-modal"),(g=document.getElementById("new-product-form"))==null||g.reset(),ce(),openModal("modal-register-product")}),(Z=document.getElementById("new-product-type"))==null||Z.addEventListener("change",g=>{ce(),g.target.value==="PACKAGE"&&ye("parent-product-select")}),(W=document.getElementById("new-product-form"))==null||W.addEventListener("submit",Ne),(j=document.getElementById("products-table-body"))==null||j.addEventListener("click",g=>{if(!g.target.hasAttribute("data-product-id"))return;const E=g.target.getAttribute("data-product-id");g.target.classList.contains("edit-product-btn")&&(g.preventDefault(),Fe(E)),g.target.classList.contains("delete-product-btn")&&(g.preventDefault(),He(E))}),(Q=document.getElementById("clients-list-body"))==null||Q.addEventListener("click",async g=>{const E=g.target.closest("button");if(E){g.preventDefault();const I=E.getAttribute("data-client-id");E.classList.contains("edit-client-btn")&&await Ee(I),E.classList.contains("delete-client-btn")&&ve(I),E.classList.contains("view-debt-btn")&&await handleViewClientDebt(I)}}),(ee=document.getElementById("edit-client-form"))==null||ee.addEventListener("submit",ie),(te=document.getElementById("open-abono-from-report-btn"))==null||te.addEventListener("click",g=>{var $;if(!window.viewingClientId){g.preventDefault();return}const E=(($=document.getElementById("client-report-total-debt"))==null?void 0:$.textContent)||"$0.00";if(parseFloat(E.replace(/[^0-9.-]+/g,"").replace(",","."))>.01){D=window.viewingClientId;const P=document.getElementById("abono-current-debt");P&&(P.textContent=E),openModal("modal-record-abono"),closeModal("modal-client-debt-report")}else g.preventDefault(),alert("El cliente no tiene deuda pendiente para registrar un abono.")}),document.addEventListener("click",g=>{document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(I=>{g.target===I&&closeModal(I.id)})}),document.querySelectorAll("[data-open-modal]").forEach(g=>{g.addEventListener("click",E=>{E.preventDefault();const I=g.getAttribute("data-open-modal");openModal(I)})}),(ne=document.getElementById("confirm-delete-btn"))==null||ne.addEventListener("click",ke),(ae=document.getElementById("edit-product-form"))==null||ae.addEventListener("submit",Ae),(oe=document.getElementById("product-main-select"))==null||oe.addEventListener("change",Ce),(re=document.getElementById("subproduct-select"))==null||re.addEventListener("change",g=>{K(g.target.value)}),(de=document.getElementById("abono-client-form"))==null||de.addEventListener("submit",le),document.addEventListener("keydown",g=>{if(g.key==="Escape"){const E=document.querySelectorAll(".modal-overlay:not(.hidden)"),I=E[E.length-1];I&&closeModal(I.id)}})});
