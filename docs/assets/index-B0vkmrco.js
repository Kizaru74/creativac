(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function a(n){if(n.ep)return;n.ep=!0;const l=o(n);fetch(n.href,l)}})();const P="https://wnwftbamyaotqdsivmas.supabase.co",D="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo";let u,b=[];try{if(!window.supabase)throw new Error("Librería Supabase no encontrada.");u=window.supabase.createClient(P,D)}catch(e){console.error("Error Fatal: Supabase no inicializó.",e),document.getElementById("auth-container").style.display="flex",document.getElementById("main-app-content").style.display="none"}function _(e){const t=document.getElementById(e);t&&(t.classList.remove("hidden"),t.classList.add("flex"))}function h(e){const t=document.getElementById(e);if(t){t.classList.add("hidden"),t.classList.remove("flex");const o=t.querySelector("form");if(o&&o.reset(),e==="new-sale-modal"){const a=document.getElementById("sale-total-amount"),n=document.getElementById("sale-debt-display");a&&(a.textContent=m(0)),n&&(n.textContent=m(0));const l=document.getElementById("subproduct-select");l&&(l.innerHTML='<option value="" data-price="0" disabled selected>Seleccione Principal primero</option>',l.disabled=!0);const r=document.getElementById("main-product-select");r&&r.removeEventListener("change",M)}}}function m(e){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(e)}async function L(){const e=document.getElementById("main-app-content"),t=document.getElementById("auth-container");if(!u||!e||!t){t&&(t.style.display="flex");return}const{data:{session:o},error:a}=await u.auth.getSession();a||!o?(t.style.display="flex",e.style.display="none"):(t.style.display="none",e.style.display="block",B())}async function q(e){e.preventDefault();const t=document.getElementById("email").value,o=document.getElementById("password").value,{error:a}=await u.auth.signInWithPassword({email:t,password:o});a?alert(a.message):L()}async function A(){const{error:e}=await u.auth.signOut();e&&console.error("Error al cerrar sesión:",e),L()}async function B(){await N(),await T(),await $()}async function N(){const e=document.getElementById("total-clients"),t=document.getElementById("total-sales"),o=document.getElementById("total-debt");if(!e||!t||!o)return;const{count:a,error:n}=await u.from("clientes").select("client_id",{count:"exact",head:!0});n?e.textContent="Error":e.textContent=a;const{data:l,error:r}=await u.from("ventas_totales").select("total_ventas").limit(1);let d=0;r?console.error("Error al cargar ventas totales. (406/RLS):",r.message):l&&l.length>0&&l[0].total_ventas&&(d=parseFloat(l[0].total_ventas)||0),t.textContent=m(d);const{data:p,error:c}=await u.from("clientes").select("debt");let i=0;!c&&p&&(i=p.reduce((s,y)=>s+(parseFloat(y.debt)||0),0)),o.textContent=m(i),(r||c)&&console.warn("Advertencia: Error al cargar totales. Revise RLS/vistas.")}async function T(){const e=document.getElementById("debts-table-body");if(!e)return;e.innerHTML='<tr><td colspan="4" class="p-3 text-center text-gray-500">Cargando deudas...</td></tr>';const{data:t,error:o}=await u.from("ventas").select(`
            venta_id, 
            total_amount, 
            paid_amount,
            created_at,
            clientes!ventas_client_id_fkey (name) // <-- CORRECCIÓN CLAVE
        `).order("created_at",{ascending:!1});if(o){console.error("Error al cargar ventas:",o),e.innerHTML=`<tr><td colspan="4" class="p-3 text-center text-red-500">Error: ${o.message}.</td></tr>`;return}const a=t.filter(n=>{const l=parseFloat(n.total_amount)||0,r=parseFloat(n.paid_amount)||0;return l>r});if(a.length===0){e.innerHTML='<tr><td colspan="4" class="p-3 text-center text-gray-500">No hay deudas pendientes.</td></tr>';return}e.innerHTML=a.map(n=>{const l=parseFloat(n.total_amount)||0,r=parseFloat(n.paid_amount)||0,d=l-r,p=n.clientes?n.clientes.name:"Cliente Desconocido",c=new Date(n.created_at).toLocaleDateString();return`
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">${p} (Venta #${n.venta_id})</td>
                <td class="px-6 py-4 whitespace-nowrap text-red-600 font-bold">${m(d)}</td>
                <td class="px-6 py-4 whitespace-nowrap">${c}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="text-indigo-600 hover:text-indigo-800 text-sm pay-debt-btn" data-sale-id="${n.venta_id}">
                        Pagar
                    </button>
                </td>
            </tr>
        `}).join("")}async function $(){const e=document.getElementById("clients-table-body");if(!e)return;const{data:t,error:o}=await u.from("clientes").select("client_id, name, contact").order("name",{ascending:!0});if(o){e.innerHTML=`<tr><td colspan="3" class="p-3 text-center text-red-500">Error al cargar clientes: ${o.message}</td></tr>`;return}if(t.length===0){e.innerHTML='<tr><td colspan="3" class="p-3 text-center text-gray-500">No hay clientes registrados.</td></tr>';return}e.innerHTML=t.map(a=>`
        <tr>
            <td class="px-6 py-4 whitespace-nowrap font-medium">${a.name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${a.contact||"N/A"}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button class="text-indigo-600 hover:text-indigo-800 text-sm view-client-btn" data-client-id="${a.client_id}">
                    Ver Deuda
                </button>
            </td>
        </tr>
    `).join("")}async function H(){const e=document.getElementById("sale-client-select");if(!e)return;e.innerHTML='<option value="" disabled selected>Cargando clientes...</option>';const{data:t,error:o}=await u.from("clientes").select("client_id, name").order("name",{ascending:!0});if(o)throw console.error("Error al cargar clientes:",o),e.innerHTML='<option value="" disabled selected>Error al cargar clientes</option>',new Error(`Fallo la carga de clientes: ${o.message}`);e.innerHTML='<option value="" disabled selected>Seleccione un cliente</option>',t.forEach(a=>{const n=document.createElement("option");n.value=a.client_id,n.textContent=a.name,e.appendChild(n)})}async function O(){if(b.length>0)return;const{data:e,error:t}=await u.from("productos").select("producto_id, name, price, type, parent_product").order("name",{ascending:!0});if(t)throw console.error("Error al cargar productos para select:",t),new Error("Fallo la carga de productos/paquetes");b=e}async function S(){const e=document.getElementById("admin-products-table-body");if(!e)return;e.innerHTML='<tr><td colspan="4" class="p-3 text-center text-gray-500">Cargando productos...</td></tr>';const{data:t,error:o}=await u.from("productos").select("*").order("type",{ascending:!1}).order("name",{ascending:!0});if(o){console.error("Error al cargar productos para la tabla:",o),e.innerHTML=`<tr><td colspan="4" class="p-3 text-center text-red-500">Error al cargar productos: ${o.message}</td></tr>`;return}if(t.length===0){e.innerHTML='<tr><td colspan="4" class="p-3 text-center text-gray-500">No hay productos o paquetes registrados.</td></tr>';return}e.innerHTML=t.map(a=>`
        <tr>
            <td class="px-6 py-4 whitespace-nowrap font-medium">${a.name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${a.type==="MAIN"?"Principal":"Paquete"}</td>
            <td class="px-6 py-4 whitespace-nowrap">${m(a.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button class="text-indigo-600 hover:text-indigo-800 text-sm edit-product-btn" data-product-id="${a.producto_id}">
                    <i class="fas fa-edit"></i> Editar
                </button>
            </td>
        </tr>
    `).join(""),document.querySelectorAll(".edit-product-btn").forEach(a=>{a.addEventListener("click",n=>{const l=n.currentTarget.dataset.productId;console.log("Abrir edición para producto:",l)})})}async function k(e){e.preventDefault();const t=document.getElementById("new-client-name").value.trim(),o=document.getElementById("new-client-phone").value.trim();if(!t){alert("El nombre del cliente es obligatorio.");return}try{const{error:a}=await u.from("clientes").insert([{name:t,contact:o||null}]);if(a)throw a;alert("Cliente registrado exitosamente!"),h("new-client-modal"),B()}catch(a){console.error("Error al registrar cliente:",a),alert(`Fallo el registro del cliente. Error: ${a.message}`)}}async function R(e){e.preventDefault();const t=document.getElementById("new-product-name").value.trim(),o=parseFloat(document.getElementById("new-product-price").value),a=document.getElementById("new-product-type").value,n=document.getElementById("new-product-description").value.trim();if(!t||isNaN(o)||o<0){alert("Por favor, ingrese un nombre válido y un precio mayor o igual a cero.");return}let l=null;try{const{error:r}=await u.from("productos").insert([{name:t,price:o,type:a,description:n||null,parent_product:l}]);if(r)throw r;alert(`¡${t} registrado exitosamente!`),h("new-product-modal"),S(),b=[]}catch(r){console.error("Error al registrar producto:",r),alert(`Fallo el registro del producto. Error: ${r.message}`)}}async function U(e){e.preventDefault();const t=e.target,o=t.querySelector("#sale-client-select").value,a=parseFloat(t.querySelector("#sale-payment-amount").value)||0,n=t.querySelector("#sale-payment-method").value;if(!o){alert("Por favor, selecciona un cliente.");return}const l=[];let r=0;const d=t.querySelector("#subproduct-select"),p=t.querySelector("#sale-quantity"),c=t.querySelector("#sale-price"),i=d==null?void 0:d.value,s=parseFloat(p==null?void 0:p.value)||0,y=parseFloat(c==null?void 0:c.value)||0;if(i&&s>0&&y>=0&&(l.push({producto_id:i,quantity:s,price_at_sale:y}),r=s*y),l.length===0){alert("Por favor, selecciona un Paquete/Subcategoría válido, cantidad y precio.");return}if(a>r){alert("El monto pagado no puede ser mayor que el total de la venta.");return}const f=r,g=a;try{const{data:E,error:I}=await u.from("ventas").insert([{client_id:o,total_amount:f,paid_amount:g}]).select("venta_id").single();if(I||!E){console.error("Error al insertar venta:",I),alert(`Error al registrar la venta: ${(I==null?void 0:I.message)||"Desconocido"}`);return}const C=E.venta_id,F=l.map(v=>({venta_id:C,producto_id:v.producto_id,quantity:v.quantity,price_at_sale:v.price_at_sale})),{error:x}=await u.from("ventas_productos").insert(F);if(x){console.error("Error al insertar detalles de venta:",x),alert(`Error al registrar el detalle de la venta: ${x.message}`);return}if(g>0){const{error:v}=await u.from("pagos").insert([{venta_id:C,amount:g,metodo_pago:n,client_id:o}]);v&&(console.error("Error al registrar pago inicial:",v),alert(`Error al registrar el pago inicial: ${v.message}`))}alert("Venta registrada exitosamente. Deuda calculada."),h("new-sale-modal"),await B()}catch(E){console.error("Error general en la venta:",E),alert("Ocurrió un error inesperado al registrar la venta.")}}function M(){const e=document.getElementById("main-product-select"),t=document.getElementById("subproduct-select"),o=document.getElementById("sale-price");if(!e||!t||!o)return;const a=e.options[e.selectedIndex].textContent;t.innerHTML='<option value="" data-price="0" disabled selected>Cargando opciones...</option>',t.disabled=!0,o.value="0.00";let n=[],l=null;if(n=b.filter(r=>r.type==="PACKAGE"&&r.parent_product===a),l=b.find(r=>r.name===a&&r.type==="MAIN"),n.length>0&&(t.innerHTML='<option value="" data-price="0" disabled selected>Seleccione un Paquete</option>',n.forEach(r=>{const d=document.createElement("option");d.value=r.producto_id,d.textContent=`${r.name} (Paquete) - ${m(r.price)}`,d.dataset.price=r.price,t.appendChild(d)})),l){const r=document.createElement("option");r.value=l.producto_id,r.textContent=`[Precio Base] - ${m(l.price)}`,r.dataset.price=l.price,t.appendChild(r),n.length===0&&(t.value=l.producto_id)}t.disabled=!1,w()}function w(){const e=document.getElementById("subproduct-select"),t=document.getElementById("sale-quantity"),o=document.getElementById("sale-price"),a=document.getElementById("sale-total-amount"),n=document.getElementById("sale-debt-display"),l=document.getElementById("sale-payment-amount");let r=0;const d=parseFloat(t==null?void 0:t.value)||0;let p=parseFloat(o==null?void 0:o.value)||0;const c=parseFloat(l==null?void 0:l.value)||0;if(e!=null&&e.value&&d>0){if(p===0||o.value.trim()===""){const s=e.selectedOptions[0];p=parseFloat(s==null?void 0:s.dataset.price)||0,p>=0&&(o.value=p.toFixed(2))}r=d*p}const i=Math.max(0,r-c);a&&(a.textContent=m(r)),n&&(n.textContent=m(i))}document.addEventListener("DOMContentLoaded",()=>{var e,t,o,a,n,l,r,d,p;(e=document.getElementById("login-form"))==null||e.addEventListener("submit",q),(t=document.getElementById("logout-button"))==null||t.addEventListener("click",A),(o=document.getElementById("new-sale-form"))==null||o.addEventListener("submit",U),(a=document.getElementById("new-client-form"))==null||a.addEventListener("submit",k),(n=document.getElementById("new-product-form"))==null||n.addEventListener("submit",R),(l=document.getElementById("open-new-sale-modal"))==null||l.addEventListener("click",async()=>{var c,i,s,y;try{await H(),await O();const f=document.getElementById("main-product-select");f.innerHTML='<option value="" disabled selected>Seleccione Producto Principal</option>',b.filter(g=>g.type==="MAIN").forEach(g=>{const E=document.createElement("option");E.textContent=g.name,f.appendChild(E)}),f.addEventListener("change",M),(c=document.getElementById("subproduct-select"))==null||c.addEventListener("change",w),(i=document.getElementById("sale-quantity"))==null||i.addEventListener("input",w),(s=document.getElementById("sale-price"))==null||s.addEventListener("input",w),(y=document.getElementById("sale-payment-amount"))==null||y.addEventListener("input",w),w(),_("new-sale-modal")}catch(f){console.error("Error al cargar datos de selects:",f),alert("Error al cargar los datos de clientes/productos. Revise la consola (F12).")}}),(r=document.getElementById("open-admin-products-modal"))==null||r.addEventListener("click",async c=>{c.preventDefault();try{await S(),_("admin-products-modal")}catch(i){console.error("Error al cargar la lista de productos:",i),alert("Error al cargar los productos. Revise la consola para detalles.")}}),(d=document.getElementById("open-new-client-modal"))==null||d.addEventListener("click",()=>{_("new-client-modal")}),(p=document.getElementById("open-new-product-modal"))==null||p.addEventListener("click",()=>{_("new-product-modal")}),document.querySelectorAll("[data-close-modal]").forEach(c=>{c.addEventListener("click",i=>{i.preventDefault();const s=c.getAttribute("data-close-modal");h(s)})}),document.addEventListener("click",c=>{document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(s=>{c.target===s&&h(s.id)})}),document.addEventListener("keydown",c=>{if(c.key==="Escape"){const i=document.querySelectorAll(".modal-overlay:not(.hidden)"),s=i[i.length-1];s&&h(s.id)}}),L()});
