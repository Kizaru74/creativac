(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const pe="https://wnwftbamyaotqdsivmas.supabase.co",fe="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo";let m,$=[],C=[],O=[];window.supabase?m=window.supabase.createClient(pe,fe):(console.error("Error Fatal: Librer√≠a Supabase no encontrada. La aplicaci√≥n no funcionar√°."),m=null);window.loadDashboardMetrics=async function(){if(!m){console.error("Supabase no est√° inicializado para cargar m√©tricas.");return}try{const{data:t,error:e}=await m.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",.01);if(e)throw e;let n=0;t&&t.length>0&&(n=t.reduce((l,s)=>l+parseFloat(s.saldo_pendiente||0),0));const{data:a,error:o}=await m.from("ventas").select("total_amount").not("total_amount","is",null);if(o)throw o;let r=0;a&&a.length>0&&(r=a.reduce((l,s)=>l+parseFloat(s.total_amount||0),0));const i=document.getElementById("total-debt");i&&(i.textContent=E(n));const d=document.getElementById("historical-total-sales");d&&(d.textContent=E(r))}catch(t){console.error("Error al cargar m√©tricas del dashboard:",t)}};function E(t){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(t)}window.openModal=function(t){var n;const e=document.getElementById(t);e?(e.classList.add("flex"),e.classList.remove("hidden"),(n=e.querySelector("input, select, textarea"))==null||n.focus()):console.error(`Error: No se encontr√≥ el modal con ID: ${t}`)};window.closeModal=function(t){const e=document.getElementById(t);e&&(e.classList.add("hidden"),e.classList.remove("flex"))};async function k(){const{data:{user:t}}=await m.auth.getUser(),e=document.getElementById("auth-container"),n=document.getElementById("dashboard-container");if(!e||!n){console.error("Error: Los contenedores 'auth-container' o 'dashboard-container' no se encontraron en el HTML.");return}t?(e.classList.add("hidden"),n.classList.remove("hidden"),await M()):(e.classList.remove("hidden"),n.classList.add("hidden"))}async function ge(t){t.preventDefault();const e=document.getElementById("email").value,n=document.getElementById("password").value,{error:a}=await m.auth.signInWithPassword({email:e,password:n});a?alert(a.message):k()}async function ye(){await m.auth.signOut(),k()}async function we(){try{const{data:t,error:e}=await m.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name, client_id)").gt("saldo_pendiente",.01).order("created_at",{ascending:!1}).limit(5);if(e){console.error("Error al cargar tabla de deudas:",e);return}const n=document.getElementById("debt-sales-body");if(!n)return;n.innerHTML="";const a=document.getElementById("no-debt-message");if(a&&a.classList.add("hidden"),t.length===0){a&&a.classList.remove("hidden");return}t.forEach(o=>{var l,s;const r=((l=o.clientes)==null?void 0:l.name)||"Cliente Desconocido",i=(s=o.clientes)==null?void 0:s.client_id,d=document.createElement("tr");d.className="hover:bg-gray-50",d.innerHTML=`
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${o.venta_id}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${r}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-red-600">${E(o.saldo_pendiente)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                        type="button" 
                        class="view-debt-btn" 
                        data-client-id="${i}" 
                        data-sale-id="${o.venta_id}" // Si necesitas la venta, mantenla
            class="view-debt-btn bg-red-600 hover:bg-red-700 text-white font-semibold text-xs py-1 px-2 rounded"
                    >
                        Detalles/Pagar
                    </button>
                </td>
            `,n.appendChild(d)}),n.querySelectorAll(".view-debt-btn").forEach(o=>{o.addEventListener("click",()=>{const r=o.dataset.clientId;handleViewClientDebt(r)})})}catch(t){console.error("Error inesperado en loadDebts:",t)}}async function Ee(){try{const{data:t,error:e}=await m.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name, client_id), description").order("created_at",{ascending:!1}).limit(7);if(e){console.error("Error al cargar ventas recientes:",e);return}const n=document.getElementById("recent-sales-body"),a=document.getElementById("no-sales-message");if(!n)return;if(n.innerHTML="",a&&a.classList.add("hidden"),t.length===0){a&&a.classList.remove("hidden");return}t.forEach(o=>{var l,s;const r=((l=o.clientes)==null?void 0:l.name)||"Cliente Desconocido",i=(s=o.clientes)==null?void 0:s.client_id,d=document.createElement("tr");d.className="hover:bg-gray-50",d.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${o.venta_id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${r}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${F(o.created_at)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${E(o.total_amount)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${o.saldo_pendiente>0?"text-red-600":"text-green-600"}">${E(o.saldo_pendiente)}</td>
                
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"> 
                    <button type="button" 
                            class="view-sale-details-btn text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 rounded bg-indigo-100"
                            data-sale-id="${o.venta_id}"
                            data-client-id="${i}"> 
                        Detalles
                    </button>
                </td>
            `,n.appendChild(d)}),n.querySelectorAll(".view-sale-details-btn").forEach(o=>{o.addEventListener("click",()=>{const r=o.dataset.saleId,i=o.dataset.clientId;handleViewSaleDetails(r,i)})})}catch(t){console.error("Error inesperado en loadRecentSales:",t)}}async function M(){await we(),await Ee(),await loadClientsTable("gestion"),await B(),await ie(),await ae(),await De()}async function ae(){const t=document.getElementById("client-select");if(!t)return;t.innerHTML='<option value="" disabled selected>Cargando clientes...</option>';const{data:e,error:n}=await m.from("clientes").select("client_id, name").order("name",{ascending:!0});if(n){console.error("Error al cargar clientes para venta:",n),t.innerHTML='<option value="" disabled selected>Error al cargar (revisar consola)</option>';return}if(e.length===0){t.innerHTML='<option value="" disabled selected>No hay clientes activos</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione un Cliente</option>',e.forEach(a=>{const o=document.createElement("option");o.value=a.client_id,o.textContent=a.name,t.appendChild(o)})}window.loadMainProductsForEditSelect=function(){const t=document.getElementById("edit-product-parent");if(!t)return;const n=(window.allProducts||[]).filter(o=>o.type==="MAIN"||o.type==="SERVICE");t.innerHTML="";const a=document.createElement("option");a.value="",a.textContent="--- Seleccione el Producto Principal ---",t.appendChild(a),n.forEach(o=>{const r=document.createElement("option");r.value=o.producto_id,r.textContent=o.name,t.appendChild(r)})};window.loadProductDataToForm=function(t){window.loadMainProductsForEditSelect();const e=window.allProductsMap?window.allProductsMap[String(t)]:null;if(!e){console.error(`Error de precarga: Producto no encontrado en el mapa con ID ${t}.`);return}let n;e.type==="MAIN"||e.type==="PRODUCT"?n="Producto":e.type==="SERVICE"?n="Servicio":e.type==="PACKAGE"?n="Paquete":n="Producto",document.getElementById("edit-product-id").value=e.producto_id,document.getElementById("edit-product-name").value=e.name,document.getElementById("edit-product-price").value=e.price,document.getElementById("edit-product-category").value=n;const a=document.getElementById("edit-product-parent-container"),o=document.getElementById("edit-product-parent");e.type==="PACKAGE"?(a.classList.remove("hidden"),o.value=e.parent_product||""):(a.classList.add("hidden"),o.value=""),document.getElementById("edit-product-category").onchange=function(){this.value==="Paquete"?a.classList.remove("hidden"):a.classList.add("hidden")},console.log(`‚úÖ Datos del producto ID ${t} precargados en el modal.`)};async function B(){if(!m){console.warn("Supabase no inicializado. No se pudieron cargar los productos."),window.allProducts=[],window.allProductsMap={};return}const{data:t,error:e}=await m.from("productos").select("producto_id, name, type, price, parent_product");if(e){console.error("Error al cargar todos los productos:",e),window.allProducts=[],window.allProductsMap={};return}const n=(t||[]).map(a=>({...a,type:String(a.type||"").trim().toUpperCase()}));window.allProducts=n,window.allProductsMap=n.reduce((a,o)=>(a[String(o.producto_id)]=o,a),{}),console.log(`‚úÖ Productos cargados y LIMPIADOS en √°mbito global: ${window.allProducts.length} √≠tems.`),window.loadMainProductsForSaleSelect()}window.loadProductsData=B;window.handleChangeProductForSale=function(){const t=document.getElementById("product-main-select"),e=document.getElementById("subproduct-select"),n=document.getElementById("product-unit-price");if(!t||!e||!n||typeof $>"u"){console.error("Error: Elementos de venta o datos (allProducts) no encontrados.");return}const a=t.value;if(!window.allProducts||window.allProducts.length<5){console.warn("ADVERTENCIA: Data de productos inestable o incompleta. Retrasando filtro de subproductos.");return}if(e.innerHTML='<option value="" selected>Sin Paquete</option>',e.disabled=!0,n.value="0.00",!a)return;window.updatePriceField(a);const o=$.filter(r=>{const i=parseInt(r.parent_product,10),d=parseInt(a,10);return r.type==="PACKAGE"&&!isNaN(i)&&i>0&&i===d});console.log(`DIAGN√ìSTICO DE FILTRO JS: ${o.length} subproductos encontrados.`),o.length>0&&(e.disabled=!1,e.innerHTML='<option value="" disabled selected>Seleccione un Paquete</option>',o.forEach(r=>{const i=document.createElement("option");i.value=r.producto_id;const d=typeof window.formatCurrency=="function"?window.formatCurrency(r.price):`$${parseFloat(r.price).toFixed(2)}`;i.textContent=`${r.name} (${d})`,e.appendChild(i)}),console.log(`DIAGN√ìSTICO DE RENDERIZADO: Se inyectaron ${o.length} opciones.`))};window.handleChangeProductForSale=window.handleChangeProductForSale;function H(){const t=document.getElementById("product-main-select");if(!t||typeof window.allProducts>"u")return;t.innerHTML='<option value="" disabled selected>- Seleccionar Producto -</option>';const e=window.allProducts.filter(n=>n.type!=="PACKAGE");if(e.length===0){t.innerHTML+='<option value="" disabled>No hay productos disponibles para la venta.</option>';return}e.forEach(n=>{const a=document.createElement("option");a.value=n.producto_id;const o=E(n.price);a.textContent=`${n.name} (${o})`,t.appendChild(a)}),console.log(`‚úÖ ${e.length} productos listados en el selector de venta.`)}window.loadMainProductsForSaleSelect=H;async function re(t){const e=document.getElementById(t);if(!e)return;const n=$.filter(a=>a.type&&a.type.trim().toUpperCase()==="MAIN");if(e.innerHTML='<option value="" disabled selected>Seleccione Producto Principal</option>',n.length===0){e.innerHTML='<option value="" disabled selected>‚ùå No hay Productos Base (Tipo: MAIN)</option>';return}n.forEach(a=>{const o=document.createElement("option");o.value=a.producto_id,o.textContent=`${a.name} ($${a.price.toFixed(2)})`,e.appendChild(o)})}window.updatePriceField=function(t){const e=document.getElementById("product-unit-price"),n=$.find(a=>String(a.producto_id)===String(t));e&&(n&&n.price!==void 0?e.value=parseFloat(n.price).toFixed(2):e.value="0.00")};function R(t){const e=document.getElementById("paid-amount"),n=document.getElementById("display-saldo-pendiente"),a=document.getElementById("payment-method"),o=document.getElementById("total-amount");if(!e||!a||!n||!o){console.warn("Faltan elementos DOM para la actualizaci√≥n de Saldo.");return}const r=ee(o.value),i=parseFloat(r)||0,d=a.value;let l=ee(e.value),s=parseFloat(l)||0;e.value.trim()===""&&(e.value="0.00"),d==="Deuda"&&(s=0);let c=i-s;i<=0&&(c=0),n.value=E(c),n.classList.remove("bg-red-100","bg-green-100","text-red-700","text-green-700"),c>.01?n.classList.add("bg-red-100","text-red-700"):n.classList.add("bg-green-100","text-green-700")}function q(){const t=C.reduce((a,o)=>a+o.subtotal,0);console.log("Grand Total calculado:",t);const e=document.getElementById("total-amount");e&&(e.value=t.toFixed(2)),R();const n=document.getElementById("submit-sale-btn");return C.length>0?n==null||n.removeAttribute("disabled"):n==null||n.setAttribute("disabled","true"),t}function z(){const t=document.getElementById("sale-items-table-body");if(!t){console.error("Error FATAL: Elemento 'sale-items-table-body' no encontrado en el DOM.");return}let e="";C.length===0?e='<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500 italic">Agrega productos a la venta.</td></tr>':C.forEach((n,a)=>{let o=n.name;!n.name.includes("(")&&n.type&&n.type.trim().toUpperCase()!=="MAIN"&&(o=`${n.name} (${n.type})`),e+=`
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${o}</td>
                    
                    <td class="px-4 py-2 text-sm text-gray-500 text-center">${n.quantity}</td> 
                    
                    <td class="px-4 py-2 text-sm text-gray-500 cursor-pointer hover:bg-yellow-100 transition-colors"
                        id="price-${a}"
                        onclick="promptEditItemPrice(${a}, ${n.price})">
                        ${E(n.price)}
                    </td>
                    
                    <td class="px-4 py-2 text-sm font-bold">${E(n.subtotal)}</td>
                    <td class="px-4 py-2 text-right text-sm font-medium">
                        <button type="button" onclick="removeItemFromSale(${a})" 
                                class="text-red-600 hover:text-red-900">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </td>
                </tr>
            `}),t.innerHTML=e,q()}window.removeItemFromSale=function(t){if(t<0||t>=C.length){console.error("√çndice de √≠tem de venta inv√°lido para eliminar.");return}confirm(`¬øEst√°s seguro de que quieres eliminar "${C[t].name}" de la venta?`)&&(C.splice(t,1),z(),q())};function he(t){t.preventDefault();const e=document.getElementById("product-main-select"),n=document.getElementById("subproduct-select"),a=document.getElementById("product-quantity"),o=document.getElementById("product-unit-price"),r=32,i=e==null?void 0:e.value,d=n==null?void 0:n.value,l=parseFloat(a==null?void 0:a.value);let s=d;s||(s=i);const c=String(s);let u=$.find(b=>String(b.producto_id)===c);const y=o==null?void 0:o.value;let p=parseFloat(y==null?void 0:y.replace(",","."))||0;if(p===0&&u&&(p=u.price||0),!u&&(parseInt(c,10)===0||!c)&&p===0&&(u={producto_id:r,name:"Servicio Manual / $0.00",price:0,type:"MANUAL"},s=r),!u){alert("Por favor, selecciona un Producto o Paquete v√°lido.");return}if(isNaN(l)||l<=0){alert("La cantidad debe ser mayor a cero.");return}const w=l*p;let h=u.name;if(d){const b=$.find(g=>String(g.producto_id)===String(i));b&&(h=`${b.name} (${u.name})`)}else u.type&&u.type.trim().toUpperCase()!=="MAIN"&&(h=`${u.name} (${u.type})`);const I={product_id:parseInt(s,10),name:h,quantity:l,price:p,subtotal:w,type:u.type||null},x=parseInt(s,10),D=C.findIndex(b=>b.product_id===x);D>-1?(C[D].quantity+=l,C[D].subtotal+=w):C.push(I),z(),q(),e.value="",n.value="",a.value="1",updatePriceField(null),H()}function ee(t){return typeof t!="string"?0:t.replace(/[^\d.-]/g,"")}async function be(t){if(!m)return{totalVentas:0,deudaNeta:0};try{const{data:e,error:n}=await m.from("transacciones_deuda").select("type, amount").eq("client_id",t);if(n)throw n;let a=0,o=0;return e.forEach(r=>{r.type==="cargo_venta"?(a+=r.amount,o+=r.amount):o-=r.amount}),o=Math.max(0,o),{totalVentas:a,deudaNeta:o}}catch(e){return console.error(`Error al obtener resumen del cliente ${t}:`,e),{totalVentas:0,deudaNeta:0}}}async function ve(t){var l;if(t.preventDefault(),!m)return;const e=parseFloat(document.getElementById("abono-amount").value),n=(l=document.getElementById("abono-method"))==null?void 0:l.value;if(isNaN(e)||e<=0){alert("Por favor, ingresa un monto v√°lido para el abono (mayor a cero).");return}if(!n||n===""){alert("Por favor, selecciona un M√©todo de Pago.");return}const a=window.debtToPayId,o=window.allClientsMap[a]!==void 0;let r=[],i=null,d=0;if(o){const s=a;i=s;const{data:c,error:u}=await m.from("ventas").select("venta_id, saldo_pendiente, paid_amount, client_id, created_at").eq("client_id",s).gt("saldo_pendiente",.01).order("created_at",{ascending:!0});if(u){console.error("Error al buscar ventas pendientes:",u),alert("Error al buscar ventas pendientes para abonar.");return}if(c.length===0){alert("El cliente no tiene ventas pendientes para abonar.");return}let y=e;d=e;for(const p of c){if(y<=0)break;const w=p.saldo_pendiente,h=Math.min(y,w);r.push({venta_id:p.venta_id,client_id:p.client_id,amount:h,new_paid_amount:p.paid_amount+h,new_saldo_pendiente:w-h}),y-=h}}else{const s=a,{data:c,error:u}=await m.from("ventas").select("saldo_pendiente, paid_amount, client_id").eq("venta_id",s).single();if(u||!c){alert("Error al obtener la venta para abonar.");return}if(e>c.saldo_pendiente){alert(`El abono excede el saldo pendiente (${E(c.saldo_pendiente)}). Ajuste el monto.`);return}i=c.client_id,d=e,r.push({venta_id:s,client_id:c.client_id,amount:e,new_paid_amount:c.paid_amount+e,new_saldo_pendiente:c.saldo_pendiente-e})}try{for(const u of r){const{error:y}=await m.from("pagos").insert([{venta_id:u.venta_id,client_id:u.client_id,amount:u.amount,metodo_pago:n}]);if(y)throw y;const{error:p}=await m.from("ventas").update({saldo_pendiente:u.new_saldo_pendiente,paid_amount:u.new_paid_amount}).eq("venta_id",u.venta_id);if(p)throw p}alert(`¬°Abono de ${E(d)} registrado con √©xito!`),document.getElementById("abono-client-form").reset(),closeModal("modal-record-abono");const s=document.getElementById("modal-client-debt-report");s&&!s.classList.contains("hidden")&&i&&await handleViewClientDebt(i);const c=document.getElementById("modal-detail-sale");c&&!c.classList.contains("hidden")&&!o&&await handleViewSaleDetails(a,i),await M(),await loadClientsTable("gestion")}catch(s){console.error("Error al registrar abono:",s.message||s),alert("Hubo un error al registrar el abono. Intente nuevamente.")}window.debtToPayId=null}async function de(t){var y,p,w,h;t.preventDefault();const e=((y=document.getElementById("client-select"))==null?void 0:y.value)??null,n=((p=document.getElementById("payment-method"))==null?void 0:p.value)??"Efectivo",a=((w=document.getElementById("sale-details"))==null?void 0:w.value.trim())??null,o=((h=document.getElementById("paid-amount"))==null?void 0:h.value.replace(/[^\d.-]/g,""))??"0";let r=parseFloat(o);const i=C.reduce((I,x)=>I+x.subtotal,0);n==="Deuda"&&(r=0);let d=r,l=i-r;if(!e){alert("Por favor, selecciona un cliente.");return}if(C.length===0){alert("Debes agregar al menos un producto a la venta.");return}if(i<0){alert("El total de la venta no puede ser negativo.");return}if(i<.01?(d=0,l=0):l<0&&(d=i,l=0),d<0||d>i){alert("El monto pagado es inv√°lido.");return}if(l>.01&&!confirm(`¬°Atenci√≥n! Hay un saldo pendiente de ${E(l)}. ¬øDeseas continuar registrando esta cantidad como deuda?`))return;const s=C.find(I=>!I.product_id||isNaN(I.product_id)||parseInt(I.product_id,10)===0);if(s){alert(`Error de Producto: El √≠tem "${s.name}" tiene un ID inv√°lido (${s.product_id}). Por favor, revise la selecci√≥n.`);return}const c=t.target.querySelector('button[type="submit"]');c&&(c.disabled=!0,c.textContent="Procesando Venta...");let u=null;try{const{data:I,error:x}=await m.from("ventas").insert([{client_id:e,total_amount:i,paid_amount:d,saldo_pendiente:l,metodo_pago:n,description:a}]).select("venta_id");if(x||!I||I.length===0)throw console.error("Error al insertar venta (Ventas):",x),new Error(`Error al registrar la venta principal: ${(x==null?void 0:x.message)||"Desconocido"}`);u=I[0].venta_id;const D=C.map(g=>({venta_id:u,product_id:parseInt(g.product_id,10),quantity:g.quantity,price:g.price,subtotal:g.subtotal})),{error:b}=await m.from("detalle_ventas").insert(D);if(b)throw console.error("üõë ERROR BD - DETALLES FALLIDOS:",b),new Error(`BD Fall√≥ al insertar detalles (ID Venta: ${u}). Mensaje Supabase: ${b.message}`);if(d>0){const{error:g}=await m.from("pagos").insert([{venta_id:u,amount:d,client_id:e,metodo_pago:n,type:"INICIAL"}]);g&&(console.error("Error al registrar pago inicial (Pagos):",g),alert(`Advertencia: El pago inicial fall√≥. ${g.message}`))}if(l>0){const{data:g,error:L}=await m.from("clientes").select("deuda_total").eq("client_id",e).single();if(!L&&g){const N=(g.deuda_total||0)+l,{error:T}=await m.from("clientes").update({deuda_total:N}).eq("client_id",e);T&&(console.error("Error al actualizar deuda del cliente (Clientes):",T),alert(`Advertencia: La venta se registr√≥, pero fall√≥ la actualizaci√≥n de la deuda total del cliente. ${T.message}`))}else console.warn(`No se pudo obtener la deuda actual del cliente ${e}.`)}closeModal("new-sale-modal"),window.currentSaleItems=[],window.updateSaleTableDisplay(),t.target.reset(),await M(),await loadClientsTable("gestion"),window.showTicketPreviewModal?me(u):alert(`Venta #${u} registrada con √©xito. Saldo Pendiente: ${E(l)}.`)}catch(I){console.error("Error FATAL al registrar la venta:",I),alert("Error fatal al registrar la venta: "+I.message);return}finally{c&&(c.disabled=!1,c.textContent="Finalizar Venta")}}window.handleNewSale=de;window.loadDashboardMetrics=async function(){if(!m){console.error("Supabase no est√° inicializado para cargar m√©tricas.");return}try{const{data:t,error:e}=await m.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",.01);if(e)throw e;let n=0;t&&t.length>0&&(n=t.reduce((l,s)=>l+parseFloat(s.saldo_pendiente||0),0));const{data:a,error:o}=await m.from("ventas").select("total_amount").not("total_amount","is",null);if(o)throw o;let r=0;a&&a.length>0&&(r=a.reduce((l,s)=>l+parseFloat(s.total_amount||0),0));const i=document.getElementById("total-debt");i&&(i.textContent=E(n));const d=document.getElementById("historical-total-sales");d&&(d.textContent=E(r))}catch(t){console.error("Error al cargar m√©tricas del dashboard:",t)}};window.handleViewClientDebt=async function(t){if(!m){console.error("Supabase no est√° inicializado."),alert("Error de conexi√≥n a la base de datos.");return}window.viewingClientId=t;try{const e=O.find(p=>{var w;return((w=p.client_id)==null?void 0:w.toString())===(t==null?void 0:t.toString())});if(!e){console.error("Cliente no encontrado para ID:",t),alert("Error: Cliente no encontrado.");return}const{data:n,error:a}=await m.from("ventas").select(`
                venta_id, 
                total_amount, 
                paid_amount, 
                created_at,
                description, 
                detalle_ventas (productos (name))
            `).eq("client_id",t).order("created_at",{ascending:!0});if(a)throw a;const o=n||[],{data:r,error:i}=await m.from("pagos").select("venta_id, amount, metodo_pago, created_at").eq("client_id",t).order("created_at",{ascending:!0});if(i)throw i;const d=r||[];let l=[];o.forEach(p=>{let h=`Venta: ${p.detalle_ventas.map(I=>I.productos.name).join(", ")||"Venta General"}`;p.description&&p.description.trim()!==""&&(h+=` ‚Äî ${p.description.trim()}`),l.push({date:new Date(p.created_at),type:"cargo_venta",description:h,amount:p.total_amount,venta_id:p.venta_id,order:1})}),d.forEach(p=>{let w=`Abono a Deuda (${p.metodo_pago})`;if(p.venta_id){const h=o.find(I=>I.venta_id===p.venta_id);if(h){const I=h.detalle_ventas.map(g=>g.productos.name).join(", ")||"Venta General",x=new Date(h.created_at),D=new Date(p.created_at);Math.abs(x-D)<6e4?w=`Pago Inicial (${p.metodo_pago}) - Venta: "${I}"`:w=`Abono (${p.metodo_pago}) - Venta: "${I}"`,h.description&&h.description.trim()!==""&&(w+=` (${h.description.trim()})`)}}l.push({date:new Date(p.created_at),type:"abono",description:w,amount:p.amount,venta_id:p.venta_id,order:2})}),l.sort((p,w)=>p.date.getTime()!==w.date.getTime()?p.date.getTime()-w.date.getTime():p.order-w.order),document.getElementById("client-report-name").textContent=e.name;const s=document.getElementById("client-transactions-body");let c=[],u=0;l.forEach(p=>{const w=p.amount;let h=p.description,I=E(w),x="";if(p.type==="cargo_venta")u+=w,x="text-red-600 font-bold";else if(p.type==="abono")u-=w,x="text-green-600 font-bold";else{console.warn(`Tipo de transacci√≥n no reconocido: ${p.type}.`);return}const D=Math.abs(u),b=E(D);let g="";u>.01?g="text-red-600 font-bold text-right":u<-.01?g="text-green-600 font-bold text-right":g="text-gray-700 font-bold text-right",c.push(`
                <tr class="hover:bg-gray-50 text-sm">
                    <td class="px-3 py-3 whitespace-nowrap text-gray-500">${F(p.date)}</td>
                    <td class="px-3 py-3 text-gray-800">${h}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-right ${x}">${I}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-right ${g}">${b}</td>
                </tr>
            `)}),s.innerHTML=c.join("");const y=document.getElementById("client-report-total-debt");u>.01?(y.textContent=E(Math.abs(u)),y.className="text-red-600 font-bold text-xl"):u<-.01?(y.textContent=`Cr√©dito ${E(Math.abs(u))}`,y.className="text-green-600 font-bold text-xl"):(y.textContent=E(0),y.className="text-gray-600 font-bold text-xl"),openModal("modal-client-debt-report")}catch(e){console.error("Error al cargar la deuda del cliente:",e),alert("Hubo un error al cargar el historial de deuda. Verifique la consola para m√°s detalles.")}};window.printClientDebtReport=function(){const t=document.getElementById("client-report-name").textContent,e=document.getElementById("client-report-total-debt").textContent,n=document.getElementById("client-transactions-body").innerHTML,a=new Date().toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}),o=`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reporte de Deuda - ${t}</title>
            <style>
                /* --- RESET Y BASE --- */
                body { 
                    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
                    margin: 0; 
                    padding: 40px; 
                    color: #333;
                    font-size: 10pt;
                }
                
                /* --- ENCABEZADO Y T√çTULOS --- */
                .header { border-bottom: 3px solid #0056b3; padding-bottom: 10px; margin-bottom: 20px; }
                .header h1 { margin: 0; font-size: 18pt; color: #0056b3; }
                .client-info { font-size: 11pt; margin-top: 10px; }
                .client-info strong { font-weight: bold; }

                /* --- RESUMEN DEUDA TOTAL --- */
                .summary-box { 
                    background-color: #f7f7f7; 
                    border: 1px solid #ddd; 
                    padding: 15px; 
                    margin-bottom: 25px; 
                    display: inline-block; 
                    width: auto;
                }
                .summary-box strong { font-size: 11pt; }
                .total-debt-amount { 
                    font-size: 18pt; 
                    font-weight: bold; 
                    color: #dc2626; /* Rojo de deuda */
                    display: block; 
                    margin-top: 5px;
                }

                /* --- TABLA DE TRANSACCIONES --- */
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 15px; 
                }
                th, td { 
                    border: none; 
                    padding: 10px 8px; 
                    text-align: left; 
                }
                
                tbody tr {
                    border-bottom: 1px solid #eeeeee;
                }
                
                th { 
                    background-color: #e6f0ff; 
                    color: #0056b3; 
                    font-weight: bold; 
                    text-transform: uppercase;
                    font-size: 9pt;
                    border-bottom: 2px solid #0056b3; 
                }
                
                /* üéØ NUEVAS ALINEACIONES Y ANCHOS */
                .date-col { width: 10%; } /* Fecha */
                .concept-col { width: 65%; } /* Concepto/Detalle (AMPLIADO) */
                .amount-col { width: 12.5%; text-align: right; } /* Monto */
                .balance-col { width: 12.5%; text-align: right; } /* Saldo Acumulado */


                /* Clases de estado (deben coincidir con las clases generadas en handleViewClientDebt) */
                .text-red-600 { color: #dc2626; font-weight: normal; } /* Cargo */
                .text-green-600 { color: #16a34a; font-weight: normal; } /* Abono */
                .text-gray-700 { color: #4b5563; font-weight: normal; } /* Saldado */

                .page-footer {
                    position: fixed;
                    bottom: 0;
                    width: 100%;
                    text-align: right;
                    font-size: 8pt;
                    color: #777;
                    padding-top: 10px;
                    border-top: 1px dashed #ccc;
                }

            </style>
        </head>
        <body>
            <div class="header">
                <h1>REPORTE DE ESTADO DE CUENTA</h1>
                <div class="client-info">
                    <strong>Cliente:</strong> ${t}<br>
                    <strong>Fecha de Emisi√≥n:</strong> ${a}
                </div>
            </div>

            <div class="summary-box">
                <strong>SALDO PENDIENTE ACTUAL</strong>
                <span class="total-debt-amount">${e}</span>
            </div>

            <h2>Historial</h2>
            <table>
                <thead>
                    <tr>
                        <th class="date-col">Fecha</th>
                        <th class="concept-col">Detalle de la Transacci√≥n</th> 
                        <th class="amount-col">Monto</th>
                        <th class="balance-col">Saldo Acumulado</th>
                    </tr>
                </thead>
                <tbody>
                    ${n} 
                </tbody>
            </table>

            <div class="page-footer">
                Documento generado por [Creativa Cortes CNC]. Para fines informativos.
            </div>
        </body>
        </html>
    `,r=window.open("","_blank");r?(r.document.write(o),r.document.close(),setTimeout(()=>{r.print()},300)):alert("Por favor, permita ventanas emergentes para imprimir el reporte.")};window.handleViewSaleDetails=async function(t,e){if(!m){console.error("Supabase no est√° inicializado."),alert("Error de configuraci√≥n: Supabase no est√° disponible.");return}const n=parseInt(t,10);if(isNaN(n)){console.error("ID de transacci√≥n inv√°lido."),alert("Error: El ID de la venta es inv√°lido.");return}const a=O.find(o=>{var r;return((r=o.client_id)==null?void 0:r.toString())===(e==null?void 0:e.toString())});if(!a){console.error("Cliente no encontrado en allClients."),alert("Error: Cliente no encontrado para esta venta. Intente recargar la p√°gina.");return}window.viewingClientId=e;try{const{data:o,error:r}=await m.from("ventas").select("venta_id, total_amount, paid_amount, saldo_pendiente, created_at, description, metodo_pago").eq("venta_id",n).single();if(r||!o)throw console.error("Error al cargar detalles de la venta (Tabla Ventas):",r),new Error("No se encontr√≥ la venta principal (ID: "+n+").");const{data:i,error:d}=await m.from("detalle_ventas").select("detalle_id, quantity, price, subtotal, product_id, productos(name, parent_product)").eq("venta_id",n).order("detalle_id",{ascending:!0});if(d)throw d;const{data:l,error:s}=await m.from("pagos").select("amount, metodo_pago, created_at").eq("venta_id",n).order("created_at",{ascending:!0});if(s)throw s;document.getElementById("detail-sale-id").textContent=o.venta_id,document.getElementById("detail-client-name").textContent=a.name,document.getElementById("detail-sale-date").textContent=F(o.created_at),document.getElementById("detail-payment-method").textContent=o.metodo_pago;const c=document.getElementById("detail-sale-description");if(c&&c.parentElement){const b=o.description||"No se registraron comentarios adicionales para esta venta.";c.textContent=b}document.getElementById("detail-grand-total").textContent=E(o.total_amount),document.getElementById("detail-paid-amount").textContent=E(o.paid_amount),document.getElementById("detail-remaining-debt").textContent=E(o.saldo_pendiente);const u=document.getElementById("detail-products-body");u.innerHTML="",(i||[]).forEach(b=>{const g=b.productos;let L=(g==null?void 0:g.name)||"√çtem Desconocido";if(g&&g.parent_product&&window.allProductsMap){const P=window.allProductsMap[g.parent_product];P&&g.name!==P.name&&(L=`${g.name} <span class="text-xs text-gray-500 ml-1">(P: ${P.name})</span>`)}u.innerHTML+=`
                <tr>
                    <td class="px-4 py-2">${L}</td> 
                    <td class="px-4 py-2 text-center">${b.quantity}</td>
                    <td class="px-4 py-2 text-right">${E(b.price)}</td>
                    <td class="px-4 py-2 font-medium text-right">${E(b.subtotal)}</td>
                    <td class="px-4 py-2"></td>
                </tr>
            `});const y=document.getElementById("detail-abonos-body"),p=document.getElementById("no-abonos-message");y.innerHTML="",l.length===0?p.classList.remove("hidden"):(p.classList.add("hidden"),l.forEach(b=>{const g=b.metodo_pago||"Pago Inicial";y.innerHTML+=`
                    <tr>
                        <td class="px-4 py-2">${F(b.created_at)}</td>
                        <td class="px-4 py-2 font-medium text-right text-green-700">${E(b.amount)}</td>
                        <td class="px-4 py-2">${g}</td>
                    </tr>
                `}));const w=document.getElementById("price-edit-section"),h=document.querySelector('[data-open-modal="abono-client-modal"]'),I=parseFloat(o.total_amount)<.01&&parseFloat(o.paid_amount)<.01&&parseFloat(o.saldo_pendiente)<.01,x=parseFloat(o.saldo_pendiente)>.01,D=o.saldo_pendiente;if(I){w==null||w.classList.remove("hidden"),h==null||h.classList.add("hidden");const b=(i||[])[0];if(document.getElementById("edit-sale-id-display").textContent=o.venta_id,document.getElementById("edit-sale-transaction-id").value=o.venta_id,b&&b.detalle_id){document.getElementById("edit-sale-detail-id").value=b.detalle_id,document.getElementById("edit-new-price").value=b.price||"";const g=b.productos;let L=(g==null?void 0:g.name)||"√çtem Principal";if(g&&g.parent_product&&window.allProductsMap){const P=window.allProductsMap[g.parent_product];P&&(L=`${P.name} (${g.name})`)}document.getElementById("edit-product-name").textContent=L}else w==null||w.classList.add("hidden")}else if(x){w==null||w.classList.add("hidden"),h==null||h.classList.remove("hidden"),window.debtToPayId=o.venta_id;const b=document.getElementById("debt-to-pay-id"),g=document.getElementById("abono-current-debt");b&&(b.value=o.venta_id),g&&(g.textContent=E(D)),h&&(h.onclick=()=>{window.openAbonoModal(o.venta_id,a.name,D)})}else w==null||w.classList.add("hidden"),h==null||h.classList.add("hidden");openModal("modal-detail-sale")}catch(o){console.error("Error al cargar detalles de venta:",o),alert("Hubo un error al cargar los detalles de la venta. "+(o.message||""))}};window.handleAbonoClientSubmit=async function(t){var r;if(t.preventDefault(),!m){console.error("Supabase no est√° inicializado."),alert("Error de configuraci√≥n.");return}const e=t.target,n=e.elements["debt-to-pay-id"].value,a=parseFloat(e.elements["abono-amount"].value),o=e.elements["payment-method-abono"].value.trim();if(isNaN(a)||a<=0){alert("Ingrese un monto de abono v√°lido y mayor a cero.");return}if(!o||o===""){alert("¬°Debe seleccionar un m√©todo de pago!"),(r=document.getElementById("payment-method-abono"))==null||r.focus();return}try{const{data:i,error:d}=await m.from("ventas").select("total_amount, paid_amount, saldo_pendiente, client_id").eq("venta_id",n).single();if(d||!i)throw new Error("Venta no encontrada.");const l=i.saldo_pendiente;if(a>l){alert(`El abono (${E(a)}) es mayor que la deuda pendiente (${E(l)}). Ajuste el monto.`);return}const s=i.paid_amount+a,c=l-a,u=i.client_id,{error:y}=await m.from("pagos").insert([{venta_id:n,client_id:u,amount:a,metodo_pago:o,type:"abono"}]);if(y)throw new Error("Error al registrar el pago: "+y.message);const{error:p}=await m.from("ventas").update({paid_amount:s,saldo_pendiente:c}).eq("venta_id",n);if(p)throw new Error("Error al actualizar la venta: "+p.message);alert(`Abono de ${E(a)} registrado con √©xito. Deuda restante: ${E(c)}.`),e.reset(),closeModal("abono-client-modal"),await M(),handleViewSaleDetails(n,u)}catch(i){console.error("Error al registrar abono:",i),alert("Fallo al registrar el abono: "+i.message)}};document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("edit-sale-price-form");t&&t.addEventListener("submit",handlePriceEditSubmit)});window.handleFilterSales=function(){var r,i,d;const t=(r=document.getElementById("filter-start-date"))==null?void 0:r.value,e=(i=document.getElementById("filter-end-date"))==null?void 0:i.value,n=((d=document.getElementById("filter-search-term"))==null?void 0:d.value.toLowerCase().trim())||"";let o=(window.allSales||[]).filter(l=>{let s=!0;const c=l.sale_date;t&&c<t&&(s=!1),e&&c>e&&(s=!1);let u=!0;if(n.length>0){const y=(l.client_name||"").toLowerCase(),p=String(l.venta_id);!y.includes(n)&&!p.includes(n)&&(u=!1)}return s&&u});window.renderSalesTable(o),console.log(`Filtro aplicado. Mostrando ${o.length} ventas.`)};window.handleFilterSales=window.handleFilterSales;window.renderSalesTable=function(t){const e=document.getElementById("sales-table-body");if(e){if(e.innerHTML="",t.length===0){e.innerHTML='<tr><td colspan="8" class="text-center py-4 text-gray-500">No se encontraron ventas para estos criterios.</td></tr>';return}t.forEach(n=>{const a=document.createElement("tr");a.className="hover:bg-gray-50";const o=n.saldo_pendiente<=0,r=o?"text-green-600 font-medium":"text-red-600 font-bold",i=o?"Liquidada":"Pendiente";a.innerHTML=`
            <td class="px-3 py-2 text-sm text-gray-900">${n.venta_id}</td>
            <td class="px-3 py-2 text-sm text-gray-500">${n.sale_date||"N/A"}</td> 
            <td class="px-3 py-2 text-sm font-medium">${n.client_name||"Consumidor Final"}</td>
            <td class="px-3 py-2 text-sm text-right">${window.formatCurrency(n.total_amount)}</td>
            <td class="px-3 py-2 text-sm text-right ${r}">${window.formatCurrency(n.saldo_pendiente)}</td>
            <td class="px-3 py-2 text-sm ${r}">${i}</td>
            <td class="px-3 py-2 text-right">
                <button onclick="window.openSaleDetailModal(${n.venta_id})" class="text-indigo-600 hover:text-indigo-900">Detalles</button>
                ${o?"":`<button onclick="window.openPaymentModal(${n.venta_id}, ${n.saldo_pendiente}, ${n.client_id})" class="text-green-600 hover:text-green-800 ml-2">Abonar</button>`}
            </td>
        `,e.appendChild(a)})}};window.renderSalesTable=renderSalesTable;window.loadSalesData=async function(){if(console.log("Cargando datos de ventas..."),!m){console.error("Supabase no inicializado en loadSalesData."),window.allSales=[];return}try{const{data:t,error:e}=await m.from("ventas").select(`
                venta_id, 
                created_at,        
                total_amount,      
                saldo_pendiente,   
                client_id,         
                clientes ( name )  
            `);if(e)throw e;window.allSales=(t||[]).map(n=>({...n,sale_date:n.created_at?n.created_at.substring(0,10):"N/A",client_name:n.clientes?n.clientes.name:"Consumidor Final"})),console.log(`‚úÖ ${window.allSales.length} ventas cargadas en √°mbito global.`)}catch(t){console.error("Error al cargar datos de ventas:",t),window.allSales=[],alert("Fallo al cargar la lista de ventas.")}return window.allSales};window.loadSalesData=loadSalesData;window.handlePriceEditSubmit=async function(t){if(t.preventDefault(),!m){alert("Error: Supabase no est√° inicializado.");return}const e=t.target,n=e.querySelector('button[type="submit"]'),a=e.elements["edit-sale-transaction-id"].value,o=e.elements["edit-sale-detail-id"].value,r=e.elements["edit-new-price"].value,i=parseFloat(r),d=window.viewingClientId;if(!a||!o||isNaN(i)||i<=0||!d){alert("Faltan datos (Venta/Detalle/Cliente) o el precio es inv√°lido (debe ser > 0).");return}if(confirm(`¬øEst√° seguro de establecer el precio unitario de la Venta #${a} a ${E(i)}? Esto definir√° el total y el saldo pendiente.`)){n.disabled=!0,n.textContent="Actualizando y Recalculando...";try{const{data:l,error:s}=await m.from("detalle_ventas").select("quantity").eq("detalle_id",o).single();if(s||!l)throw new Error("Detalle de venta no encontrado.");const c=i*l.quantity,{error:u}=await m.from("detalle_ventas").update({price:i,subtotal:c}).eq("detalle_id",o);if(u)throw new Error("Error al actualizar detalle: "+u.message);const{error:y}=await m.from("ventas").update({total_amount:c,saldo_pendiente:c,paid_amount:0}).eq("venta_id",a);if(y)throw new Error("Error al actualizar venta: "+y.message);alert(`Venta #${a} actualizada con √©xito. El saldo pendiente ahora es de ${E(c)}.`),closeModal("modal-detail-sale"),window.loadDashboardData&&await M(),window.loadMonthlySalesReport&&await S(),window.loadClientsTable&&await loadClientsTable("gestion"),await handleViewSaleDetails(a,d)}catch(l){console.error("Error al editar precio de venta:",l),alert("Fallo al actualizar el precio: "+(l.message||"Error desconocido."))}finally{n.disabled=!1,n.textContent="Actualizar Precio y Saldo"}}};function ie(){var n,a;const t=document.getElementById("products-table-body");if(!t)return;t.innerHTML="";const e=window.allProducts||[];if(e.length===0){(n=document.getElementById("no-products-message"))==null||n.classList.remove("hidden");return}(a=document.getElementById("no-products-message"))==null||a.classList.add("hidden"),e.forEach(o=>{const r=document.createElement("tr");r.className="hover:bg-gray-100 transition-colors";const i=E(o.price);let d=o.type;o.type==="MAIN"&&(d="Principal"),o.type==="PACKAGE"&&(d="Subproducto"),o.type==="SERVICE"&&(d="Servicio"),r.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${o.producto_id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${o.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${i}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                
                <button 
                    onclick="handleEditProductClick(${o.producto_id})" 
                    class="text-indigo-600 hover:text-indigo-900 edit-product-btn mr-2">
                    Editar
                </button>
                
                <button 
                    onclick="handleDeleteProductClick(${o.producto_id})" 
                    class="text-red-600 hover:text-red-900 delete-product-btn">
                    Eliminar
                </button>
            </td>
        `,t.appendChild(r)})}window.loadProductsTable=ie;function Ie(t){const e=$.find(a=>String(a.producto_id)===String(t));document.getElementById("product-id").value=e.producto_id,document.getElementById("edit-product-name").value=e.name,document.getElementById("edit-product-type").value=e.type,document.getElementById("edit-sale-price").value=e.price||0;const n=document.getElementById("edit-parent-product-container");e.type==="PACKAGE"?(n.classList.remove("hidden"),re("edit-parent-product-select"),document.getElementById("edit-parent-product-select").value=e.parent_product):n.classList.add("hidden"),document.getElementById("product-modal-title").textContent="Editar Producto: "+e.name}window.loadMainProductsAndPopulateSelect=async function(){const t=document.getElementById("new-product-parent-select");if(!t)return;const n=(window.allProducts||[]).filter(o=>o.type==="MAIN");console.warn(`DEBUG: La funci√≥n LOCAL devolvi√≥ ${n.length} productos MAIN.`),t.innerHTML="";const a=document.createElement("option");a.value="",a.textContent=n.length>0?"--- Seleccione el Producto Principal ---":"--- (NO HAY PRODUCTOS MAIN REGISTRADOS) ---",a.setAttribute("disabled","disabled"),a.setAttribute("selected","selected"),t.appendChild(a),n.forEach(o=>{const r=document.createElement("option");r.value=o.producto_id,r.textContent=o.name,t.appendChild(r)})};function te(){const t=document.getElementById("new-product-type"),e=document.getElementById("parent-product-container"),n=document.getElementById("parent-product-select");!t||!e||!n||(t.value==="PACKAGE"?(e.classList.remove("hidden"),e.classList.add("block"),n.setAttribute("required","required")):(e.classList.add("hidden"),e.classList.remove("block"),n.removeAttribute("required"),n.value=""))}window.handleEditProduct=async function(t){var u;if(t.preventDefault(),!m||!window.editingProductId){alert("Error: Supabase no est√° disponible o el ID del producto a editar es desconocido.");return}const e=document.getElementById("edit-product-name"),n=document.getElementById("edit-product-category"),a=document.getElementById("edit-product-price"),o=e.value.trim(),r=parseFloat(a.value),i=n.value,d=xe(i);let l=null;if(isNaN(r)||r<0||a.value.trim()===""){alert("El precio de venta debe ser un n√∫mero v√°lido (mayor o igual a cero).");return}if(d==="PACKAGE"){const y=document.getElementById("edit-product-parent");if(l=(y==null?void 0:y.value)||null,!l||l==="placeholder-option-value"||String(l)===String(window.editingProductId)){alert("Los paquetes deben tener un Producto Principal asociado v√°lido y no pueden ser su propio padre.");return}}const s={name:o,type:d,price:r,parent_product:l},{error:c}=await m.from("productos").update(s).eq("producto_id",window.editingProductId);c||(alert("Producto actualizado exitosamente."),closeModal("edit-product-modal"),(u=document.getElementById("edit-product-form"))==null||u.reset(),await B(),await loadAndRenderProducts()),window.editingProductId=null};function xe(t){return t==="Producto"?"MAIN":t==="Paquete"?"PACKAGE":"MAIN"}async function _e(t){var s;if(t.preventDefault(),!m){alert("Error de conexi√≥n: Supabase no est√° disponible.");return}const e=document.getElementById("new-product-name"),n=document.getElementById("new-product-type"),a=document.getElementById("new-product-price");if(!e||!n||!a){console.error("Error FATAL: No se encontraron todos los campos del formulario en el DOM."),alert("Error al intentar guardar el producto. Verifique los IDs en la consola.");return}const o=e.value.trim(),r=n.value,i=parseFloat(a.value);let d=null;if(isNaN(i)||i<0||a.value.trim()===""){alert("El precio unitario debe ser un n√∫mero v√°lido (mayor o igual a cero).");return}if(r==="PACKAGE"){const c=document.getElementById("new-product-parent-select");if(d=(c==null?void 0:c.value)||null,!d||d==="placeholder-option-value"){alert("Los subproductos deben tener un Producto Principal asociado. Seleccione uno de la lista.");return}}const{error:l}=await m.from("productos").insert([{name:o,type:r,price:i,parent_product:d}]);l?(console.error("Error de Supabase al registrar producto:",l.message),alert("Error al registrar producto: "+l.message)):(alert("Producto registrado exitosamente."),closeModal("new-product-modal"),(s=document.getElementById("new-product-form"))==null||s.reset(),await B(),await loadAndRenderProducts())}window.handleProductTypeChange=function(){const t=document.getElementById("new-product-type"),e=document.getElementById("new-product-parent-container"),n=document.getElementById("new-product-parent-select");!t||!e||!n||(t.value==="PACKAGE"?(e.classList.remove("hidden"),n.setAttribute("required","required")):(e.classList.add("hidden"),n.removeAttribute("required"),n.value=""))};window.handleEditProductClick=function(t){console.log("ID recibida del bot√≥n:",typeof t,t),console.log("Producto encontrado en el mapa:",window.allProductsMap[String(t)]),window.editingProductId=t,Ie(t),openModal("edit-product-modal")};window.handleDeleteProductClick=function(t){window.editingProductId=t;const e=window.allProductsMap[String(t)],n=document.getElementById("delete-product-name-placeholder");n&&e&&(n.textContent=e.name),openModal("delete-product-modal")};window.confirmDeleteProduct=async function(){if(!window.editingProductId)return;const t=document.getElementById("confirm-delete-btn");t.disabled=!0,t.textContent="Eliminando...";const{error:e}=await m.from("productos").delete().eq("producto_id",window.editingProductId);e?e.code==="23503"?alert('¬°ERROR! Este producto no se puede eliminar porque ya ha sido utilizado en una o m√°s ventas (Historial de ventas). Considere la funci√≥n "Archivar" (Borrado L√≥gico) en la BD.'):(console.error("Error al eliminar producto:",e.message),alert("Error al eliminar producto: "+e.message)):(alert("Producto eliminado exitosamente."),await B(),await loadAndRenderProducts()),t.disabled=!1,t.textContent="S√≠, Eliminar",closeModal("delete-product-modal"),window.editingProductId=null};async function De(){if(!m){console.error("Supabase no est√° inicializado.");return}const t=document.getElementById("debts-table-body"),e=document.getElementById("no-debts-message");if(!(!t||!e)){t.innerHTML='<tr><td colspan="4" class="text-center py-4 text-gray-500">Cargando deudas...</td></tr>',e.classList.add("hidden");try{const{data:n,error:a}=await m.from("ventas").select(`
                venta_id, 
                client_id, 
                created_at, 
                saldo_pendiente,
                clientes(name) 
            `).gt("saldo_pendiente",.01).order("created_at",{ascending:!1});if(a)throw a;const o={};(n||[]).forEach(d=>{var s;const l=d.client_id;o[l]||(o[l]={clientId:l,name:((s=d.clientes)==null?void 0:s.name)||"Cliente Desconocido",totalDebt:0,lastSaleDate:d.created_at,lastSaleId:d.venta_id}),o[l].totalDebt+=d.saldo_pendiente});const r=Object.values(o);if(t.innerHTML="",r.length===0){e.classList.remove("hidden");return}let i=[];r.forEach(d=>{const l=F(d.lastSaleDate);i.push(`
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${d.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-lg font-extrabold text-red-600">${E(d.totalDebt)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${l}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button 
                            onclick="window.handleViewClientDebt(${d.clientId})" 
                            class="text-indigo-600 hover:text-indigo-900 font-medium text-xs py-1 px-2 rounded bg-indigo-100"
                            title="Ver historial completo de cargos y abonos"
                        >
                            Ver Historial (${E(d.totalDebt)})
                        </button>
                    </td>
                </tr>
            `)}),t.innerHTML=i.join("")}catch(n){console.error("Error al cargar la tabla de deudas:",n),t.innerHTML='<tr><td colspan="4" class="text-center py-4 text-red-600">Error al cargar datos de deudas.</td></tr>'}}}window.loadClientsTable=async function(t="gestion"){if(!m){console.error("Supabase no est√° inicializado.");return}const e=document.getElementById("clients-list-body");if(!e){console.error("Contenedor de clientes ('clients-list-body') no encontrado.");return}const n=t==="gestion";try{const{data:a,error:o}=await m.from("clientes").select("client_id, name, telefono").order("name",{ascending:!0});if(o)throw o;O=a;const r=a.map(d=>be(d.client_id)),i=await Promise.all(r);e.innerHTML="",a.forEach((d,l)=>{const s=i[l],c=document.createElement("tr");c.className="hover:bg-gray-50";let u="";n?u=`
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" class="edit-client-btn text-indigo-600 hover:text-indigo-900 mr-2" 
                                        data-client-id="${d.client_id}">
                            <i class="fas fa-edit"></i> Editar
                
                <button type="button" class="delete-client-btn text-red-600 hover:text-red-900 mr-2" 
                 data-client-id="${d.client_id}" 
               data-client-name="${d.name}">
                 <i class="fas fa-trash"></i> Eliminar
                </button>

                     <button type="button" class="view-debt-btn text-blue-600 hover:text-blue-900" 
                        data-client-id="${d.client_id}" title="Ver ventas y abonos del cliente">
                        <i class="fas fa-file-invoice-dollar"></i> Ver Deuda
                    </button>
                    </td>
                `:u='<td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium"></td>',c.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${d.client_id}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${d.name}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${d.telefono||"N/A"}</td>
                
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">
                    $${s.totalVentas.toFixed(2)}
                </td>
                
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold 
                    ${s.deudaNeta>0?"text-red-600":"text-green-600"}">
                    $${s.deudaNeta.toFixed(2)}
                </td>
                
                ${u} 
            `,e.appendChild(c)}),n&&(e.querySelectorAll(".edit-client-btn").forEach(d=>{d.addEventListener("click",()=>{se(d.dataset.clientId)})}),e.querySelectorAll(".delete-client-btn").forEach(d=>{d.addEventListener("click",()=>{le(d.dataset.clientId,d.dataset.clientName)})}),e.querySelectorAll(".view-debt-btn").forEach(d=>{d.addEventListener("click",()=>{handleViewClientDebt(d.dataset.clientId)})}))}catch(a){console.error("Error inesperado al cargar clientes:",a.message||a)}};let V=null;function le(t,e){V=t;const n=document.getElementById("delete-client-name-placeholder");n&&(n.textContent=e),openModal("client-delete-confirmation")}async function Ce(){const t=V;if(!t){alert("Error de Eliminaci√≥n: ID del cliente no encontrada.");return}const{error:e}=await m.from("clientes").delete().eq("client_id",t);if(e){console.error("Error al intentar eliminar el cliente:",e),e.code==="23503"?alert("‚ùå ERROR: No se puede eliminar el cliente. Tiene ventas o abonos pendientes asociados. Aseg√∫rate de eliminar el historial del cliente o configurar la eliminaci√≥n en cascada en Supabase."):alert("‚ùå Error desconocido al eliminar cliente: "+e.message),closeModal("client-delete-confirmation");return}alert("‚úÖ Cliente eliminado definitivamente."),closeModal("client-delete-confirmation"),V=null,await M()}window.handleNewClient=async function(t){var a,o,r;t.preventDefault(),console.log("1. FUNCI√ìN DE REGISTRO INICIADA.");const e=(a=document.getElementById("new-client-name"))==null?void 0:a.value.trim(),n=((o=document.getElementById("new-client-phone"))==null?void 0:o.value.trim())||null;if(console.log(`2. Datos capturados: Nombre='${e}', Tel√©fono='${n}'.`),typeof m>"u"||!m){console.error('ERROR CR√çTICO: La variable "supabase" no est√° definida o accesible globalmente.'),alert("Error: La conexi√≥n a la base de datos no est√° disponible.");return}if(!e||e.length<3){console.warn("Registro cancelado: Nombre inv√°lido."),alert("Por favor, ingresa un nombre v√°lido para el cliente."),(r=document.getElementById("new-client-name"))==null||r.focus();return}try{const{error:i}=await m.from("clientes").insert([{name:e,telefono:n,is_active:!0}]);if(i)console.error("4. ERROR DE SUPABASE al registrar cliente:",i),alert("Error al registrar cliente: "+i.message);else{alert("Cliente registrado exitosamente."),typeof window.loadClientsTable=="function"?await window.loadClientsTable("gestion"):console.error("ERROR: window.loadClientsTable no est√° definida para la recarga.");const d=document.getElementById("new-client-form");d==null||d.reset(),typeof closeModal=="function"?closeModal("new-client-modal"):console.error("closeModal no est√° definida globalmente.")}}catch(i){console.error("5. ERROR DE RED o EXCEPCI√ìN AL REGISTRAR:",i),alert("Error desconocido al registrar cliente. Verifique la conexi√≥n a Supabase.")}};function se(t){if(!m){console.error("Supabase no est√° inicializado.");return}const e=O.find(r=>String(r.client_id)===String(t));if(!e){alert("Error: Cliente no encontrado para editar.");return}const n=document.getElementById("edit-client-id");n&&(n.value=e.client_id);const a=document.getElementById("edit-client-name");a&&(a.value=e.name);const o=document.getElementById("edit-client-phone");o&&(o.value=e.telefono||""),openModal("edit-client-modal")}async function Le(t){t.preventDefault();const e=document.getElementById("edit-client-id").value,n=document.getElementById("edit-client-name").value.trim(),a=document.getElementById("edit-client-phone").value.trim();if(!e){alert("Error de Edici√≥n: No se pudo obtener la ID del cliente.");return}const{error:o}=await m.from("clientes").update({name:n,telefono:a}).eq("client_id",e);o?(console.error("Error al actualizar cliente:",o),alert("Error al actualizar cliente: "+o.message)):(alert("Cliente actualizado exitosamente."),await M(),document.getElementById("edit-client-form").reset(),closeModal("edit-client-modal"))}var oe;(oe=document.getElementById("confirm-delete-client-btn"))==null||oe.addEventListener("click",Ce);window.openAbonoModal=function(t,e,n=null){var s;window.debtToPayId=t;const a=window.allClientsMap[t]!==void 0,o=document.getElementById("abono-client-id-input"),r=document.getElementById("abono-client-name-display"),i=document.getElementById("abono-debt-info-container"),d=document.getElementById("abono-current-debt"),l=document.querySelector("#modal-record-abono h3");if(o&&(o.value=t),r){let c=a?`Deuda General de: ${e}`:`Venta #${t} de ${e}`;r.textContent=c}l&&(l.textContent=a?"Registrar Abono General":"Registrar Pago a Venta Espec√≠fica"),n!==null&&n>0?(i&&i.classList.remove("hidden"),d&&(d.textContent=E(n))):i&&i.classList.add("hidden"),(s=document.getElementById("abono-client-form"))==null||s.reset(),openModal("modal-record-abono")};async function Se(t){if(t.preventDefault(),!m){console.error("Supabase no est√° inicializado.");return}const e=document.getElementById("abono-amount-sale");document.getElementById("payment-method-sale").value,document.getElementById("payment-sale-id").value;let n=e?e.valueAsNumber:0;if(isNaN(n)){const a=e.value.replace(",",".");n=parseFloat(a)||0}{alert("Por favor, ingresa un monto de abono v√°lido y aseg√∫rate de que la venta y el cliente est√©n cargados.");return}}function S(t,e){(async()=>{if(!m){console.error("Supabase no est√° inicializado. No se pueden cargar los reportes.");return}const n=document.getElementById("monthly-sales-report-body"),a=document.getElementById("report-total-sales"),o=document.getElementById("report-total-debt-generated"),r=document.getElementById("monthly-report-no-data");if(!n||!a||!o||!r){console.error("‚õîÔ∏è FALLO DE DOM: Un elemento HTML del reporte no fue encontrado.");return}n.innerHTML='<tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando reporte...</td></tr>';try{const i=new Date().getMonth()+1,d=new Date().getFullYear();let l=t&&t>=1&&t<=12?t:i,s=e&&e>=2e3?e:d,c=new Date(Date.UTC(s,l-1,1)),u=l,y=s;u===12?(u=1,y+=1):u+=1;let p=new Date(Date.UTC(y,u-1,1));const w=c.toISOString(),h=p.toISOString(),{data:I,error:x}=await m.from("ventas").select(`
                    venta_id, 
                    client_id, 
                    created_at, 
                    total_amount, 
                    saldo_pendiente,
                    clientes(name) 
                `).gte("created_at",w).lt("created_at",h).order("created_at",{ascending:!1});if(x)throw x;let D=0,b=0;n.innerHTML="",I&&I.length>0?(I.forEach(g=>{var T;D+=g.total_amount,b+=g.saldo_pendiente;const L=((T=g.clientes)==null?void 0:T.name)||"Cliente Desconocido",N=`
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${F(g.created_at)} (Venta #${g.venta_id})</td>
                            <td class="px-6 py-3 whitespace-nowrap font-medium text-gray-900">${L}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-right text-gray-700">${E(g.total_amount)}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-right ${g.saldo_pendiente>.01?"text-red-600 font-bold":"text-green-600"}">
                                ${E(g.saldo_pendiente)}
                            </td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm flex space-x-2">
                                <button 
                                    onclick="handleViewSaleDetails('${g.venta_id}', '${g.client_id}')" 
                                    class="text-indigo-600 hover:text-indigo-900 font-medium text-xs py-1 px-2 rounded bg-indigo-100 transition-colors"
                                    title="Ver Detalle de la Venta"
                                >
                                    <i class="fas fa-eye"></i>
                                </button>
                                
                                <button 
                                    onclick="handleDeleteSale('${g.venta_id}', ${l}, ${s})" // <-- Incluimos los filtros para la recarga
                                    class="text-red-600 hover:text-red-800 font-medium text-xs py-1 px-2 rounded bg-red-100 transition-colors"
                                    title="Eliminar Venta"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;n.insertAdjacentHTML("beforeend",N)}),r.classList.add("hidden")):r.classList.remove("hidden"),a.textContent=E(D),o.textContent=E(b)}catch(i){console.error("Error al cargar el reporte mensual:",i),n.innerHTML='<tr><td colspan="5" class="text-center py-4 text-red-600">Fallo al cargar datos. Consulte la consola.</td></tr>',a.textContent=E(0),o.textContent=E(0)}})()}window.handleDeleteSale=async function(t,e,n){if(!m){alert("Error de conexi√≥n a la base de datos.");return}if(confirm(`ADVERTENCIA: ¬øEst√° seguro de que desea eliminar la Venta #${t}? 
        
        Esta acci√≥n es irreversible, eliminar√° todos los detalles y pagos asociados, y afectar√° la deuda del cliente.
        
        Presione OK para continuar.`))try{const{error:o}=await m.from("ventas").delete().eq("venta_id",t);if(o)throw console.error("Error de eliminaci√≥n en Supabase:",o),o.code==="23503"?new Error("Violaci√≥n de restricci√≥n: La venta tiene registros asociados que no se pudieron eliminar. Revise las reglas de 'ON DELETE CASCADE' en su base de datos."):o;alert(`Venta #${t} eliminada exitosamente.`),typeof S=="function"?await S(e,n):location.reload()}catch(o){console.error("Error al eliminar la venta:",o),alert(`Error al eliminar la venta. Detalles: ${o.message}`)}};function Pe(){const t=document.getElementById("report-month-select");if(!t)return;t.innerHTML="";const e=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],n=new Date().getMonth()+1;e.forEach((a,o)=>{const r=o+1,i=document.createElement("option");i.value=r,i.textContent=a,r===n&&(i.selected=!0),t.appendChild(i)})}function ne(){const t=document.getElementById("report-month-select"),e=document.getElementById("report-year-select");if(!t||!e){console.error("ERROR CR√çTICO: No se encontraron los selectores de Mes/A√±o del reporte.");return}const n=new Date().getFullYear(),a=new Date().getMonth()+1,o=2024,r=[{value:1,name:"Enero"},{value:2,name:"Febrero"},{value:3,name:"Marzo"},{value:4,name:"Abril"},{value:5,name:"Mayo"},{value:6,name:"Junio"},{value:7,name:"Julio"},{value:8,name:"Agosto"},{value:9,name:"Septiembre"},{value:10,name:"Octubre"},{value:11,name:"Noviembre"},{value:12,name:"Diciembre"}];t.innerHTML="",r.forEach(d=>{const l=document.createElement("option");l.value=d.value,l.textContent=d.name,t.appendChild(l)}),e.innerHTML="";for(let d=n+1;d>=o;d--){const l=document.createElement("option");l.value=d,l.textContent=d,e.appendChild(l)}t.value=a,e.value=n;const i=()=>{const d=parseInt(t.value)||a,l=parseInt(e.value)||n;typeof S=="function"?S(d,l):console.error("ERROR: loadMonthlySalesReport no es una funci√≥n accesible.")};t.addEventListener("change",i),e.addEventListener("change",i),setTimeout(()=>{const d=parseInt(t.value)||a,l=parseInt(e.value)||n;typeof S=="function"&&S(d,l)},10)}function ce(t){var s;const n=(c,u)=>{const y=E(u),p=32-c.length-y.length;return c+" ".repeat(p)+y},a=c=>{const u=32-c.length,y=Math.floor(u/2);return" ".repeat(y)+c};let o=a("Creativa Cortes CNC")+`
`;o+=`--------------------------------
`,o+=`
`,o+=a("Tel: 9851001141")+`
`,o+=a("Direcci√≥n: Calle 33 x 48 y 46")+`
`,o+=a("Col. Candelaria")+`
`,o+="Fecha: "+new Date(t.created_at).toLocaleDateString("es-MX")+`
`,o+="Venta: "+t.venta_id+`
`,o+=`--------------------------------
`;const r=((s=t.clientes)==null?void 0:s.name)||"Consumidor Final";o+="Cliente: "+r+`
`,o+=`================================
`,o+=`
`,o+=`Producto             Cant.  Total
`,o+=`--------------------------------
`,t.detalle_ventas.forEach(c=>{const y=c.productos.name.substring(0,18).padEnd(18," "),p=c.quantity.toString().padStart(5," "),w=E(c.subtotal).padStart(6," ");o+=`${y} ${p} ${w}
`}),o+=`--------------------------------
`,o+=`
`;const i=t.total_amount||0,d=t.saldo_pendiente||0,l=i-d;return o+=n("SALDO PENDIENTE:",d)+`
`,o+=n("ANTICIPO:",l)+`
`,o+=`================================
`,o+=n("TOTAL:",i)+`
`,o+=`================================
`,o+=`
`,o+=a("¬°Gracias por su compra!")+`
`,o+=`
`,o+=`--------------------------------
`,o}let ue=null;async function me(t){const{data:e,error:n}=await m.from("ventas").select("*, clientes(name), detalle_ventas (quantity, price, subtotal, productos(name))").eq("venta_id",t).single();if(n||!e)return;const o=`<pre style="font-family: monospace; font-size: 14px; margin: 0 auto; text-align: left;">${ce(e)}</pre>`,r=document.getElementById("ticket-preview-content");r&&(r.innerHTML=o),ue=t,openModal("modal-ticket-preview")}window.showTicketPreviewModal=me;async function Be(t){const{data:e,error:n}=await m.from("ventas").select("*, clientes(name), detalle_ventas (quantity, price, subtotal, productos(name))").eq("venta_id",t).single();if(n||!e){console.error("Error al obtener datos para impresi√≥n:",n==null?void 0:n.message);return}const a=ce(e);if(!qz.websocket.isActive()){alert("QZ Tray no est√° conectado. Por favor, aseg√∫rate de que est√© corriendo y recarga la p√°gina.");return}try{const o=[{type:"raw",data:a},{type:"raw",data:"VA\0"}],r=qz.configs.create("XP-58 (copy 1)",{encoding:"858"});await qz.print(r,o),console.log("Ticket enviado a la impresora correctamente.")}catch(o){alert("Error de impresi√≥n con QZ Tray. Revisa la consola para m√°s detalles."),console.error(o)}}async function Ae(){const{data:t,error:e}=await m.from("clientes").select("client_id, name");if(e){console.error("Error al cargar datos de clientes para el mapa:",e);return}t.reduce((n,a)=>(n[a.client_id]=a.name,n),{})}window.loadAndRenderProducts=async function(){await B();const t=window.allProducts||[],e=document.getElementById("products-table-body");if(!e){console.error("Error: No se encontr√≥ el <tbody> con ID 'products-table-body'.");return}if(e.innerHTML="",t.length===0){e.innerHTML='<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay productos registrados.</td></tr>';return}t.forEach(n=>{let a="";if(n.type==="PACKAGE")if(n.parent_product){const d=t.find(l=>String(l.producto_id)===String(n.parent_product));a=d?`<span class="text-xs text-gray-500 ml-1">(Padre: ${d.name})</span>`:'<span class="text-xs text-red-500 ml-1">(ID Padre No V√°lida/Eliminada)</span>'}else a='<span class="text-xs text-red-500 ml-1">(Sin Padre Asociado)</span>';const o=n.type==="PACKAGE"?"Paquete/Servicio":"Producto Individual",r=n.price?parseFloat(n.price).toFixed(2):"0.00",i=e.insertRow();i.className="hover:bg-gray-50",i.innerHTML=`
            <td class="px-3 py-2 whitespace-nowrap">${n.producto_id}</td>
            <td class="px-3 py-2 whitespace-nowrap font-medium">
                ${n.name} ${a}
            </td>
            <td class="px-3 py-2 whitespace-nowrap">${o}</td>
            <td class="px-3 py-2 whitespace-nowrap">$${r}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <button onclick="handleEditProductClick(${n.producto_id})" class="edit-product-btn text-blue-600 hover:text-blue-800 text-sm mr-2">Editar</button>
                <button onclick="handleDeleteProductClick(${n.producto_id})" class="delete-product-btn text-red-600 hover:text-red-800 text-sm">Eliminar</button>
            </td>
        `})};function F(t){if(!t)return"N/A";try{const e=new Date(t),n={year:"numeric",month:"2-digit",day:"2-digit"};return e.toLocaleDateString("es-MX",n)}catch(e){return console.error("Error al formatear la fecha:",e,t),"Fecha inv√°lida"}}document.addEventListener("DOMContentLoaded",async()=>{var d,l,s,c,u,y,p,w,h,I,x,D,b,g,L,P,N,T,U,G,K,Y,j,J,Z,X,W;async function t(f){const v=document.getElementById(f);if(!v){console.error(`Error: Modal con ID '${f}' no encontrado.`);return}f==="new-product-modal"&&typeof window.openNewProductModal=="function"&&await window.openNewProductModal(),v.classList.remove("hidden"),v.classList.add("flex")}document.querySelectorAll("[data-open-modal]").forEach(f=>{f.addEventListener("click",async v=>{v.preventDefault();const _=f.getAttribute("data-open-modal");await t(_)})}),window.openNewProductModal=async function(){await B(),await window.loadMainProductsAndPopulateSelect();const f=document.getElementById("new-product-type");f&&window.handleProductTypeChange&&(f.value="PRODUCT",window.handleProductTypeChange())},document.querySelectorAll("[data-close-modal]").forEach(f=>{f.addEventListener("click",v=>{v.preventDefault();const _=f.getAttribute("data-close-modal");closeModal(_)})}),document.addEventListener("click",f=>{document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(_=>{f.target===_&&closeModal(_.id)})}),document.addEventListener("keydown",f=>{if(f.key==="Escape"){const v=document.querySelectorAll(".modal-overlay:not(.hidden)"),_=v[v.length-1];_&&closeModal(_.id)}});function e(f){document.querySelectorAll(".menu-item").forEach(A=>{A.classList.remove("active-menu-item")}),document.querySelectorAll(".dashboard-view").forEach(A=>{A.classList.add("hidden")});const v=document.getElementById(f);v&&v.classList.remove("hidden");const _=document.querySelector(`[data-view="${f}"]`);_&&_.classList.add("active-menu-item"),f==="home-view"?M():f==="clients-view"?loadClientsTable("gestion"):f==="products-view"?loadAndRenderProducts():f==="report-view"&&(typeof ne=="function"?(console.log("--- INTENTANDO LLAMAR A LA INICIALIZACI√ìN DE SELECTORES DIRECTAMENTE ---"),ne()):typeof S=="function"&&S())}if(document.querySelectorAll("[data-view]").forEach(f=>{f.addEventListener("click",v=>{v.preventDefault();const _=f.getAttribute("data-view");e(_)})}),!window.supabase){console.error("Error Fatal: Librer√≠a Supabase no encontrada. La aplicaci√≥n no funcionar√°.");return}window.supabase||console.error("Error Fatal: Librer√≠a Supabase no encontrada. La aplicaci√≥n no funcionar√°."),await B(),await Ae(),k(),Pe();const n=document.getElementById("report-month-selector");n&&n.addEventListener("change",S),S();const a=document.getElementById("new-client-form");a&&a.addEventListener("submit",window.handleNewClient),(d=document.getElementById("open-sale-modal-btn"))==null||d.addEventListener("click",async()=>{var f;try{(f=document.getElementById("new-sale-form"))==null||f.reset(),await ae(),await B(),H(),C=[],z(),document.getElementById("total-amount").value="0.00",document.getElementById("paid-amount").value="0.00",document.getElementById("display-saldo-pendiente").value="0.00",t("new-sale-modal")}catch(v){console.error("Error al cargar datos del modal de venta:",v),alert("Error al cargar los datos. Revise la consola (F12).")}}),(l=document.getElementById("new-sale-form"))==null||l.addEventListener("submit",de),(s=document.getElementById("paid-amount"))==null||s.addEventListener("input",()=>R()),(c=document.getElementById("payment-method"))==null||c.addEventListener("change",()=>R()),(u=document.getElementById("paid-amount"))==null||u.addEventListener("input",()=>{q()}),(y=document.getElementById("payment-method"))==null||y.addEventListener("change",()=>{q()}),(p=document.getElementById("add-product-btn"))==null||p.addEventListener("click",he),(w=document.getElementById("abono-client-form"))==null||w.addEventListener("submit",ve),(h=document.getElementById("register-payment-form"))==null||h.addEventListener("submit",Se);const o=document.getElementById("paid-amount");o&&o.addEventListener("input",R);const r=document.getElementById("payment-method");r&&r.addEventListener("change",R),(I=document.getElementById("login-form"))==null||I.addEventListener("submit",ge),(x=document.getElementById("logout-btn"))==null||x.addEventListener("click",ye),(D=document.getElementById("sales-month-filter"))==null||D.addEventListener("change",()=>{M()}),(b=document.getElementById("reset-sales-filter"))==null||b.addEventListener("click",()=>{const f=document.getElementById("sales-month-filter");f&&(f.value=""),M()}),(g=document.getElementById("print-ticket-btn"))==null||g.addEventListener("click",()=>{Be(ue)}),(L=document.getElementById("open-monthly-report-btn"))==null||L.addEventListener("click",()=>{S(),t("modal-monthly-report")}),document.addEventListener("click",function(f){const v=f.target.closest(".view-sale-details-btn");if(v){const _=v.getAttribute("data-venta-id"),A=v.getAttribute("data-client-id");_&&A?(console.log(`DEBUG: Clic en Detalle Detectado. Venta ID: ${_}, Cliente ID: ${A}`),handleViewSaleDetails(_,A)):console.error("ERROR: El bot√≥n de detalle le faltan atributos (data-venta-id o data-client-id).")}}),document.addEventListener("DOMContentLoaded",()=>{const f=document.getElementById("new-client-form");f&&f.addEventListener("submit",handleNewClient)}),(P=document.getElementById("open-admin-products-modal"))==null||P.addEventListener("click",async()=>{try{await B(),await loadAndRenderProducts(),t("admin-products-modal")}catch(f){console.error("Error al cargar la administraci√≥n de productos:",f),alert("Error al cargar la lista de productos.")}}),(N=document.getElementById("open-product-modal-btn"))==null||N.addEventListener("click",()=>{var f;closeModal("admin-products-modal"),(f=document.getElementById("new-product-form"))==null||f.reset(),te(),t("modal-register-product")}),(T=document.getElementById("new-product-type"))==null||T.addEventListener("change",f=>{te(),f.target.value==="PACKAGE"&&re("parent-product-select")}),(U=document.getElementById("new-product-form"))==null||U.addEventListener("submit",_e),(G=document.getElementById("product-main-select"))==null||G.addEventListener("change",handleChangeProductForSale),(K=document.getElementById("subproduct-select"))==null||K.addEventListener("change",f=>{updatePriceField(f.target.value)}),(Y=document.getElementById("products-table-body"))==null||Y.addEventListener("click",f=>{if(!f.target.hasAttribute("data-product-id"))return;const v=f.target.getAttribute("data-product-id");f.target.classList.contains("edit-product-btn")&&(f.preventDefault(),handleEditProductClick(v)),f.target.classList.contains("delete-product-btn")&&(f.preventDefault(),handleDeleteProductClick(v))}),(j=document.getElementById("confirm-delete-btn"))==null||j.addEventListener("click",confirmDeleteProduct),(J=document.getElementById("edit-product-form"))==null||J.addEventListener("submit",handleEditProduct),(Z=document.getElementById("clients-list-body"))==null||Z.addEventListener("click",async f=>{const v=f.target.closest("button");if(v){f.preventDefault();const _=v.getAttribute("data-client-id");v.classList.contains("edit-client-btn")&&await se(_),v.classList.contains("delete-client-btn")&&le(_),v.classList.contains("view-debt-btn")&&await handleViewClientDebt(_)}}),(X=document.getElementById("edit-client-form"))==null||X.addEventListener("submit",Le);const i=document.getElementById("abono-client-form");i==null||i.addEventListener("submit",handleAbonoClientSubmit),(W=document.getElementById("open-abono-from-report-btn"))==null||W.addEventListener("click",f=>{var A;if(!window.viewingClientId){f.preventDefault();return}const v=((A=document.getElementById("client-report-total-debt"))==null?void 0:A.textContent)||"$0.00";if(parseFloat(v.replace(/[^0-9.-]+/g,"").replace(",","."))>.01){const Q=document.getElementById("abono-current-debt");Q&&(Q.textContent=v),t("modal-record-abono"),closeModal("modal-client-debt-report")}else f.preventDefault(),alert("El cliente no tiene deuda pendiente para registrar un abono.")})});document.addEventListener("DOMContentLoaded",()=>{console.log("DOM Cargado. Inicializando aplicaci√≥n...");const t=document.getElementById("edit-sale-price-form");t&&t.addEventListener("submit",handlePriceEditSubmit),window.loadDashboardData&&(window.loadDashboardData(),console.log("Datos del Dashboard cargados.")),document.body.addEventListener("click",e=>{const n=e.target.closest("[data-close-modal]");if(n){const o=n.dataset.closeModal;window.closeModal(o);return}const a=e.target.closest("[data-open-modal]");if(a){const o=a.dataset.openModal;typeof window[`open${o.split("-").map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join("")}`]=="function"?window[`open${o.split("-").map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join("")}`]():window.openModal(o)}if(e.target.classList.contains("modal-overlay")){const o=e.target.id;window.closeModal(o)}})});document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("confirm-delete-btn");t&&typeof window.confirmDeleteProduct=="function"&&(t.addEventListener("click",window.confirmDeleteProduct),console.log("‚úÖ Listener de confirmaci√≥n de eliminaci√≥n conectado."))});document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("product-main-select");t&&(t.addEventListener("change",window.handleChangeProductForSale),console.log("‚úÖ Listener de Producto Principal (product-main-select) conectado."));const e=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date"),a=document.getElementById("filter-search-term");e&&e.addEventListener("change",window.handleFilterSales),n&&n.addEventListener("change",window.handleFilterSales),a&&a.addEventListener("input",window.handleFilterSales),window.loadProductsData&&B().then(()=>{window.loadMainProductsForSaleSelect()}),window.loadSalesData&&window.loadSalesData().then(()=>{window.handleFilterSales()}),window.loadClientsData&&window.loadClientsData()});
