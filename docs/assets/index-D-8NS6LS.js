(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const G="https://wnwftbamyaotqdsivmas.supabase.co",V="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo";let l,M=[],E=[],D=null,C=null;try{if(!window.supabase)throw new Error("Librería Supabase no encontrada.");l=window.supabase.createClient(G,V)}catch(t){console.error("Error Fatal: Supabase no inicializó.",t),document.getElementById("auth-container").style.display="flex"}function g(t){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(t)}function Y(t){const e={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(t).toLocaleDateString("es-MX",e)}window.openModal=function(t){document.getElementById(t).classList.remove("hidden")};window.closeModal=function(t){const e=document.getElementById(t);e&&e.classList.add("hidden")};async function F(){const{data:{user:t}}=await l.auth.getUser(),e=document.getElementById("auth-container"),n=document.getElementById("main-app-content");t?(e.classList.add("hidden"),n.classList.remove("hidden"),await T()):(e.classList.remove("hidden"),n.classList.add("hidden"))}async function j(t){t.preventDefault();const e=document.getElementById("email").value,n=document.getElementById("password").value,{error:a}=await l.auth.signInWithPassword({email:e,password:n});a?alert(a.message):F()}async function Z(){await l.auth.signOut(),F()}async function Q(){const{data:t,error:e}=await l.from("ventas").select("total_amount");if(e){console.error("Error al cargar ventas:",e),document.getElementById("total-sales").textContent=g(0);return}const n=t.reduce((d,s)=>d+s.total_amount,0);document.getElementById("total-sales").textContent=g(n);const{data:a,error:o}=await l.from("ventas").select("saldo_pendiente").gt("saldo_pendiente",0);if(o){console.error("Error al cargar deudas:",o),document.getElementById("total-debt").textContent=g(0);return}const r=a.reduce((d,s)=>d+s.saldo_pendiente,0);document.getElementById("total-debt").textContent=g(r)}async function W(){const{data:t,error:e}=await l.from("ventas").select("venta_id, created_at, total_amount, saldo_pendiente, clientes(name)").gt("saldo_pendiente",0).order("created_at",{ascending:!1});if(e){console.error("Error al cargar tabla de deudas:",e);return}const n=document.getElementById("debt-table-body");if(n){if(n.innerHTML="",t.length===0){n.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">No hay deudas pendientes.</td></tr>';return}t.forEach(a=>{var d;const o=((d=a.clientes)==null?void 0:d.name)||"Cliente Desconocido",r=document.createElement("tr");r.className="hover:bg-gray-50",r.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${Y(a.created_at)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${o}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${g(a.total_amount)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">${g(a.saldo_pendiente)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-debt-id="${a.venta_id}" data-client-name="${o}" data-debt-amount="${a.saldo_pendiente}" class="text-indigo-600 hover:text-indigo-900 pay-debt-btn">Pagar</button>
            </td>
        `,n.appendChild(r)}),document.querySelectorAll(".pay-debt-btn").forEach(a=>{a.addEventListener("click",o=>{const r=o.target.dataset.debtId,d=o.target.dataset.clientName,s=parseFloat(o.target.dataset.debtAmount);ie(r,d,s)})})}}async function T(){await Q(),await W(),await P(),await _(),await S()}async function A(){const t=document.getElementById("client-select");if(!t)return;t.innerHTML='<option value="" disabled selected>Cargando clientes...</option>';const{data:e,error:n}=await l.from("clientes").select("client_id, name").eq("is_active",!0).order("name",{ascending:!0});if(n){console.error("Error al cargar clientes para venta:",n),t.innerHTML='<option value="" disabled selected>Error al cargar (revisar consola)</option>';return}if(e.length===0){t.innerHTML='<option value="" disabled selected>No hay clientes activos</option>';return}t.innerHTML='<option value="" disabled selected>Seleccione un Cliente</option>',e.forEach(a=>{const o=document.createElement("option");o.value=a.client_id,o.textContent=a.name,t.appendChild(o)})}async function _(){const{data:t,error:e}=await l.from("productos").select("producto_id, name, type, price, parent_product");if(e){console.error("Error al cargar todos los productos:",e),M=[];return}M=t||[]}async function $(t){const e=M.filter(a=>a.type==="MAIN"),n=document.getElementById(t);n&&(n.innerHTML='<option value="" disabled selected>Seleccione Producto Principal</option>',e.forEach(a=>{const o=document.createElement("option");o.value=a.name,o.textContent=a.name,n.appendChild(o)}))}function ee(t){const e=document.getElementById("subproduct-select"),n=document.getElementById("product-unit-price");if(!e||!n)return;e.innerHTML="",e.disabled=!0;const a=M.filter(r=>r.type==="PACKAGE"&&r.parent_product===t);let o=M.find(r=>r.name===t&&r.type==="MAIN");if(e.innerHTML='<option value="" data-price="0" disabled selected>Seleccione un Paquete/Base</option>',a.length>0&&a.forEach(r=>{const d=document.createElement("option");d.value=r.producto_id,d.textContent=`${r.name} (Paquete) - ${g(r.price)}`,d.dataset.price=r.price,e.appendChild(d)}),o){const r=document.createElement("option");r.value=o.producto_id,r.textContent=`[Precio Base] - ${g(o.price)}`,r.dataset.price=o.price,e.appendChild(r),a.length===0?(e.value=o.producto_id,n.value=o.price.toFixed(2)):n.value="0.00"}else n.value="0.00";e.disabled=!1}function H(){const t=document.getElementById("total-amount"),e=document.getElementById("paid-amount"),n=document.getElementById("remaining-balance"),a=E.reduce((d,s)=>d+s.subtotal,0);t&&(t.value=a.toFixed(2));const o=parseFloat(e==null?void 0:e.value)||0,r=Math.max(0,a-o);n&&(n.value=r.toFixed(2))}function q(){const t=document.getElementById("sale-items-container");if(t){if(t.innerHTML="",E.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">Agrega productos a la venta.</td></tr>';return}E.forEach((e,n)=>{const a=document.createElement("tr");a.className="hover:bg-gray-50",a.dataset.index=n,a.innerHTML=`
            <td class="px-6 py-3 text-sm font-medium text-gray-900">${e.name}</td>
            <td class="px-6 py-3 text-sm text-gray-500">${g(e.price)}</td>
            <td class="px-6 py-3 text-sm text-gray-500">${e.quantity}</td>
            <td class="px-6 py-3 text-sm font-bold">${g(e.subtotal)}</td>
            <td class="px-6 py-3 text-right text-sm font-medium">
                <button type="button" onclick="removeItemFromSale(${n})" 
                        class="text-red-600 hover:text-red-900">
                    <i class="fas fa-times-circle"></i>
                </button>
            </td>
        `,t.appendChild(a)})}}function te(t){const e=document.getElementById("sale-items-container");if(!e)return;E.length===1&&(e.innerHTML="");const n=document.createElement("tr");n.className="hover:bg-gray-50",n.dataset.index=E.length-1,n.innerHTML=`
        <td class="px-6 py-3 text-sm font-medium text-gray-900">${t.name}</td>
        <td class="px-6 py-3 text-sm text-gray-500">${g(t.price)}</td>
        <td class="px-6 py-3 text-sm text-gray-500">${t.quantity}</td>
        <td class="px-6 py-3 text-sm font-bold">${g(t.subtotal)}</td>
        <td class="px-6 py-3 text-right text-sm font-medium">
            <button type="button" onclick="removeItemFromSale(${n.dataset.index})" 
                    class="text-red-600 hover:text-red-900">
                <i class="fas fa-times-circle"></i>
            </button>
        </td>
    `,e.appendChild(n),H()}window.removeItemFromSale=function(t){E.splice(t,1),q(),H()};function ne(t){var y;t.preventDefault();const e=document.getElementById("subproduct-select"),n=document.getElementById("product-quantity"),a=document.getElementById("product-unit-price"),o=e==null?void 0:e.value,r=(y=e==null?void 0:e.selectedOptions[0])==null?void 0:y.textContent,d=parseFloat(n==null?void 0:n.value),s=parseFloat(a==null?void 0:a.value);if(!o||o===""){alert("Por favor, selecciona un Paquete/Subcategoría o Precio Base.");return}if(isNaN(d)||d<=0){alert("La cantidad debe ser mayor a cero.");return}if(isNaN(s)||s<0){alert("El precio debe ser un valor válido.");return}const u=d*s,p={product_id:o,name:r.split("(")[0].trim().replace("[Precio Base]","").trim(),quantity:d,price:s,subtotal:u};E.push(p),te(p),document.getElementById("product-main-select").value="",e.innerHTML='<option value="" disabled selected>Seleccione Principal primero</option>',e.disabled=!0,n.value="1",a.value="0.00"}async function ae(t){var y,b,w,h,I;t.preventDefault();const e=((y=document.getElementById("client-select"))==null?void 0:y.value)??null,n=((b=document.getElementById("total-amount"))==null?void 0:b.value)??"0",a=((w=document.getElementById("paid-amount"))==null?void 0:w.value)??"0",o=((h=document.getElementById("payment-method"))==null?void 0:h.value)??"Efectivo",r=((I=document.getElementById("sale-description"))==null?void 0:I.value.trim())??null,d=parseFloat(n),s=parseFloat(a),u=d-s,p=E;if(!e){alert("Por favor, selecciona un cliente.");return}if(p.length===0){alert("Debes agregar al menos un producto a la venta.");return}if(s>d){alert("El monto pagado no puede ser mayor que el total de la venta.");return}try{const{data:v,error:x}=await l.from("ventas").insert([{client_id:e,total_amount:d,paid_amount:s,saldo_pendiente:u,metodo_pago:o,description:r}]).select("venta_id");if(x||!v||v.length===0){console.error("Error al insertar venta:",x),alert(`Error al registrar la venta: ${(x==null?void 0:x.message)||"Desconocido"}`);return}const B=v[0].venta_id,N=p.map(f=>({venta_id:B,product_id:f.product_id,name:f.name,quantity:f.quantity,price:f.price,subtotal:f.subtotal})),{error:L}=await l.from("detalle_ventas").insert(N);if(L&&(console.error("Error al insertar detalles de venta:",L),alert(`Venta registrada (ID: ${B}), pero falló el registro de detalles: ${L.message}`)),s>0){const{error:f}=await l.from("pagos").insert([{venta_id:B,amount:s,client_id:e,metodo_pago:o}]);f&&(console.error("Error al registrar pago inicial:",f),alert(`Advertencia: El pago inicial falló. ${f.message}`))}alert("Venta, detalles y pago (si aplica) registrados exitosamente."),closeModal("new-sale-modal"),await T()}catch(v){console.error("Error fatal al registrar la venta:",v.message),alert("Error fatal al registrar la venta: "+v.message)}finally{E=[],q()}}async function P(){const{data:t,error:e}=await l.from("clientes").select("client_id, name, telefono").order("name",{ascending:!0});if(e){console.error("Error al cargar clientes:",e);return}const n=document.getElementById("clients-table-body"),a=document.getElementById("admin-clients-table-body"),o=[n,a].filter(r=>r);if(o.length!==0){if(o.forEach(r=>r.innerHTML=""),t.length===0){const r='<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500 italic">No hay clientes registrados.</td></tr>';o.forEach(d=>d.innerHTML=r);return}t.forEach(r=>{const d=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${r.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.telefono||"N/A"}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-client-id="${r.client_id}" class="text-indigo-600 hover:text-indigo-900 edit-client-btn mr-2">Editar</button>
                <button data-client-id="${r.client_id}" class="text-red-600 hover:text-red-900 delete-client-btn">Eliminar</button>
            </td>
        `;o.forEach(s=>{const u=document.createElement("tr");u.className="hover:bg-gray-50",u.innerHTML=d,s.appendChild(u)})})}}async function oe(t){t.preventDefault();const e=document.getElementById("new-client-name").value,n=document.getElementById("new-client-phone").value,{error:a}=await l.from("clientes").insert([{name:e,telefono:n,is_active:!0}]);a?alert("Error al registrar cliente: "+a.message):(alert("Cliente registrado exitosamente."),closeModal("new-client-modal"),await P(),await A())}async function z(t){const{data:e,error:n}=await l.from("clientes").select("name, telefono").eq("client_id",t).single();if(n||!e){alert("Error al cargar datos del cliente para editar: "+((n==null?void 0:n.message)||"No encontrado"));return}D=t,document.getElementById("edit-client-name").value=e.name,document.getElementById("edit-client-phone").value=e.telefono||"",openModal("edit-client-modal")}async function re(t){if(t.preventDefault(),!D)return;const e=document.getElementById("edit-client-name").value,n=document.getElementById("edit-client-phone").value,{error:a}=await l.from("clientes").update({name:e,telefono:n}).eq("client_id",D);a?alert("Error al actualizar cliente: "+a.message):(alert("Cliente actualizado exitosamente."),closeModal("edit-client-modal"),await P(),await A())}async function R(t){if(!confirm("ADVERTENCIA: ¿Estás seguro de ELIMINAR PERMANENTEMENTE este cliente? Se borrarán todas sus ventas, pagos y deudas relacionadas."))return;const{error:e}=await l.rpc("delete_client_cascade",{client_to_delete_id:t});e?alert("Error al eliminar cliente: "+e.message+" Asegúrate de tener configurado el RPC `delete_client_cascade`."):(alert("Cliente y todos sus registros relacionados eliminados exitosamente."),await P(),await A(),await T())}window.loadSalesList=async function(){const t=document.getElementById("sales-list-body");t.innerHTML='<tr><td colspan="6" class="p-4 text-center">Cargando ventas...</td></tr>';const{data:e,error:n}=await l.from("ventas").select(`
            venta_id, 
            created_at, 
            total_amount, 
            saldo_pendiente, 
            clientes ( name ) // Usando 'clientes'
        `).order("created_at",{ascending:!1});if(n){console.error("Error al cargar la lista de ventas:",n),t.innerHTML='<tr><td colspan="6" class="p-4 text-center text-red-500">Error al cargar las ventas.</td></tr>';return}if(t.innerHTML="",e.length===0){t.innerHTML='<tr><td colspan="6" class="p-4 text-center text-gray-500">No hay ventas registradas.</td></tr>';return}e.forEach(a=>{const o=t.insertRow(),r=new Date(a.created_at).toLocaleDateString(),d=a.total_amount.toFixed(2),s=a.saldo_pendiente.toFixed(2),u=a.clientes.name;o.className=`cursor-pointer hover:bg-gray-100 ${a.saldo_pendiente>0?"bg-yellow-50":""}`,o.setAttribute("data-venta-id",a.venta_id),o.innerHTML=`
            <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${a.venta_id}</td>
            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${u}</td>
            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${r}</td>
            <td class="px-6 py-3 whitespace-nowrap text-sm font-bold text-right">$${d}</td>
            <td class="px-6 py-3 whitespace-nowrap text-sm font-bold text-right text-red-600">$${s}</td>
            <td class="px-6 py-3 whitespace-nowrap text-sm text-center">
                <button onclick="openSaleDetailModal(${a.venta_id})" class="text-indigo-600 hover:text-indigo-900 font-semibold text-xs">Ver Detalle</button>
            </td>
        `}),document.getElementById("sales-search").onkeyup=function(){de(this.value)}};window.openSaleDetailModal=async function(t){const{data:e,error:n}=await l.from("ventas").select(`
            *, 
            clientes ( name ),
            detalle_ventas ( name, quantity, price, subtotal ),
            pagos ( created_at, amount, metodo_pago )
        `).eq("venta_id",t).single();if(n||!e){console.error("Error al cargar detalle de venta:",n),alert("No se pudo cargar el detalle de la venta.");return}const a=d=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(d);document.getElementById("detail-sale-id").textContent=`#${e.venta_id}`,document.getElementById("detail-client-name").textContent=e.clientes.name,document.getElementById("detail-description").textContent=e.description||"Sin descripción",document.getElementById("detail-total-amount").textContent=a(e.total_amount),document.getElementById("detail-paid-amount").textContent=a(e.paid_amount),document.getElementById("detail-saldo-pendiente").textContent=a(e.saldo_pendiente);const o=document.getElementById("detail-products-body");o.innerHTML="",e.detalle_ventas.forEach(d=>{o.innerHTML+=`
            <tr>
                <td class="px-6 py-2 whitespace-nowrap">${d.name}</td>
                <td class="px-6 py-2 whitespace-nowrap text-center">${d.quantity}</td>
                <td class="px-6 py-2 whitespace-nowrap text-right">${a(d.price)}</td>
                <td class="px-6 py-2 whitespace-nowrap text-right font-semibold">${a(d.subtotal)}</td>
            </tr>
        `});const r=document.getElementById("detail-payments-body");r.innerHTML="",e.pagos.length===0?r.innerHTML='<tr><td colspan="3" class="px-6 py-2 text-center text-gray-500">No hay abonos registrados.</td></tr>':(e.pagos.sort((d,s)=>new Date(s.created_at)-new Date(d.created_at)),e.pagos.forEach(d=>{const s=new Date(d.created_at).toLocaleDateString("es-MX",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});r.innerHTML+=`
                <tr>
                    <td class="px-6 py-2 whitespace-nowrap">${s}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-right font-semibold text-green-700">${a(d.amount)}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-center">${d.metodo_pago}</td>
                </tr>
            `})),document.getElementById("payment-sale-id").value=e.venta_id,document.getElementById("abono-amount").value="",document.getElementById("abono-amount").setAttribute("max",e.saldo_pendiente),document.getElementById("submit-abono-btn").disabled=e.saldo_pendiente<=.01,document.getElementById("submit-abono-btn").textContent=e.saldo_pendiente<=.01?"Saldada":"Abonar",openModal("sale-detail-modal")};function de(t){const e=document.getElementById("sales-list-body").querySelectorAll("tr"),n=t.toLowerCase();e.forEach(a=>{a.textContent.toLowerCase().includes(n)?a.style.display="":a.style.display="none"})}var U;(U=document.getElementById("register-payment-form"))==null||U.addEventListener("submit",se);async function se(t){t.preventDefault();const e=document.getElementById("payment-sale-id").value,n=document.getElementById("abono-amount").value.trim(),a=document.getElementById("payment-method-abono").value,o=parseFloat(n),r=I=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(I);if(n===""||isNaN(o)||o<=0){alert("Por favor, ingresa un monto válido para el abono (mayor a cero).");return}const{data:d,error:s}=await l.from("ventas").select("total_amount, paid_amount, saldo_pendiente, client_id").eq("venta_id",e).single();if(s||!d){alert("Error al obtener datos de la venta para el abono.");return}if(d.saldo_pendiente<=.01){alert("Esta venta ya está saldada.");return}const u=d.saldo_pendiente;o>u&&alert(`Advertencia: El abono excede el saldo pendiente. Solo se aplicará el monto restante: ${r(u)}.`);const p=Math.min(o,u),y=d.paid_amount+p,b=d.total_amount-y,{error:w}=await l.from("pagos").insert([{venta_id:e,amount:p,client_id:d.client_id,metodo_pago:a}]);if(w){alert("Error al registrar el abono: "+w.message);return}const{error:h}=await l.from("ventas").update({paid_amount:y,saldo_pendiente:b}).eq("venta_id",e);alert(h?"Advertencia: El abono se registró, pero falló la actualización del saldo en la venta. Contacte soporte.":`Abono de ${r(p)} registrado exitosamente.`),closeModal("sale-detail-modal"),await loadSalesList(),openModal("admin-sales-modal"),await T()}function X(){var n;const t=(n=document.getElementById("new-product-type"))==null?void 0:n.value,e=document.getElementById("parent-product-container");e&&(t==="PACKAGE"?(e.classList.remove("hidden"),$("parent-product-select")):e.classList.add("hidden"))}async function S(){await _();const t=document.getElementById("products-table-body");if(!t)return;t.innerHTML="";const e=M;if(e.length===0){t.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 italic">No hay productos registrados.</td></tr>';return}e.forEach(n=>{const a=document.createElement("tr");a.className="hover:bg-gray-50",a.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${n.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${n.type}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${n.parent_product||"N/A"}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${g(n.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-product-id="${n.producto_id}" class="text-indigo-600 hover:text-indigo-900 edit-product-btn mr-2">Editar</button>
                <button data-product-id="${n.producto_id}" class="text-red-600 hover:text-red-900 delete-product-btn">Eliminar</button>
            </td>
        `,t.appendChild(a)})}async function J(t){t.preventDefault();const e=document.getElementById("new-product-name").value,n=parseFloat(document.getElementById("new-product-price").value),a=document.getElementById("new-product-type").value,o=document.getElementById("parent-product-select").value||null;if(a==="PACKAGE"&&!o){alert("Los paquetes deben tener un Producto Principal asociado.");return}if(isNaN(n)||n<0){alert("El precio debe ser un número válido (mayor o igual a cero).");return}const{error:r}=await l.from("productos").insert([{name:e,price:n,type:a,parent_product:o}]);r?alert("Error al registrar producto: "+r.message):(alert("Producto registrado exitosamente."),closeModal("new-product-modal"),await _(),await S())}async function le(t){if(!t)return;const{data:e,error:n}=await l.from("productos").select("*").eq("producto_id",t).single();if(n){console.error("Error al cargar producto para edición:",n),alert(`Error al cargar producto: ${n.message}`);return}const a=document.getElementById("new-product-form");document.getElementById("modal-title-product").textContent=`Editar Producto: ${e.name}`,document.getElementById("new-product-name").value=e.name,document.getElementById("new-product-price").value=e.price,document.getElementById("new-product-type").value=e.type,document.getElementById("new-product-description").value=e.description||"",a&&(a.dataset.editingId=t,a.removeEventListener("submit",J),a.addEventListener("submit",K))}async function K(t){t.preventDefault()}async function ce(t){if(!confirm("¿Estás seguro de eliminar este producto? Esto podría causar errores si está vinculado a ventas existentes."))return;const{error:e}=await l.from("productos").delete().eq("producto_id",t);e?alert("Error al eliminar producto: "+e.message):(alert("Producto eliminado exitosamente."),await _(),await S())}function ie(t,e,n){C=t,document.getElementById("payment-client-name").textContent=e,document.getElementById("payment-debt-amount").textContent=g(n),document.getElementById("payment-amount").value=n.toFixed(2),document.getElementById("payment-amount").max=n.toFixed(2),window.openModal=function(a){document.getElementById(a).classList.remove("hidden")}}async function ue(t){if(t.preventDefault(),!C)return;const e=parseFloat(document.getElementById("payment-amount").value),n=document.getElementById("payment-method-debt").value,a=document.getElementById("payment-debt-amount").textContent,o=parseFloat(a.replace(/[^0-9.]/g,""));if(isNaN(e)||e<=0){alert("El monto del pago debe ser mayor a cero.");return}if(e>o){alert("El monto del pago no puede ser mayor que el saldo pendiente.");return}const{data:r,error:d}=await l.from("ventas").select("client_id, saldo_pendiente, paid_amount").eq("venta_id",C).single();if(d||!r){alert("Error al obtener datos de la deuda: "+((d==null?void 0:d.message)||"Desconocido"));return}const s=r.saldo_pendiente-e,u=r.paid_amount+e,{error:p}=await l.from("pagos").insert([{venta_id:C,client_id:r.client_id,amount:e,metodo_pago:n}]);if(p){alert("Error al registrar pago: "+p.message);return}const{error:y}=await l.from("ventas").update({saldo_pendiente:s,paid_amount:u}).eq("venta_id",C);if(y){alert("Pago registrado, pero falló la actualización del saldo. Contacte soporte."),console.error("Error al actualizar venta:",y);return}alert("Pago registrado y saldo actualizado exitosamente.")}document.addEventListener("DOMContentLoaded",()=>{var t,e,n,a,o,r,d,s,u,p,y,b,w,h,I,v,x,B,N,L,f,O;F(),(t=document.getElementById("login-form"))==null||t.addEventListener("submit",j),(e=document.getElementById("logout-button"))==null||e.addEventListener("click",Z),(n=document.getElementById("open-new-sale-modal"))==null||n.addEventListener("click",async()=>{try{await A(),await _(),await $("product-main-select"),E=[],q(),document.getElementById("total-amount").value="0.00",document.getElementById("paid-amount").value="0.00",document.getElementById("remaining-balance").value="0.00",openModal("new-sale-modal")}catch(i){console.error("Error al cargar datos de selects:",i),alert("Error al cargar los datos. Revise la consola (F12).")}}),(a=document.getElementById("new-sale-form"))==null||a.addEventListener("submit",ae),(o=document.getElementById("add-product-btn"))==null||o.addEventListener("click",ne),(r=document.getElementById("paid-amount"))==null||r.addEventListener("input",H),(d=document.getElementById("product-main-select"))==null||d.addEventListener("change",i=>{const c=i.target.value;ee(c)}),(s=document.getElementById("subproduct-select"))==null||s.addEventListener("change",()=>{var k;const i=document.getElementById("subproduct-select"),c=document.getElementById("product-unit-price"),m=parseFloat((k=i==null?void 0:i.selectedOptions[0])==null?void 0:k.dataset.price)||0;c&&(c.value=m.toFixed(2))}),(u=document.getElementById("open-admin-clients-modal"))==null||u.addEventListener("click",()=>{P(),openModal("admin-clients-modal")}),(p=document.getElementById("open-new-client-modal"))==null||p.addEventListener("click",()=>{openModal("new-client-modal")}),(y=document.getElementById("new-client-form"))==null||y.addEventListener("submit",oe),(b=document.getElementById("edit-client-form"))==null||b.addEventListener("submit",re),(w=document.getElementById("clients-table-body"))==null||w.addEventListener("click",i=>{const c=i.target;c.classList.contains("edit-client-btn")?z(c.dataset.clientId):c.classList.contains("delete-client-btn")&&R(c.dataset.clientId)}),(h=document.getElementById("admin-clients-table-body"))==null||h.addEventListener("click",i=>{const c=i.target;c.classList.contains("edit-client-btn")?z(c.dataset.clientId):c.classList.contains("delete-client-btn")&&R(c.dataset.clientId)}),(I=document.getElementById("open-admin-products-modal"))==null||I.addEventListener("click",async()=>{await _(),await S(),openModal("admin-products-modal")}),(v=document.getElementById("open-new-product-modal"))==null||v.addEventListener("click",async()=>{await _(),await $("parent-product-select"),X(),openModal("new-product-modal")}),(x=document.getElementById("new-product-form"))==null||x.addEventListener("submit",J),(B=document.getElementById("edit-product-form"))==null||B.addEventListener("submit",K),(N=document.getElementById("new-product-type"))==null||N.addEventListener("change",X),(L=document.getElementById("products-table-body"))==null||L.addEventListener("click",i=>{const c=i.target;c.classList.contains("edit-product-btn")?le(c.dataset.productId):c.classList.contains("delete-product-btn")&&ce(c.dataset.productId)}),(f=document.getElementById("edit-product-type"))==null||f.addEventListener("change",async i=>{const c=i.target.value,m=document.getElementById("edit-parent-product-container");c==="PACKAGE"?(m==null||m.classList.remove("hidden"),await $("edit-parent-product-select")):m==null||m.classList.add("hidden")}),(O=document.getElementById("payment-form"))==null||O.addEventListener("submit",ue),document.querySelectorAll("[data-close-modal]").forEach(i=>{i.addEventListener("click",c=>{c.preventDefault();const m=i.getAttribute("data-close-modal");closeModal(m)})}),document.addEventListener("click",i=>{document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(m=>{i.target===m&&closeModal(m.id)})}),document.addEventListener("keydown",i=>{if(i.key==="Escape"){const c=document.querySelectorAll(".modal-overlay:not(.hidden)"),m=c[c.length-1];m&&closeModal(m.id)}})});
