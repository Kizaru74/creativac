(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function a(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=a(o);fetch(o.href,r)}})();const D="https://wnwftbamyaotqdsivmas.supabase.co",$="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indud2Z0YmFteWFvdHFkc2l2bWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTY0OTcsImV4cCI6MjA3OTE3MjQ5N30.r8Fh7FUYOnUQHboqfKI1eb_37NLuAn3gRLbH8qUPpMo";let s,I=[];try{if(!window.supabase)throw new Error("Librería Supabase no encontrada.");s=window.supabase.createClient(D,$)}catch(t){console.error("Error Fatal: Supabase no inicializó.",t),document.getElementById("auth-container").style.display="flex",document.getElementById("main-app-content").style.display="none"}function _(t){const e=document.getElementById(t);e&&(e.classList.remove("hidden"),e.classList.add("flex"))}function v(t){const e=document.getElementById(t);if(e){e.classList.add("hidden"),e.classList.remove("flex");const a=e.querySelector("form");if(a&&a.reset(),t==="new-sale-modal"){const n=document.getElementById("sale-total-amount"),o=document.getElementById("sale-debt-display");n&&(n.textContent=y(0)),o&&(o.textContent=y(0));const r=document.getElementById("subproduct-select");r&&(r.innerHTML='<option value="" data-price="0" disabled selected>Seleccione Principal primero</option>',r.disabled=!0);const c=document.getElementById("main-product-select");c&&c.removeEventListener("change",P)}}}function y(t){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(t)}async function C(){const t=document.getElementById("main-app-content"),e=document.getElementById("auth-container");if(!s||!t||!e){e&&(e.style.display="flex");return}const{data:{session:a},error:n}=await s.auth.getSession();n||!a?(e.style.display="flex",t.style.display="none"):(e.style.display="none",t.style.display="block",x())}async function A(t){t.preventDefault();const e=document.getElementById("email").value,a=document.getElementById("password").value,{error:n}=await s.auth.signInWithPassword({email:e,password:a});n?alert(n.message):C()}async function N(){const{error:t}=await s.auth.signOut();t&&console.error("Error al cerrar sesión:",t),C()}async function x(){await T(),await H(),await O()}async function T(){const t=document.getElementById("total-clients"),e=document.getElementById("total-sales"),a=document.getElementById("total-debt");if(!t||!e||!a)return;const{count:n,error:o}=await s.from("clientes").select("client_id",{count:"exact",head:!0});o?t.textContent="Error":t.textContent=n;const{data:r,error:c}=await s.from("ventas").select("total_amount, paid_amount");if(c){console.error("Error al cargar ventas para totales:",c),e.textContent="Error",a.textContent="Error";return}let l=0,m=0;r.forEach(d=>{const i=parseFloat(d.total_amount)||0,u=parseFloat(d.paid_amount)||0;l+=i,m+=u});const p=l-m;e.textContent=y(l),a.textContent=y(p)}async function H(){const t=document.getElementById("debts-table-body");if(!t)return;t.innerHTML='<tr><td colspan="4" class="p-3 text-center text-gray-500">Cargando deudas...</td></tr>';const{data:e,error:a}=await s.from("ventas").select(`
            venta_id, 
            total_amount, 
            paid_amount,
            created_at,
clientes!ventas_client_id_fkey (name)
        `).order("created_at",{ascending:!1});if(a){console.error("Error al cargar ventas:",a),t.innerHTML=`<tr><td colspan="4" class="p-3 text-center text-red-500">Error: ${a.message}.</td></tr>`;return}const n=e.filter(o=>{const r=parseFloat(o.total_amount)||0,c=parseFloat(o.paid_amount)||0;return r>c});if(n.length===0){t.innerHTML='<tr><td colspan="4" class="p-3 text-center text-gray-500">No hay deudas pendientes.</td></tr>';return}t.innerHTML=n.map(o=>{var d;const r=parseFloat(o.total_amount)||0,c=parseFloat(o.paid_amount)||0,l=r-c,m=((d=o["clientes!ventas_client_id_fkey"])==null?void 0:d.name)||"Cliente Desconocido",p=new Date(o.created_at).toLocaleDateString();return`
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">${m} (Venta #${o.venta_id})</td>
                <td class="px-6 py-4 whitespace-nowrap text-red-600 font-bold">${y(l)}</td>
                <td class="px-6 py-4 whitespace-nowrap">${p}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="text-indigo-600 hover:text-indigo-800 text-sm pay-debt-btn" data-sale-id="${o.venta_id}">
                        Pagar
                    </button>
                </td>
            </tr>
        `}).join(""),document.querySelectorAll(".pay-debt-btn").forEach(o=>{o.addEventListener("click",r=>{const c=r.currentTarget.dataset.saleId;R(c)})})}async function O(){const t=document.getElementById("clients-table-body");if(!t)return;const{data:e,error:a}=await s.from("clientes").select("client_id, name, contact").order("name",{ascending:!0});if(a){t.innerHTML=`<tr><td colspan="3" class="p-3 text-center text-red-500">Error al cargar clientes: ${a.message}</td></tr>`;return}if(e.length===0){t.innerHTML='<tr><td colspan="3" class="p-3 text-center text-gray-500">No hay clientes registrados.</td></tr>';return}t.innerHTML=e.map(n=>`
        <tr>
            <td class="px-6 py-4 whitespace-nowrap font-medium">${n.name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${n.contact||"N/A"}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button class="text-indigo-600 hover:text-indigo-800 text-sm view-client-btn" data-client-id="${n.client_id}">
                    Ver Deuda
                </button>
            </td>
        </tr>
    `).join("")}async function k(){const t=document.getElementById("sale-client-select");if(!t)return;t.innerHTML='<option value="" disabled selected>Cargando clientes...</option>';const{data:e,error:a}=await s.from("clientes").select("client_id, name").order("name",{ascending:!0});if(a)throw console.error("Error al cargar clientes:",a),t.innerHTML='<option value="" disabled selected>Error al cargar clientes</option>',new Error(`Fallo la carga de clientes: ${a.message}`);t.innerHTML='<option value="" disabled selected>Seleccione un cliente</option>',e.forEach(n=>{const o=document.createElement("option");o.value=n.client_id,o.textContent=n.name,t.appendChild(o)})}async function U(){if(I.length>0)return;const{data:t,error:e}=await s.from("productos").select("producto_id, name, price, type, parent_product").order("name",{ascending:!0});if(e)throw console.error("Error al cargar productos para select:",e),new Error("Fallo la carga de productos/paquetes");I=t}async function B(){const t=document.getElementById("admin-products-table-body");if(!t)return;t.innerHTML='<tr><td colspan="4" class="p-3 text-center text-gray-500">Cargando productos...</td></tr>';const{data:e,error:a}=await s.from("productos").select("*").order("type",{ascending:!1}).order("name",{ascending:!0});if(a){console.error("Error al cargar productos para la tabla:",a),t.innerHTML=`<tr><td colspan="4" class="p-3 text-center text-red-500">Error al cargar productos: ${a.message}</td></tr>`;return}if(e.length===0){t.innerHTML='<tr><td colspan="4" class="p-3 text-center text-gray-500">No hay productos o paquetes registrados.</td></tr>';return}t.innerHTML=e.map(n=>`
        <tr>
            <td class="px-6 py-4 whitespace-nowrap font-medium">${n.name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${n.type==="MAIN"?"Principal":"Paquete"}</td>
            <td class="px-6 py-4 whitespace-nowrap">${y(n.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button class="text-indigo-600 hover:text-indigo-800 text-sm edit-product-btn" data-product-id="${n.producto_id}">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="text-red-600 hover:text-red-800 text-sm delete-product-btn ml-3" data-product-id="${n.producto_id}">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </td>
        </tr>
    `).join(""),document.querySelectorAll(".edit-product-btn").forEach(n=>{n.addEventListener("click",o=>{const r=o.currentTarget.dataset.productId;z(r)})}),document.querySelectorAll(".delete-product-btn").forEach(n=>{n.addEventListener("click",o=>{const r=o.currentTarget.dataset.productId;J(r)})})}async function j(t){t.preventDefault();const e=document.getElementById("new-client-name").value.trim(),a=document.getElementById("new-client-phone").value.trim();if(!e){alert("El nombre del cliente es obligatorio.");return}try{const{error:n}=await s.from("clientes").insert([{name:e,contact:a||null}]);if(n)throw n;alert("Cliente registrado exitosamente!"),v("new-client-modal"),x()}catch(n){console.error("Error al registrar cliente:",n),alert(`Fallo el registro del cliente. Error: ${n.message}`)}}async function z(t){if(!t)return;const{data:e,error:a}=await s.from("productos").select("*").eq("producto_id",t).single();if(a){console.error("Error al cargar producto para edición:",a),alert(`Error al cargar producto: ${a.message}`);return}const n=document.getElementById("new-product-form");document.getElementById("modal-title-product").textContent=`Editar Producto: ${e.name}`,document.getElementById("new-product-name").value=e.name,document.getElementById("new-product-price").value=e.price,document.getElementById("new-product-type").value=e.type,document.getElementById("new-product-description").value=e.description||"",n&&(n.dataset.editingId=t,n.removeEventListener("submit",F),n.addEventListener("submit",M)),_("new-product-modal")}async function M(t){t.preventDefault();const e=t.target,a=e.dataset.editingId,n=document.getElementById("new-product-name").value.trim(),o=parseFloat(document.getElementById("new-product-price").value),r=document.getElementById("new-product-type").value,c=document.getElementById("new-product-description").value.trim();if(!a||!n||isNaN(o)||o<0){alert("Datos incompletos o inválidos para la edición.");return}try{const{error:l}=await s.from("productos").update({name:n,price:o,type:r,description:c||null}).eq("producto_id",a);if(l)throw l;alert(`¡${n} actualizado exitosamente!`),v("new-product-modal"),B(),e.removeEventListener("submit",M),e.addEventListener("submit",F),e.removeAttribute("data-editing-id"),document.getElementById("modal-title-product").textContent="Registrar Nuevo Producto"}catch(l){console.error("Error al editar producto:",l),alert(`Fallo la edición del producto. Error: ${l.message}`)}}async function J(t){if(t&&confirm("¿Estás seguro de que deseas eliminar este producto? Esta acción es irreversible y podría afectar ventas históricas."))try{const{error:e}=await s.from("productos").delete().eq("producto_id",t);if(e)throw e;alert("Producto eliminado exitosamente."),B()}catch(e){console.error("Error al eliminar producto:",e),alert(`Fallo la eliminación del producto. Error: ${e.message}`)}}async function F(t){t.preventDefault();const e=document.getElementById("new-product-name").value.trim(),a=parseFloat(document.getElementById("new-product-price").value),n=document.getElementById("new-product-type").value,o=document.getElementById("new-product-description").value.trim();try{const{error:r}=await s.from("productos").insert([{name:e,price:a,type:n,description:o||null,parent_product:null}]);if(r)throw r;alert(`¡${e} registrado exitosamente!`);const c=document.getElementById("modal-title-product");c&&(c.textContent="Registrar Nuevo Producto"),v("new-product-modal"),B(),I=[]}catch(r){console.error("Error al registrar producto:",r),alert(`Fallo el registro del producto. Error: ${r.message}`)}}async function R(t){var l;if(!t)return;const{data:e,error:a}=await s.from("ventas").select(`
            total_amount, 
            paid_amount,
            client_id,
            ventas_client_id_fkey (name) 
        `).eq("venta_id",t).single();if(a||!e){console.error("Error al cargar datos de venta para pago:",a),alert("No se pudo cargar la información de la deuda.");return}const n=parseFloat(e.total_amount)||0,o=parseFloat(e.paid_amount)||0,r=n-o;if(r<=0){alert("Esta venta ya no tiene deuda pendiente.");return}document.getElementById("payment-venta-id").value=t,document.getElementById("payment-client-id").value=e.client_id,document.getElementById("payment-client-name").textContent=((l=e.ventas_client_id_fkey)==null?void 0:l.name)||"Cliente Desconocido",document.getElementById("payment-current-debt").textContent=y(r);const c=document.getElementById("payment-amount");c.setAttribute("max",r.toFixed(2)),c.value=r.toFixed(2),_("payment-modal")}async function Y(t){t.preventDefault();const e=document.getElementById("payment-venta-id").value,a=document.getElementById("payment-client-id").value,n=parseFloat(document.getElementById("payment-amount").value),o=document.getElementById("payment-method").value,r=document.getElementById("payment-current-debt").textContent;if(!e||!a||n<=0){alert("Datos incompletos o monto inválido.");return}const{data:c,error:l}=await s.from("ventas").select("total_amount, paid_amount").eq("venta_id",e).single();if(l){console.error("Error al obtener venta para actualizar:",l),alert("Error al obtener datos de venta.");return}const m=parseFloat(c.total_amount)||0,p=parseFloat(c.paid_amount)||0,d=m-p;if(n>d){alert(`El monto del abono (${y(n)}) supera la deuda pendiente (${r}).`);return}const i=p+n;try{const{error:u}=await s.from("pagos").insert([{venta_id:e,client_id:a,amount:n,metodo_pago:o}]);if(u)throw u;const{error:w}=await s.from("ventas").update({paid_amount:i}).eq("venta_id",e);if(w)throw w;alert(`¡Abono de ${y(n)} registrado exitosamente!`),v("payment-modal"),x()}catch(u){console.error("Error al registrar abono:",u),alert(`Fallo el registro del abono. Error: ${u.message}`)}}async function V(t){t.preventDefault();const e=t.target,a=e.querySelector("#sale-client-select").value,n=parseFloat(e.querySelector("#sale-payment-amount").value)||0,o=e.querySelector("#sale-payment-method").value;if(!a){alert("Por favor, selecciona un cliente.");return}const r=[];let c=0;const l=e.querySelector("#subproduct-select"),m=e.querySelector("#sale-quantity"),p=e.querySelector("#sale-price"),d=l==null?void 0:l.value,i=parseFloat(m==null?void 0:m.value)||0,u=parseFloat(p==null?void 0:p.value)||0;if(d&&i>0&&u>=0&&(r.push({producto_id:d,quantity:i,price_at_sale:u}),c=i*u),r.length===0){alert("Por favor, selecciona un Paquete/Subcategoría válido, cantidad y precio.");return}if(n>c){alert("El monto pagado no puede ser mayor que el total de la venta.");return}const w=c,f=n;try{const{data:g,error:E}=await s.from("ventas").insert([{client_id:a,total_amount:w,paid_amount:f}]).select("venta_id").single();if(E||!g){console.error("Error al insertar venta:",E),alert(`Error al registrar la venta: ${(E==null?void 0:E.message)||"Desconocido"}`);return}const S=g.venta_id,q=r.map(h=>({venta_id:S,producto_id:h.producto_id,quantity:h.quantity,price_at_sale:h.price_at_sale})),{error:L}=await s.from("ventas_productos").insert(q);if(L){console.error("Error al insertar detalles de venta:",L),alert(`Error al registrar el detalle de la venta: ${L.message}`);return}if(f>0){const{error:h}=await s.from("pagos").insert([{venta_id:S,amount:f,client_id:a,note:`Método: ${o}`}]);h&&(console.error("Error al registrar pago inicial:",h),alert(`Error al registrar el pago inicial: ${h.message}`))}alert("Venta registrada exitosamente. Deuda calculada."),v("new-sale-modal"),await x()}catch(g){console.error("Error general en la venta:",g),alert("Ocurrió un error inesperado al registrar la venta.")}}function P(){const t=document.getElementById("main-product-select"),e=document.getElementById("subproduct-select"),a=document.getElementById("sale-price");if(!t||!e||!a)return;const n=t.options[t.selectedIndex].textContent;e.innerHTML='<option value="" data-price="0" disabled selected>Cargando opciones...</option>',e.disabled=!0,a.value="0.00";let o=[],r=null;if(o=I.filter(c=>c.type==="PACKAGE"&&c.parent_product===n),r=I.find(c=>c.name===n&&c.type==="MAIN"),o.length>0&&(e.innerHTML='<option value="" data-price="0" disabled selected>Seleccione un Paquete</option>',o.forEach(c=>{const l=document.createElement("option");l.value=c.producto_id,l.textContent=`${c.name} (Paquete) - ${y(c.price)}`,l.dataset.price=c.price,e.appendChild(l)})),r){const c=document.createElement("option");c.value=r.producto_id,c.textContent=`[Precio Base] - ${y(r.price)}`,c.dataset.price=r.price,e.appendChild(c),o.length===0&&(e.value=r.producto_id)}e.disabled=!1,b()}function b(){const t=document.getElementById("subproduct-select"),e=document.getElementById("sale-quantity"),a=document.getElementById("sale-price"),n=document.getElementById("sale-total-amount"),o=document.getElementById("sale-debt-display"),r=document.getElementById("sale-payment-amount");let c=0;const l=parseFloat(e==null?void 0:e.value)||0;let m=parseFloat(a==null?void 0:a.value)||0;const p=parseFloat(r==null?void 0:r.value)||0;if(t!=null&&t.value&&l>0){if(m===0||a.value.trim()===""){const i=t.selectedOptions[0];m=parseFloat(i==null?void 0:i.dataset.price)||0,m>=0&&(a.value=m.toFixed(2))}c=l*m}const d=Math.max(0,c-p);n&&(n.textContent=y(c)),o&&(o.textContent=y(d))}document.addEventListener("DOMContentLoaded",()=>{var t,e,a,n,o,r,c,l,m,p;(t=document.getElementById("login-form"))==null||t.addEventListener("submit",A),(e=document.getElementById("logout-button"))==null||e.addEventListener("click",N),(a=document.getElementById("new-sale-form"))==null||a.addEventListener("submit",V),(n=document.getElementById("new-client-form"))==null||n.addEventListener("submit",j),(o=document.getElementById("new-product-form"))==null||o.addEventListener("submit",F),(r=document.getElementById("payment-form"))==null||r.addEventListener("submit",Y),(c=document.getElementById("open-new-sale-modal"))==null||c.addEventListener("click",async()=>{var d,i,u,w;try{await k(),await U();const f=document.getElementById("main-product-select");f.innerHTML='<option value="" disabled selected>Seleccione Producto Principal</option>',I.filter(g=>g.type==="MAIN").forEach(g=>{const E=document.createElement("option");E.textContent=g.name,f.appendChild(E)}),f.addEventListener("change",P),(d=document.getElementById("subproduct-select"))==null||d.addEventListener("change",b),(i=document.getElementById("sale-quantity"))==null||i.addEventListener("input",b),(u=document.getElementById("sale-price"))==null||u.addEventListener("input",b),(w=document.getElementById("sale-payment-amount"))==null||w.addEventListener("input",b),b(),_("new-sale-modal")}catch(f){console.error("Error al cargar datos de selects:",f),alert("Error al cargar los datos de clientes/productos. Revise la consola (F12).")}}),(l=document.getElementById("open-admin-products-modal"))==null||l.addEventListener("click",async d=>{d.preventDefault();try{await B(),_("admin-products-modal")}catch(i){console.error("Error al cargar la lista de productos:",i),alert("Error al cargar los productos. Revise la consola para detalles.")}}),(m=document.getElementById("open-new-client-modal"))==null||m.addEventListener("click",()=>{_("new-client-modal")}),(p=document.getElementById("open-new-product-modal"))==null||p.addEventListener("click",()=>{_("new-product-modal")}),document.querySelectorAll("[data-close-modal]").forEach(d=>{d.addEventListener("click",i=>{i.preventDefault();const u=d.getAttribute("data-close-modal");v(u)})}),document.addEventListener("click",d=>{document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(u=>{d.target===u&&v(u.id)})}),document.addEventListener("keydown",d=>{if(d.key==="Escape"){const i=document.querySelectorAll(".modal-overlay:not(.hidden)"),u=i[i.length-1];u&&v(u.id)}}),C()});
